rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User profiles - authenticated users can read all profiles, only edit their own
    match /users/{userId} {
      allow read: if request.auth != null; // Require auth for profile access
      allow create: if request.auth != null && request.auth.uid == userId &&
                    request.resource.data.keys().hasAll(['email', 'displayName']) &&
                    request.resource.data.email.matches('[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}');
      allow update: if request.auth != null && request.auth.uid == userId &&
                    // Prevent email changes through direct updates (use auth)
                    !request.resource.data.diff(resource.data).affectedKeys().hasAny(['email']);
      allow delete: if false; // Prevent profile deletion
    }

    // User profile extensions - for additional profile data
    match /user_profiles/{userId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // Locations - authenticated read/write with proper validation
    match /locations/{locationId} {
      allow read: if request.auth != null; // Require authentication for location access
      allow create: if request.auth != null &&
                    request.resource.data.createdBy == request.auth.uid &&
                    request.resource.data.keys().hasAll(['name', 'coordinates', 'createdBy']) &&
                    request.resource.data.coordinates is list &&
                    request.resource.data.coordinates.size() == 2;
      allow update: if request.auth != null && resource.data.createdBy == request.auth.uid &&
                    // Only allow status changes and content updates
                    request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['name', 'description', 'category', 'riskLevel', 'coordinates', 'address', 'tags', 'updatedAt', 'status']);
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }
    
    // Ratings - authenticated users can read all ratings
    // Users can only create, update, or delete their own ratings
    match /ratings/{ratingId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Saved Locations - users can only read, create, update, or delete their own saved locations
    match /savedLocations/{savedId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Playlists - users can read public playlists, but only read/write their own private playlists
    match /playlists/{playlistId} {
      allow read: if request.auth != null && (resource.data.visibility == 'public' || resource.data.createdBy == request.auth.uid);
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;
      allow update: if request.auth != null && resource.data.createdBy == request.auth.uid;
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }
    
    // Comments - for profile and post comments
    // Users can read all comments, but only create/edit/delete their own
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;
      allow update: if request.auth != null && resource.data.createdBy == request.auth.uid && resource.data.createdAt != request.time;
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }
    
    // Chat messages - authenticated users can read all chat messages
    // Users can only create, update, or delete their own chat messages
    match /chat/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Forum posts - authenticated users can read all forum posts
    // Users can only create, update, or delete their own forum posts
    match /forum/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;
      allow update: if request.auth != null && resource.data.createdBy == request.auth.uid;
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }
    
    // Territories - authenticated users can read all territories
    // Users can only create, update, or delete territories they own
    match /territories/{territoryId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null && resource.data.ownerId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }
    
    // Crews - authenticated users can read all crews
    // Users can only create, update, or delete crews they own
    match /crews/{crewId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null && resource.data.ownerId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }
    
    // Crew members - authenticated users can read all crew members
    // Users can only create, update, or delete their own crew membership
    match /crewMembers/{membershipId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Geocaches - authenticated users can read all geocaches
    // Users can only create, update, or delete geocaches they own
    match /geocaches/{geocacheId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;
      allow update: if request.auth != null && resource.data.createdBy == request.auth.uid;
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }

    // Followers - authenticated users can read all follower relationships
    // Users can only manage their own following/follower relationships
    match /user_followers/{followId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.followerId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.followerId == request.auth.uid;
    }

    // Location comments - authenticated users can read all comments
    // Users can only create, update, or delete their own comments
    match /location_comments/{commentId} {
      allow read: if true; // Allow public read for location detail pages
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Location likes/favorites - authenticated users can read all likes
    // Users can only manage their own likes
    match /location_likes/{likeId} {
      allow read: if true; // Allow public read for like counts
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Post likes - authenticated users can read all likes
    // Users can only manage their own likes
    match /post_likes/{likeId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // User notifications - users can only read/write their own notifications
    match /user_notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Location visits/check-ins - authenticated users can read all visits
    // Users can only create their own visits
    match /location_visits/{visitId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // User badges/achievements - users can read all badges, authenticated create/manage their own
    match /user_badges/{badgeId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Missions/challenges - authenticated users can read all missions
    // Admin/create permission for creating missions
    match /missions/{missionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // User mission progress - users can only manage their own progress
    match /user_missions/{progressId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Routes/journeys - authenticated users can read all public routes
    // Users can manage their own routes
    match /routes/{routeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;
      allow update: if request.auth != null && resource.data.createdBy == request.auth.uid;
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }

    // Groups/teams - authenticated users can read all groups
    // Group members can manage groups they belong to
    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;
      allow update: if request.auth != null && (resource.data.createdBy == request.auth.uid || resource.data.members.hasAny([request.auth.uid]));
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }

    // Group members - authenticated users can read all memberships
    // Users can manage their own memberships
    match /group_members/{memberId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Direct messages - users can only read/write messages they're part of
    match /direct_messages/{messageId} {
      allow read: if request.auth != null &&
        (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
      allow create: if request.auth != null && request.resource.data.senderId == request.auth.uid;
      allow update: if request.auth != null && resource.data.senderId == request.auth.uid;
      allow delete: if request.auth != null &&
        (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
    }

    // Location images/photos - allow public read, authenticated write
    match /location_images/{imageId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && resource.data.uploadedBy == request.auth.uid;
      allow delete: if request.auth != null && resource.data.uploadedBy == request.auth.uid;
    }
  }
}
