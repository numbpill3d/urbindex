<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urbindex - Urban Exploration Network</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            /* Construction Zone Color Palette */
            --cz-yellow: #FFD000;
            --cz-yellow-dark: #CC9900;
            --cz-black: #1A1A1A;
            --cz-concrete: #6B6B6B;
            --cz-concrete-light: #8B8B8B;
            --cz-concrete-dark: #3D3D3D;
            --cz-blueprint: #1E3A5F;
            --cz-blueprint-grid: #2A4A6F;
            --cz-orange: #FF6B00;
            --cz-red: #CC0000;
            --cz-green: #00AA44;
            --cz-rust: #8B4513;

            /* Typography */
            --font-stencil: 'Courier New', 'Lucida Console', monospace;
            --font-blueprint: 'Consolas', 'Monaco', monospace;
            --font-industrial: 'Impact', 'Arial Black', sans-serif;
            --font-mono: 'Monaco', 'Courier New', monospace;

            /* Construction Zone Theme */
            --bg-primary: var(--cz-concrete-dark);
            --bg-secondary: var(--cz-concrete);
            --bg-tertiary: var(--cz-concrete-light);
            --accent-yellow: var(--cz-yellow);
            --accent-orange: var(--cz-orange);
            --text-primary: #FFFFFF;
            --text-secondary: #D0D0D0;
            --text-muted: #A0A0A0;
            --border: var(--cz-black);
            --success: var(--cz-green);
            --warning: var(--cz-orange);
            --danger: var(--cz-red);

            /* Construction Zone Effects */
            --hazard-stripe: repeating-linear-gradient(
                45deg,
                var(--cz-yellow) 0px,
                var(--cz-yellow) 10px,
                var(--cz-black) 10px,
                var(--cz-black) 20px
            );
            --blueprint-grid:
                linear-gradient(rgba(30, 58, 95, 0.8) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 58, 95, 0.8) 1px, transparent 1px);
            --concrete-texture: linear-gradient(135deg,
                rgba(107, 107, 107, 0.1) 0%,
                rgba(139, 139, 139, 0.05) 50%,
                rgba(61, 61, 61, 0.1) 100%);
            --shadow-industrial: 3px 3px 0 var(--cz-black), 6px 6px 12px rgba(0,0,0,0.5);
            --shadow-plate: inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.3);

            /* Enhanced Color Contrast - Construction Zone */
            --text-high-contrast: #FFFFFF;
            --text-high-contrast-dark: #000000;
            --bg-high-contrast: #000000;
            --focus-high-contrast: #FFD000;
            --error-high-contrast: #FF0000;
            --success-high-contrast: #00FF00;

            /* Loading States - Construction Zone */
            --loading-bg: rgba(0, 0, 0, 0.9);
            --loading-spinner: var(--cz-yellow);
            --loading-text: var(--text-high-contrast);

            /* Error States - Construction Zone */
            --error-bg: rgba(204, 0, 0, 0.1);
            --error-border: var(--cz-red);
            --error-text: var(--cz-red);

            /* Industrial Styling */
            --radius: 2px;
            --shadow: var(--shadow-industrial);
            --transition: 0.15s ease;
        }

        /* Dark Mode Enhancements */
        @media (prefers-color-scheme: dark) {
            :root {
                --hazard-glow: 0 0 20px rgba(255, 208, 0, 0.3);
                --blueprint-glow: 0 0 15px rgba(30, 58, 95, 0.5);
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Skip Links for Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--cz-yellow);
            color: var(--cz-black);
            padding: 8px;
            text-decoration: none;
            font-weight: 700;
            z-index: 10000;
            border: 3px solid var(--cz-black);
            box-shadow: var(--shadow-industrial);
        }

        .skip-link:focus {
            top: 6px;
        }

        body {
            font-family: var(--font-stencil);
            background: var(--bg-primary);
            background-image: var(--concrete-texture);
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(139, 69, 19, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(107, 107, 107, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Industrial Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-industrial);
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 2px 2px 0 var(--cz-black);
        }

        h1 { font-size: 24px; margin-bottom: 16px; }
        h2 { font-size: 20px; margin-bottom: 14px; color: var(--cz-yellow); }
        h3 { font-size: 16px; margin-bottom: 12px; }
        h4 { font-size: 14px; margin-bottom: 10px; }

        .cz-stencil {
            font-family: var(--font-stencil);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-size: 14px;
        }

        .cz-label {
            font-family: var(--font-blueprint);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 11px;
            font-weight: 600;
            color: var(--cz-yellow);
        }

        .cz-text {
            font-family: var(--font-blueprint);
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .cz-mono {
            font-family: var(--font-mono);
            font-size: 11px;
            letter-spacing: 1px;
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: var(--cz-black);
            border-bottom: 4px solid var(--cz-yellow);
            padding: 0 20px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--hazard-stripe);
        }

        .logo {
            font-family: var(--font-industrial);
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--cz-yellow);
            text-shadow: 2px 2px 0 var(--cz-black), 0 0 20px rgba(255, 208, 0, 0.3);
            position: relative;
        }

        .logo::after {
            content: 'ZONE';
            position: absolute;
            bottom: -8px;
            right: -20px;
            font-size: 8px;
            letter-spacing: 2px;
            color: var(--cz-orange);
            background: var(--cz-black);
            padding: 1px 4px;
            border: 1px solid var(--cz-orange);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-blueprint);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--cz-yellow);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--cz-green);
            box-shadow: 0 0 8px var(--cz-green);
            animation: pulse-status 2s infinite;
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .status-dot.offline {
            background: var(--cz-red);
            box-shadow: 0 0 8px var(--cz-red);
        }

        .nav {
            background: var(--cz-concrete-dark);
            border-bottom: 3px solid var(--cz-black);
            padding: 8px 20px;
            display: flex;
            gap: 6px;
            position: sticky;
            top: 56px;
            z-index: 90;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 4px 8px rgba(0,0,0,0.4);
        }

        .nav-btn {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            color: var(--text-secondary);
            padding: 8px 14px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-stencil);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 2px 2px 0 var(--cz-black);
            position: relative;
        }

        .nav-btn:hover {
            background: var(--cz-concrete-light);
            color: var(--cz-yellow);
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--cz-black);
        }

        .nav-btn.active {
            background: var(--cz-yellow);
            color: var(--cz-black);
            border-color: var(--cz-yellow-dark);
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.3);
            transform: translate(1px, 1px);
        }

        .nav-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .main {
            flex: 1;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .view { display: none; }
        .view.active { display: block; }

        .map-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 16px;
            height: calc(100vh - 120px);
            min-height: 500px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .panel {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            padding: 16px;
            box-shadow: var(--shadow-industrial);
            position: relative;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--hazard-stripe);
        }

        .panel::after {
            content: '';
            position: absolute;
            top: 6px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--blueprint-grid);
            background-size: 20px 20px;
            opacity: 0.05;
            pointer-events: none;
        }

        .panel-title {
            font-family: var(--font-stencil);
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--cz-yellow);
            text-transform: uppercase;
            letter-spacing: 3px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 2px dashed var(--cz-yellow-dark);
        }

        .map-container {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-industrial);
        }

        .map-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--hazard-stripe);
            z-index: 1000;
        }

        #map { height: 100%; min-height: 400px; }

        /* Command Center Hero */
        .dashboard-hero {
            margin-bottom: 16px;
            padding: 18px;
            background:
                linear-gradient(135deg, rgba(255, 208, 0, 0.08), transparent 55%),
                radial-gradient(circle at 20% 20%, rgba(255, 107, 0, 0.12), transparent 40%),
                var(--cz-concrete);
            border: 3px solid var(--cz-black);
            box-shadow: var(--shadow-industrial);
            position: relative;
            overflow: hidden;
        }

        .dashboard-hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(0,0,0,0.25), transparent 35%);
            pointer-events: none;
        }

        .dashboard-hero::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 110px;
            height: 6px;
            background: var(--hazard-stripe);
            transform: skew(-12deg);
            opacity: 0.6;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            align-items: stretch;
            position: relative;
            z-index: 1;
        }

        .hero-lede h2 {
            font-size: 1.4rem;
            margin-bottom: 6px;
        }

        .hero-lede p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            max-width: 560px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border: 2px solid var(--cz-black);
            background: var(--cz-black);
            color: var(--cz-yellow);
            font-family: var(--font-blueprint);
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .chip.live { background: var(--cz-yellow); color: var(--cz-black); }
        .chip.safe { background: var(--cz-green); color: var(--cz-black); }
        .chip.signal { background: var(--cz-blueprint); border-color: var(--cz-yellow); color: white; }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .quick-actions .btn {
            padding: 8px 12px;
            font-size: 10px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            align-items: stretch;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 2px solid var(--cz-black);
            padding: 12px;
            position: relative;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(255, 208, 0, 0.2), rgba(255, 107, 0, 0.08));
            border-color: var(--cz-yellow-dark);
        }

        .stat-label {
            font-family: var(--font-blueprint);
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--cz-yellow);
            text-shadow: 2px 2px 0 var(--cz-black);
            margin-bottom: 4px;
        }

        .stat-trend {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .btn {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            color: var(--text-secondary);
            padding: 8px 14px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-stencil);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 2px 2px 0 var(--cz-black);
            position: relative;
        }

        .btn:hover {
            background: var(--cz-concrete-light);
            color: var(--cz-yellow);
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--cz-black);
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        .btn-primary {
            background: var(--cz-yellow);
            color: var(--cz-black);
            border-color: var(--cz-yellow-dark);
        }

        .btn-primary:hover {
            background: var(--cz-yellow-dark);
            border-color: var(--cz-yellow);
            color: var(--cz-black);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--cz-yellow);
            border: 4px solid var(--cz-black);
            border-radius: 0;
            color: var(--cz-black);
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: var(--shadow-industrial);
            transition: var(--transition);
            z-index: 1000;
            transform: rotate(-3deg);
        }

        .fab::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: var(--hazard-stripe);
            z-index: -1;
            transform: rotate(3deg);
        }

        .fab:hover {
            transform: rotate(0deg) scale(1.1);
            box-shadow: 4px 4px 0 var(--cz-black), 8px 8px 20px rgba(0,0,0,0.4);
        }

        .fab:active {
            transform: rotate(-3deg) scale(0.95);
            box-shadow: 1px 1px 0 var(--cz-black);
        }

        /* Auth Modal Styles - Construction Zone */
        .auth-tabs {
            display: flex;
            border-bottom: 3px solid var(--cz-black);
            margin-bottom: 16px;
            background: var(--cz-concrete-dark);
            padding: 0;
        }

        .auth-tab {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            border-bottom: none;
            padding: 10px 16px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            font-family: var(--font-stencil);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 2px -2px 0 var(--cz-black);
            flex: 1;
            text-align: center;
        }

        .auth-tab.active {
            background: var(--cz-yellow);
            color: var(--cz-black);
            border-color: var(--cz-yellow-dark);
            box-shadow: none;
            position: relative;
            top: 3px;
        }

        .auth-tab:hover {
            background: var(--cz-concrete-light);
            color: var(--cz-yellow);
        }

        .auth-form { display: none; }
        .auth-form.active { display: block; }

        .auth-form h3 {
            margin-bottom: 20px;
            color: var(--cz-yellow);
            text-align: center;
            font-family: var(--font-industrial);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 2px 2px 0 var(--cz-black);
        }

        .auth-alternatives {
            text-align: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 3px solid var(--cz-black);
            background: var(--hazard-stripe);
            margin-left: -20px;
            margin-right: -20px;
            padding: 12px 20px;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--cz-yellow);
            cursor: pointer;
            text-decoration: underline;
            font-family: var(--font-blueprint);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-link:hover {
            color: var(--cz-orange);
            text-decoration: none;
        }

        /* OAuth Button Styles */
        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 16px 0;
        }

        .oauth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            border: 2px solid var(--cz-black);
            color: var(--cz-black);
            padding: 12px 16px;
            cursor: pointer;
            transition: var(--transition);
            font-family: var(--font-stencil);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 2px 2px 0 var(--cz-black);
            position: relative;
        }

        .oauth-btn:hover {
            background: #f5f5f5;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--cz-black);
        }

        .oauth-btn:active {
            transform: translate(1px, 1px);
            box-shadow: none;
        }

        .oauth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f0f0f0 !important;
            color: #666 !important;
            box-shadow: none !important;
            transform: none !important;
        }

        .oauth-btn.google {
            background: #4285f4;
            color: white;
        }

        .oauth-btn.google:hover {
            background: #357ae8;
        }

        .oauth-btn.github {
            background: #333;
            color: white;
        }

        .oauth-btn.github:hover {
            background: #24292e;
        }

        .oauth-divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: var(--text-muted);
            font-family: var(--font-blueprint);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .oauth-divider::before,
        .oauth-divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: var(--cz-black);
            margin: 0 12px;
        }

        /* Enhanced Form Validation Styles */
        .input.error {
            border-color: var(--cz-red);
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.3), inset 1px 1px 0 #FFFFFF, inset -1px -1px 0 #808080;
        }

        .input.success {
            border-color: var(--cz-green);
            box-shadow: 0 0 0 2px rgba(0, 170, 68, 0.3), inset 1px 1px 0 #FFFFFF, inset -1px -1px 0 #808080;
        }

        .field-error {
            color: var(--cz-red);
            font-size: 10px;
            font-family: var(--font-blueprint), 'Arial', sans-serif;
            margin-top: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-success {
            color: var(--cz-green);
            font-size: 10px;
            font-family: var(--font-blueprint), 'Arial', sans-serif;
            margin-top: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Password Strength Indicator */
        .password-strength {
            margin-top: 8px;
            font-size: 9px;
            font-family: var(--font-blueprint);
        }

        .strength-bar {
            height: 4px;
            background: var(--cz-concrete-light);
            border: 1px solid var(--cz-black);
            margin: 4px 0;
            position: relative;
            overflow: hidden;
        }

        .strength-fill {
            height: 100%;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .strength-weak {
            background: var(--cz-red);
            width: 25%;
        }

        .strength-fair {
            background: var(--cz-orange);
            width: 50%;
        }

        .strength-good {
            background: var(--cz-yellow);
            width: 75%;
        }

        .strength-strong {
            background: var(--cz-green);
            width: 100%;
        }

        /* Auth Status Indicators */
        .auth-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--cz-concrete-dark);
            border: 2px solid var(--cz-black);
            font-family: var(--font-blueprint);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .auth-status.logged-in {
            background: var(--cz-green);
            color: white;
        }

        .auth-status.guest {
            background: var(--cz-concrete);
            color: var(--text-secondary);
        }

        .auth-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--cz-yellow);
            border: 2px solid var(--cz-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            color: var(--cz-black);
        }

        /* Session Warning */
        .session-warning {
            background: var(--cz-orange);
            color: white;
            padding: 8px 12px;
            font-family: var(--font-stencil);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            border: 2px solid var(--cz-black);
            box-shadow: 2px 2px 0 var(--cz-black);
            margin-top: 8px;
        }

        .session-warning.warning {
            background: var(--cz-red);
            animation: pulse 1s infinite;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26,26,26,0.95);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--cz-concrete);
            border: 4px solid var(--cz-black);
            padding: 24px;
            max-width: 480px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-industrial);
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--hazard-stripe);
        }

        .modal-content::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--blueprint-grid);
            background-size: 15px 15px;
            opacity: 0.03;
            pointer-events: none;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--cz-red);
            border: 3px solid var(--cz-black);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 0;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 0 var(--cz-black);
            font-family: var(--font-stencil);
            font-weight: 700;
            z-index: 10;
        }

        .modal-close:hover {
            background: #FF0000;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--cz-black);
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: var(--cz-yellow);
            font-size: 11px;
            font-family: var(--font-stencil);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Required field indicator */
        .form-label.required::after {
            content: ' *';
            color: var(--danger);
            font-weight: 700;
        }

        /* Form field error styles */
        .form-error {
            color: var(--danger);
            font-size: 10px;
            font-family: var(--font-blueprint), 'Arial', sans-serif;
            margin-top: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: none;
        }

        /* Invalid field styling */
        .input:invalid, .textarea:invalid, .select:invalid {
            border-color: var(--danger);
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.3), inset 1px 1px 0 #FFFFFF, inset -1px -1px 0 #808080;
        }

        /* Field help text */
        .field-help {
            font-size: 9px;
            color: var(--text-muted);
            font-family: var(--font-blueprint);
            margin-top: 2px;
            font-style: italic;
            letter-spacing: 0.5px;
        }

        /* Enhanced touch targets */
        .btn, .nav-btn, .auth-tab {
            min-height: 44px;
            min-width: 44px;
        }

        .fab {
            width: 56px;
            height: 56px;
        }

        .predefined-tag {
            min-height: 32px;
            min-width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            background: var(--cz-concrete);
            border: 2px solid var(--cz-black);
            color: var(--cz-yellow);
            font-family: var(--font-stencil);
            letter-spacing: 1px;
        }

        /* Status indicators with icons */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-indicator .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-indicator.connected .status-dot {
            background: var(--cz-green);
        }

        .status-indicator.offline .status-dot {
            background: var(--cz-red);
        }

        .status-indicator::before {
            content: attr(data-status-text);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --text-muted: #FFFFFF;
                --border: #FFFFFF;
            }

            .btn, .nav-btn, .auth-tab, .fab {
                border: 4px solid currentColor;
            }

            .input, .textarea, .select {
                border: 4px solid var(--cz-black);
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .input, .textarea, .select {
            background: #F5F5F5;
            border: 3px solid var(--cz-black);
            color: var(--cz-black);
            padding: 10px 12px;
            width: 100%;
            transition: var(--transition);
            font-family: var(--font-blueprint);
            font-size: 12px;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }

        .textarea {
            resize: vertical;
            min-height: 80px;
        }

        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: var(--cz-yellow);
            box-shadow: 0 0 0 3px rgba(255, 208, 0, 0.3), inset 2px 2px 4px rgba(0,0,0,0.2);
            background: white;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 12px;
            border-top: 3px solid var(--cz-black);
            background: var(--hazard-stripe);
            margin-left: -24px;
            margin-right: -24px;
            margin-bottom: -24px;
            padding: 16px 24px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: var(--cz-yellow);
            gap: 12px;
            font-family: var(--font-stencil);
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 3px solid var(--cz-black);
            border-top: 3px solid var(--cz-yellow);
            border-radius: 0;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 2px dashed var(--cz-black);
            font-family: var(--font-blueprint);
            font-size: 11px;
        }

        .activity-item:last-child { border-bottom: none; }

        .activity-icon {
            width: 32px;
            height: 32px;
            background: var(--cz-yellow);
            border: 3px solid var(--cz-black);
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--cz-black);
            font-size: 12px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .activity-content { flex: 1; }
        .activity-user { font-weight: 700; color: var(--cz-yellow); text-transform: uppercase; letter-spacing: 2px; font-family: var(--font-stencil); }
        .activity-time { font-size: 10px; color: var(--text-muted); letter-spacing: 1px; }

        .coordinates-display {
            background: var(--cz-blueprint);
            border: 3px solid var(--cz-black);
            padding: 12px;
            font-family: var(--font-mono);
            color: var(--cz-yellow);
            text-align: center;
            font-size: 11px;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.4);
            letter-spacing: 2px;
            position: relative;
        }

        .coordinates-display::before {
            content: 'COORDINATES';
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--cz-black);
            padding: 2px 8px;
            font-size: 9px;
            letter-spacing: 3px;
            color: var(--cz-yellow);
        }

        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .location-card {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            padding: 16px;
            transition: var(--transition);
            box-shadow: var(--shadow-industrial);
            position: relative;
        }

        .location-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--hazard-stripe);
        }

        .location-card:hover {
            border-color: var(--cz-yellow);
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 var(--cz-black), 10px 10px 20px rgba(0,0,0,0.3);
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .location-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px dashed var(--cz-black);
        }

        .risk {
            padding: 4px 8px;
            border-radius: 0;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 2px solid var(--cz-black);
            font-family: var(--font-stencil);
        }

        .risk-low { background: var(--cz-green); color: white; }
        .risk-moderate { background: var(--cz-orange); color: white; }
        .risk-high { background: var(--cz-red); color: white; }

        .error {
            background: rgba(204, 0, 0, 0.1);
            border: 3px solid var(--cz-red);
            padding: 16px;
            color: var(--cz-red);
            text-align: center;
            margin: 16px 0;
            font-family: var(--font-stencil);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
        }

        .error::before {
            content: 'ERROR';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-border);
            color: white;
            padding: 2px 12px;
            font-size: 10px;
        }

        /* Loading States - Construction Zone */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--loading-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--hazard-stripe);
        }

        .loading-overlay::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--hazard-stripe);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--cz-concrete);
            border-top: 4px solid var(--loading-spinner);
            border-right: 4px solid var(--cz-orange);
            border-radius: 0;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 30px rgba(255, 208, 0, 0.3);
        }

        .loading-text {
            margin-top: 20px;
            font-family: var(--font-stencil);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--loading-text);
            animation: fadeInOut 1.5s ease-in-out infinite;
        }

        .loading-message {
            margin-top: 10px;
            font-family: var(--font-blueprint);
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            max-width: 300px;
        }

        /* Inline Loading States - Construction Zone */
        .inline-loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--cz-yellow);
            font-family: var(--font-stencil);
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .inline-loading::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid var(--cz-black);
            border-top: 2px solid var(--cz-yellow);
            border-radius: 0;
            animation: spin 0.8s linear infinite;
        }

        /* Button Loading States - Construction Zone */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--cz-black);
            border-top: 2px solid var(--cz-yellow);
            border-radius: 0;
            animation: spin 0.8s linear infinite;
        }

        /* Error States - Construction Zone */
        .error-message {
            background: var(--error-bg);
            border: 2px solid var(--error-border);
            padding: 12px;
            color: var(--error-text);
            margin: 8px 0;
            font-family: var(--font-blueprint);
            font-size: 11px;
            border-radius: 0;
            text-align: center;
        }

        .error-icon {
            color: var(--error-border);
            margin-right: 8px;
        }

        /* Success States - Construction Zone */
        .success-message {
            background: rgba(0, 170, 68, 0.1);
            border: 2px solid var(--cz-green);
            padding: 12px;
            color: var(--cz-green);
            margin: 8px 0;
            font-family: var(--font-blueprint);
            font-size: 11px;
            border-radius: 0;
            text-align: center;
        }

        .success-icon {
            color: var(--cz-green);
            margin-right: 8px;
        }

        /* Info States - Construction Zone */
        .info-message {
            background: rgba(30, 58, 95, 0.1);
            border: 2px solid var(--cz-blueprint);
            padding: 12px;
            color: var(--cz-blueprint);
            margin: 8px 0;
            font-family: var(--font-blueprint);
            font-size: 11px;
            border-radius: 0;
            text-align: center;
        }

        .info-icon {
            color: var(--cz-blueprint);
            margin-right: 8px;
        }

        /* Warning States - Construction Zone */
        .warning-message {
            background: rgba(255, 107, 0, 0.1);
            border: 2px solid var(--cz-orange);
            padding: 12px;
            color: var(--cz-orange);
            margin: 8px 0;
            font-family: var(--font-blueprint);
            font-size: 11px;
            border-radius: 0;
            text-align: center;
        }

        .warning-icon {
            color: var(--cz-orange);
            margin-right: 8px;
        }

        .no-data {
            text-align: center;
            color: var(--text-muted);
            padding: 32px;
            font-family: var(--font-blueprint);
            font-size: 12px;
            font-style: italic;
            letter-spacing: 1px;
            border: 2px dashed var(--cz-concrete-light);
        }

        /* Fix button states - Construction Zone */
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--cz-concrete) !important;
            color: var(--text-muted) !important;
            box-shadow: none !important;
            transform: none !important;
        }

        .btn:disabled:hover {
            background: var(--cz-concrete) !important;
            color: var(--text-muted) !important;
            box-shadow: none !important;
            transform: none !important;
        }

        .btn-primary:disabled:hover {
            background: var(--cz-concrete) !important;
            color: var(--text-muted) !important;
            box-shadow: none !important;
        }

        .btn:focus, .nav-btn:focus, .auth-tab:focus, .fab:focus {
            outline: 3px solid var(--cz-yellow);
            outline-offset: 2px;
        }

        /* Enhanced Keyboard Navigation - Construction Zone */
        .nav-btn:focus-visible,
        .auth-tab:focus-visible,
        .oauth-btn:focus-visible,
        .predefined-tag:focus-visible,
        .rating-btn:focus-visible,
        .social-btn:focus-visible,
        .btn-link:focus-visible {
            outline: 3px solid var(--cz-yellow);
            outline-offset: 3px;
            box-shadow: 0 0 8px 2px rgba(255, 208, 0, 0.5);
        }

        /* Focus styles for interactive elements */
        .location-card:focus-visible,
        .comment:focus-visible,
        .notification-item:focus-visible,
        .mission-card:focus-visible,
        .group-card:focus-visible,
        .route-card:focus-visible {
            outline: 4px solid var(--cz-yellow);
            outline-offset: 2px;
            box-shadow: 0 0 12px 3px rgba(255, 208, 0, 0.4);
        }

        /* Keyboard navigation for modal elements */
        .modal-content:focus-within {
            box-shadow: 0 0 0 4px var(--cz-yellow), var(--shadow-industrial);
        }

        /* Skip link for keyboard users */
        .skip-link:focus {
            top: 6px;
            outline: 3px solid var(--cz-yellow);
            outline-offset: 2px;
        }

        /* Enhanced focus states for form elements */
        .tags-input-container:focus-within {
            outline: 3px solid var(--cz-yellow);
            outline-offset: 2px;
        }

        /* Focus styles for map controls */
        .recenter-btn:focus-visible {
            outline: 3px solid var(--cz-yellow);
            outline-offset: 2px;
            box-shadow: 0 0 8px 2px rgba(255, 208, 0, 0.5);
        }

        /* Screen Reader Only Content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .input:focus, .textarea:focus, .select:focus {
            outline: 3px solid var(--cz-yellow);
            outline-offset: 2px;
        }

        /* ========================================
           PROFILE INSPECTION REPORT STYLES
           ======================================== */

        .inspection-report {
            background: #F5F5DC;
            border: 4px solid var(--cz-black);
            padding: 0;
            box-shadow: var(--shadow-industrial), 8px 8px 0 rgba(0,0,0,0.2);
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        .inspection-report::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--blueprint-grid);
            background-size: 25px 25px;
            opacity: 0.08;
            pointer-events: none;
        }

        .clipboard-header {
            background: var(--cz-rust);
            padding: 12px 20px;
            border-bottom: 4px solid var(--cz-black);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .clipboard-title {
            color: var(--cz-yellow);
            font-family: var(--font-industrial);
            font-size: 18px;
            letter-spacing: 4px;
            text-shadow: 2px 2px 0 var(--cz-black);
        }

        .clipboard-id {
            font-family: var(--font-mono);
            font-size: 10px;
            color: #F5F5DC;
            letter-spacing: 2px;
            background: var(--cz-black);
            padding: 4px 10px;
        }

        .report-body {
            padding: 24px;
            position: relative;
            z-index: 1;
        }

        /* Site Badge / ID Card */
        .site-badge {
            background: white;
            border: 3px solid var(--cz-black);
            padding: 16px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 3px 3px 0 var(--cz-black);
        }

        .site-badge::before {
            content: 'SITE PERSONNEL';
            position: absolute;
            top: -12px;
            left: 16px;
            background: var(--cz-yellow);
            color: var(--cz-black);
            padding: 2px 12px;
            font-family: var(--font-stencil);
            font-size: 10px;
            letter-spacing: 2px;
            font-weight: 700;
            border: 2px solid var(--cz-black);
        }

        .site-badge::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: var(--cz-green);
            border: 2px solid var(--cz-black);
            border-radius: 50%;
        }

        .badge-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .badge-photo {
            width: 100px;
            height: 120px;
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }

        .badge-photo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%);
        }

        .badge-photo i {
            font-size: 3rem;
            color: var(--cz-yellow);
        }

        .badge-info {
            flex: 1;
        }

        .badge-name {
            font-family: var(--font-industrial);
            font-size: 20px;
            color: var(--cz-black);
            letter-spacing: 3px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .badge-role {
            font-family: var(--font-stencil);
            font-size: 12px;
            color: var(--cz-rust);
            letter-spacing: 2px;
            margin-bottom: 12px;
            padding: 4px 0;
            border-bottom: 2px dashed var(--cz-concrete);
        }

        .badge-barcode {
            background: white;
            padding: 8px;
            border: 2px solid var(--cz-black);
            font-family: var(--font-mono);
            font-size: 10px;
            letter-spacing: 4px;
            text-align: center;
            margin-top: 12px;
        }

        .badge-barcode::before {
            content: '|||||| || ||| || ||||| ||| ||';
            display: block;
            font-size: 20px;
            line-height: 1;
            margin-bottom: 4px;
            letter-spacing: -2px;
        }

        .badge-timestamp {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--cz-concrete);
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .clearance-level {
            display: inline-block;
            padding: 6px 14px;
            font-family: var(--font-stencil);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            border: 3px solid var(--cz-black);
            box-shadow: 2px 2px 0 var(--cz-black);
            text-transform: uppercase;
        }

        .verification-stamp {
            display: inline-block;
            padding: 4px 10px;
            font-family: var(--font-stencil);
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 2px;
            transform: rotate(-3deg);
            border: 3px solid;
        }

        .stamp-verified {
            background: rgba(0, 170, 68, 0.2);
            color: var(--cz-green);
            border-color: var(--cz-green);
        }

        .stamp-unverified {
            background: rgba(255, 107, 0, 0.2);
            color: var(--cz-orange);
            border-color: var(--cz-orange);
        }

        /* Inspection Sections */
        .inspection-section {
            background: white;
            border: 3px solid var(--cz-black);
            margin-bottom: 20px;
            position: relative;
        }

        .inspection-section::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: var(--cz-yellow);
            border: 3px solid var(--cz-black);
            border-radius: 50%;
        }

        .section-header {
            background: var(--cz-black);
            color: var(--cz-yellow);
            padding: 10px 16px;
            font-family: var(--font-stencil);
            font-size: 12px;
            letter-spacing: 3px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 16px;
        }

        /* Stats as Metal Plates */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .stat-plate {
            background: linear-gradient(135deg, var(--cz-concrete-light) 0%, var(--cz-concrete) 50%, var(--cz-concrete-dark) 100%);
            border: 3px solid var(--cz-black);
            padding: 16px 12px;
            text-align: center;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.2), inset 0 -2px 4px rgba(0,0,0,0.3), 2px 2px 0 var(--cz-black);
        }

        .stat-plate::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 8px;
            height: 8px;
            background: var(--cz-black);
            border-radius: 50%;
        }

        .stat-plate::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--cz-black);
            border-radius: 50%;
        }

        .stat-value {
            font-family: var(--font-industrial);
            font-size: 32px;
            color: var(--cz-yellow);
            text-shadow: 2px 2px 0 var(--cz-black);
        }

        /* Profile Page Styles */
        .profile-shell {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .profile-hero {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 20px;
            align-items: center;
            padding: 24px;
            background: linear-gradient(135deg, var(--cz-concrete-dark) 0%, var(--cz-concrete) 50%, var(--cz-concrete-light) 100%);
            border: 4px solid var(--cz-black);
            box-shadow: var(--shadow-industrial);
            position: relative;
        }

        .profile-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--hazard-stripe);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border: 4px solid var(--cz-black);
            background: var(--cz-concrete);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: 900;
            color: var(--cz-yellow);
            box-shadow: 4px 4px 0 var(--cz-black);
            position: relative;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-meta {
            flex: 1;
        }

        .profile-meta h2 {
            font-size: 2rem;
            margin-bottom: 8px;
            color: var(--cz-yellow);
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .profile-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
        }

        .profile-card {
            padding: 16px;
        }

        .profile-stats {
            padding: 16px;
        }

        .highlight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .profile-highlight {
            background: var(--cz-concrete-dark);
            border: 2px solid var(--cz-black);
            padding: 12px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .timeline {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 2px dashed var(--cz-black);
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--cz-yellow);
            border: 2px solid var(--cz-black);
            margin-top: 4px;
            flex-shrink: 0;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .achievement-tag {
            background: var(--cz-concrete);
            border: 2px solid var(--cz-black);
            padding: 12px;
            text-align: center;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .tag-icon {
            font-size: 1.5rem;
            color: var(--cz-yellow);
            margin-bottom: 8px;
        }

        .tag-name {
            font-family: var(--font-stencil);
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .tag-desc {
            font-family: var(--font-blueprint);
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Photo upload progress */
        #photo-progress {
            display: none;
            margin-top: 12px;
            background: var(--cz-concrete);
            border: 2px solid var(--cz-black);
            padding: 12px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        #photo-progress-bar {
            height: 8px;
            background: var(--cz-yellow);
            width: 0%;
            transition: width 0.3s ease;
        }

        #photo-progress-text {
            font-family: var(--font-blueprint);
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 6px;
            text-align: center;
        }
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-family: var(--font-stencil);
            font-size: 10px;
            color: white;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Progress Bars as Measurement Gauges */
        .gauge-container {
            margin-bottom: 12px;
        }

        .gauge-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-family: var(--font-blueprint);
            font-size: 11px;
            color: var(--cz-black);
            letter-spacing: 1px;
        }

        .gauge-bar {
            height: 20px;
            background: var(--cz-concrete-light);
            border: 2px solid var(--cz-black);
            position: relative;
            overflow: hidden;
        }

        .gauge-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 18px,
                var(--cz-black) 18px,
                var(--cz-black) 20px
            );
            opacity: 0.3;
        }

        .gauge-fill {
            height: 100%;
            background: var(--hazard-stripe);
            transition: width 0.5s ease;
            position: relative;
        }

        .gauge-fill::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--cz-black);
        }

        /* Achievement Tags */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
        }

        .achievement-tag {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            padding: 12px 8px;
            text-align: center;
            position: relative;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .achievement-tag.locked {
            opacity: 0.4;
            background: var(--cz-concrete-dark);
        }

        .achievement-tag::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: var(--cz-yellow);
            border: 2px solid var(--cz-black);
            border-radius: 50%;
        }

        .achievement-tag.locked::before {
            background: var(--cz-concrete);
        }

        .tag-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 8px;
            background: var(--cz-black);
            border: 2px solid var(--cz-yellow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .achievement-tag.locked .tag-icon {
            border-color: var(--cz-concrete-light);
        }

        .tag-name {
            font-family: var(--font-stencil);
            font-size: 9px;
            color: var(--cz-yellow);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .tag-desc {
            font-family: var(--font-blueprint);
            font-size: 8px;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        /* Report Actions */
        .report-actions {
            background: var(--hazard-stripe);
            padding: 16px 20px;
            border-top: 4px solid var(--cz-black);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .report-actions .btn {
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(255, 107, 0, 0.1);
            border: 3px solid var(--cz-orange);
            padding: 12px;
            margin-bottom: 16px;
            position: relative;
        }

        .warning-box::before {
            content: 'ATTENTION';
            position: absolute;
            top: -12px;
            left: 12px;
            background: var(--cz-orange);
            color: white;
            padding: 2px 10px;
            font-family: var(--font-stencil);
            font-size: 10px;
            letter-spacing: 2px;
        }

        .warning-box p {
            font-family: var(--font-blueprint);
            font-size: 11px;
            color: var(--cz-orange);
            letter-spacing: 0.5px;
            margin: 0;
        }

        /* Fix for mobile layout - Construction Zone */
        @media (max-width: 768px) {
            .main { padding: 8px; }

            .map-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                gap: 8px;
                height: calc(100vh - 90px);
            }

            .sidebar {
                order: 2;
                max-height: 250px;
                overflow-y: auto;
                flex-direction: column;
                gap: 8px;
            }

            .panel {
                min-width: 100%;
                flex-shrink: 0;
                padding: 8px;
            }

            .nav-btn span { display: none; }

            .locations-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 98%;
                margin: 8px;
                max-height: 95vh;
                padding: 12px;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 1.3rem;
            }

            .btn, .nav-btn, .auth-tab {
                min-height: 48px;
                min-width: 48px;
                padding: 10px 16px;
                font-size: 12px;
            }

            .modal-close {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .input, .textarea, .select {
                font-size: 16px;
                padding: 12px 14px;
                min-height: 48px;
            }

            .tags-input-container {
                min-height: 48px;
                padding: 10px;
            }

            .predefined-tag {
                min-height: 40px;
                min-width: 40px;
                padding: 6px 12px;
                font-size: 11px;
                margin: 2px;
            }

            .form-actions {
                flex-direction: column;
                gap: 12px;
            }

            .form-actions .btn {
                width: 100%;
                justify-content: center;
            }

            /* Mobile search and filter layout - Construction Zone */
            .panel:has(#location-search) {
                padding: 8px;
            }

            .panel:has(#location-search) .form-group {
                margin-bottom: 10px;
            }

            .panel:has(#location-search) > div {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .panel:has(#location-search) .form-label {
                font-size: 10px;
            }

            .panel:has(#location-search) .input,
            .panel:has(#location-search) .select {
                font-size: 11px;
                padding: 6px 8px;
            }

            /* Mobile Inspection Report Styles */
            .inspection-report {
                margin: 0;
                box-shadow: var(--shadow-industrial);
            }

            .clipboard-header {
                padding: 10px 12px;
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .clipboard-title {
                font-size: 14px;
                letter-spacing: 2px;
            }

            .report-body {
                padding: 16px;
            }

            .badge-content {
                flex-direction: column;
                text-align: center;
            }

            .badge-photo {
                margin: 0 auto;
                width: 80px;
                height: 100px;
            }

            .badge-name {
                font-size: 16px;
            }

            .social-grid {
                grid-template-columns: 1fr;
            }

            .social-hero {
                flex-direction: column;
                align-items: flex-start;
            }

            .social-hero-actions {
                width: 100%;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-value {
                font-size: 24px;
            }

            .achievement-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .report-actions {
                flex-direction: column;
                padding: 12px;
            }

            .report-actions .btn {
                width: 100%;
            }
        }

        /* Enhanced tablet layout - Construction Zone */
        @media (min-width: 769px) and (max-width: 1024px) {
            .map-layout {
                grid-template-columns: 280px 1fr;
                gap: 12px;
            }

            .sidebar {
                max-height: calc(100vh - 120px);
                overflow-y: auto;
            }

            .locations-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                width: 90%;
                max-width: 600px;
            }

            .nav-btn span { display: inline; }

            .social-grid {
                grid-template-columns: 1fr 1fr;
            }

            .achievement-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Desktop layout enhancements - Construction Zone */
        @media (min-width: 1025px) {
            .map-layout {
                grid-template-columns: 320px 1fr;
                gap: 16px;
            }

            .locations-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .modal-content {
                max-width: 500px;
            }

            .social-grid {
                grid-template-columns: 2fr 1fr;
            }

            .achievement-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Additional mobile improvements - Construction Zone */
        @media (max-width: 480px) {
            .header {
                padding: 0 8px;
                height: 52px;
            }

            .logo {
                font-size: 18px;
                letter-spacing: 2px;
            }

            .logo::after {
                display: none;
            }

            .status {
                font-size: 10px;
            }

            .nav {
                padding: 4px 8px;
                gap: 2px;
                top: 52px;
            }

            .main {
                padding: 8px;
            }

            .btn {
                padding: 4px 8px;
                font-size: 10px;
            }

            .panel {
                padding: 8px;
            }

            .location-card {
                padding: 8px;
            }

            .location-actions {
                flex-direction: column;
                gap: 4px;
            }

            .location-actions .btn {
                width: 100%;
                justify-content: center;
                padding: 3px 6px;
                font-size: 10px;
            }

            /* Profile page mobile optimizations */
            #profile-view .panel:first-child > div:first-child {
                flex-direction: column;
                text-align: center;
            }

            #profile-view .panel:first-child > div:first-child > div:last-child {
                width: 100%;
            }

            /* Stats grid - 2 columns on small screens */
            #profile-view > div:nth-child(2) {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Achievement badges - 2 columns on mobile */
            #profile-view .panel:last-child > div:last-child {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* Construction Zone Dark Mode Enhancements */
        @media (prefers-color-scheme: dark) {
            .hazard-glow {
                box-shadow: 0 0 15px var(--cz-yellow), 0 0 25px var(--cz-orange);
            }

            .hazard-border {
                border-color: var(--cz-yellow);
                box-shadow: 0 0 10px var(--cz-yellow);
            }

            .hazard-text {
                color: var(--cz-yellow);
                text-shadow: 0 0 10px var(--cz-yellow);
            }
        }

        /* Industrial Scrollbar */
        ::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }

        ::-webkit-scrollbar-track {
            background: var(--cz-concrete-dark);
            border: 2px solid var(--cz-black);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--cz-concrete);
            border: 2px solid var(--cz-black);
            box-shadow: inset 1px 1px 0 rgba(255,255,255,0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--cz-yellow);
            border-color: var(--cz-yellow-dark);
        }

        ::-webkit-scrollbar-corner {
            background: var(--cz-black);
        }

        /* Construction Zone Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--cz-black);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeOut 0.5s ease-out 2s forwards;
        }

        #loading-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--hazard-stripe);
        }

        #loading-screen::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--hazard-stripe);
        }

        #loading-screen.hidden {
            display: none;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .loading-logo {
            font-family: var(--font-industrial);
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 6px;
            text-transform: uppercase;
            color: var(--cz-yellow);
            text-shadow: 3px 3px 0 var(--cz-black), 0 0 30px rgba(255, 208, 0, 0.5);
            animation: pulse 2s ease-in-out infinite;
            margin-bottom: 30px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--cz-concrete);
            border-top: 4px solid var(--cz-yellow);
            border-right: 4px solid var(--cz-orange);
            border-radius: 0;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 30px rgba(255, 208, 0, 0.3);
        }

        .loading-text {
            margin-top: 20px;
            font-family: var(--font-stencil);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--cz-yellow);
            animation: fadeInOut 1.5s ease-in-out infinite;
        }

@keyframes fadeInOut {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

@keyframes shimmer {
    0% { background-position: -200px 0; }
    100% { background-position: 200px 0; }
}

        /* Logo Glow Animation */
        .logo {
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { text-shadow: 2px 2px 0 var(--cz-black), 0 0 20px rgba(255, 208, 0, 0.3); }
            50% { text-shadow: 2px 2px 0 var(--cz-black), 0 0 30px rgba(255, 208, 0, 0.6), 0 0 40px rgba(255, 107, 0, 0.3); }
        }

        /* Pulsing Activity Items */
        .activity-item {
            animation: slideInLeft 0.3s ease-out;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(255, 208, 0, 0.1);
            transform: translateX(5px);
            border-left: 3px solid var(--cz-yellow);
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Enhanced Stats with Glow */
        #network-stats > div > div {
            transition: all 0.3s ease;
        }

        #network-stats > div > div:hover {
            transform: scale(1.1);
        }

        #total-locations, #active-users {
            text-shadow: 0 0 15px currentColor;
        }

        /* FAB Animation - Override float for industrial feel */
        .fab {
            animation: none;
        }

        .fab:hover {
            animation: none;
        }

        /* Nav Buttons with Better Hover Effects */
        .nav-btn {
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        /* Enhanced Panels with Depth */
        .panel {
            position: relative;
            transition: all 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        /* Tags Input Styles */
        .tags-input-container {
            background: #F5F5F5;
            border: 3px solid var(--cz-black);
            padding: 8px;
            min-height: 40px;
            font-family: var(--font-blueprint);
            font-size: 12px;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.2);
        }

        .tags-input-container:focus-within {
            border-color: var(--cz-yellow);
            box-shadow: 0 0 0 3px rgba(255, 208, 0, 0.3), inset 2px 2px 4px rgba(0,0,0,0.2);
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 4px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--cz-yellow);
            color: var(--cz-black);
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid var(--cz-black);
            box-shadow: 1px 1px 0 var(--cz-black);
        }

        .tag.remove {
            cursor: pointer;
            background: var(--cz-red);
            color: white;
        }

        .tag.remove:hover {
            background: #FF0000;
        }

        .predefined-tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .predefined-tag {
            background: var(--cz-concrete);
            border: 2px solid var(--cz-black);
            color: var(--text-secondary);
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 1px 1px 0 var(--cz-black);
        }

        .predefined-tag:hover {
            background: var(--cz-concrete-light);
            color: var(--cz-yellow);
            transform: translate(-1px, -1px);
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .predefined-tag.selected {
            background: var(--cz-yellow);
            color: var(--cz-black);
        }

        /* Comments and Rating Styles */
        .comments-section {
            margin-top: 16px;
            border-top: 3px solid var(--cz-black);
            padding-top: 16px;
        }

        .comment {
            background: var(--cz-concrete-light);
            border: 2px solid var(--cz-black);
            padding: 8px;
            margin-bottom: 8px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .comment-author {
            font-weight: 700;
            color: var(--cz-yellow);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: var(--font-stencil);
        }

        .comment-time {
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        .comment-text {
            font-size: 11px;
            line-height: 1.3;
            color: var(--cz-black);
            font-family: var(--font-blueprint);
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .rating-score {
            font-weight: 700;
            color: var(--cz-green);
            font-size: 12px;
            font-family: var(--font-stencil);
        }

        .rating-buttons {
            display: flex;
            gap: 4px;
        }

        .rating-btn {
            background: var(--cz-concrete);
            border: 2px solid var(--cz-black);
            color: var(--text-secondary);
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 1px 1px 0 var(--cz-black);
        }

        .rating-btn:hover {
            background: var(--cz-concrete-light);
            color: var(--cz-yellow);
        }

        .rating-btn.liked {
            background: var(--cz-green);
            color: white;
        }

        .rating-btn.disliked {
            background: var(--cz-red);
            color: white;
        }

        /* Location Detail Modal */
        .location-detail-modal .modal-content {
            max-width: 600px;
            max-height: 90vh;
        }

        .location-detail-header {
            border-bottom: 3px solid var(--cz-black);
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .location-detail-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--text-muted);
            font-family: var(--font-blueprint);
        }

        .photos-section {
            margin: 16px 0;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }

        .photo-placeholder {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 12px;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Geocoded marker styling */
        .geocoded-marker {
            animation: pulseMarker 0.8s ease-in-out;
        }

        @keyframes pulseMarker {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Enhanced address input styling */
        #location-address:focus {
            border-color: var(--cz-yellow);
            box-shadow: 0 0 0 3px rgba(255, 208, 0, 0.3), inset 2px 2px 4px rgba(0,0,0,0.2);
        }

        /* Loading states for buttons */
        #find-location-btn:disabled, #use-my-location-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: var(--cz-concrete) !important;
            color: var(--text-muted) !important;
        }

        /* Location detection indicators */
        .location-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--cz-concrete-light);
            border: 3px solid var(--cz-black);
            padding: 8px 12px;
            box-shadow: var(--shadow-industrial);
            font-family: var(--font-stencil);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 6px;
            color: var(--cz-black);
        }

        .location-indicator.detecting {
            display: flex;
            animation: pulse 1s ease-in-out infinite;
        }

        .location-indicator.success {
            background: var(--cz-green);
            color: white;
            border-color: var(--cz-green);
        }

        .location-indicator.error {
            background: var(--cz-red);
            color: white;
            border-color: var(--cz-red);
        }

        .location-indicator.fallback {
            background: var(--cz-orange);
            color: white;
            border-color: var(--cz-orange);
        }

        /* Re-center button */
        .recenter-btn {
            position: absolute;
            top: 60px;
            right: 12px;
            background: var(--cz-yellow);
            border: 3px solid var(--cz-black);
            color: var(--cz-black);
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-stencil);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: var(--bevel-light);
            z-index: 1000;
        }

        .recenter-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--bevel-dark);
        }

        .recenter-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .recenter-btn.loading {
            animation: pulse 1s ease-in-out infinite;
        }

        /* User location marker pulse animation */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .user-location-marker {
            animation: pulse 2s infinite;
        }

        /* Custom marker styles */
        .custom-location-marker {
            background: none !important;
            border: none !important;
        }

        .custom-location-marker div {
            transition: all 0.3s ease;
        }

        .custom-location-marker:hover div {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(255, 208, 0, 0.6);
        }

        /* Enhanced marker cluster styles */
        .marker-cluster {
            background: var(--cz-yellow);
            border: 3px solid var(--cz-black);
            color: var(--cz-black);
            border-radius: 0;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .marker-cluster-small {
            background: var(--cz-yellow);
            color: var(--cz-black);
        }

        .marker-cluster-medium {
            background: var(--cz-orange);
            color: white;
        }

        .marker-cluster-large {
            background: var(--cz-red);
            color: white;
        }

        .marker-cluster div {
            background: none !important;
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-stencil);
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Navigation badges for notifications */
        .nav-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--cz-red);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1px solid var(--cz-black);
            min-width: 16px;
        }

        /* Social features styles */
        .social-feed-item {
            background: var(--cz-concrete);
            border: 2px solid var(--cz-black);
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .social-action-buttons {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }

        .social-btn {
            background: var(--cz-concrete-light);
            border: 2px solid var(--cz-black);
            color: var(--text-secondary);
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 1px 1px 0 var(--cz-black);
        }

        .social-btn:hover {
            background: var(--cz-yellow);
            color: var(--cz-black);
            transform: translate(-1px, -1px);
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .social-btn.liked {
            background: var(--cz-red);
            color: white;
        }

        .social-btn.checked-in {
            background: var(--cz-green);
            color: white;
        }

        /* Mission and achievement styles */
        .mission-card {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-industrial);
            position: relative;
        }

        .mission-progress {
            width: 100%;
            height: 8px;
            background: var(--cz-concrete-dark);
            border: 2px solid var(--cz-black);
            margin: 8px 0;
            position: relative;
        }

        .mission-progress-fill {
            height: 100%;
            background: var(--hazard-stripe);
            transition: width 0.3s ease;
        }

        /* Group and route styles */
        .group-card {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-industrial);
        }

        .route-card {
            background: var(--cz-concrete);
            border: 3px solid var(--cz-black);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-industrial);
        }

        .route-map-preview {
            background: var(--cz-concrete-dark);
            border: 2px solid var(--cz-black);
            height: 120px;
            margin: 8px 0;
            position: relative;
            overflow: hidden;
        }

        /* Notification center styles */
        .notification-item {
            background: var(--cz-concrete-light);
            border: 2px solid var(--cz-black);
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 2px 2px 0 var(--cz-black);
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: var(--cz-yellow);
            color: var(--cz-black);
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 var(--cz-black);
        }

        .notification-item.unread {
            border-left: 4px solid var(--cz-yellow);
            background: var(--cz-concrete);
        }

        .notification-type {
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Profile + Highlight Layouts */
        .profile-shell {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .profile-hero {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--cz-black);
            box-shadow: 3px 3px 0 var(--cz-black);
            background: linear-gradient(135deg, var(--cz-blueprint), var(--cz-black));
            display: grid;
            place-items: center;
            color: var(--cz-yellow);
            font-size: 3rem;
            font-weight: 900;
        }

        .profile-meta h2 {
            margin: 0 0 6px 0;
            font-size: 1.6rem;
        }

        .profile-meta p {
            margin: 0 0 8px 0;
            color: var(--text-secondary);
        }

        .meta-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .profile-stats {
            position: relative;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .profile-card h3 {
            margin: 0 0 10px 0;
        }

        /* Social + Feed polish */
        .social-hero {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 208, 0, 0.14), rgba(30, 58, 95, 0.2));
            border: 3px solid var(--cz-black);
            box-shadow: var(--shadow-industrial);
        }

        .social-hero-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .social-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .social-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .mini-stat {
            background: var(--bg-secondary);
            border: 2px solid var(--cz-black);
            padding: 10px;
            box-shadow: 2px 2px 0 var(--cz-black);
        }

        .mini-label {
            font-family: var(--font-blueprint);
            font-size: 10px;
            color: var(--text-secondary);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .mini-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--cz-yellow);
            text-shadow: 2px 2px 0 var(--cz-black);
            line-height: 1.2;
        }

        .social-compose-panel {
            position: relative;
            overflow: hidden;
        }

        .social-compose-panel::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,208,0,0.05), transparent 55%);
            pointer-events: none;
        }

        .composer-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            color: var(--text-muted);
            font-family: var(--font-blueprint);
            font-size: 0.9rem;
        }

        .input-warning {
            border-color: var(--cz-orange);
        }

        .social-filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .social-feed-grid {
            display: grid;
            gap: 12px;
        }

        .social-card {
            background: var(--bg-secondary);
            border: 2px solid var(--cz-black);
            padding: 12px;
            box-shadow: 3px 3px 0 var(--cz-black);
        }

        .social-card-header {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }

        .social-author {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .social-author img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--cz-black);
        }

        .social-post-body {
            margin: 10px 0;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .social-meta-line {
            display: flex;
            gap: 10px;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .social-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--cz-black);
            color: var(--cz-yellow);
            border: 2px solid var(--cz-black);
            font-family: var(--font-blueprint);
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .social-chip.light {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-color: var(--cz-black);
        }

        .social-action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .social-btn {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 2px solid var(--cz-black);
            padding: 6px 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-blueprint);
            font-size: 11px;
            cursor: pointer;
            transition: var(--transition);
        }

        .social-btn:hover {
            background: var(--bg-tertiary);
            color: var(--cz-yellow);
        }

        .social-btn.liked,
        .social-btn.following {
            background: var(--cz-yellow);
            color: var(--cz-black);
            border-color: var(--cz-black);
        }

        .social-btn.checked-in {
            background: var(--cz-blueprint);
            color: white;
            border-color: var(--cz-black);
        }

        .social-skeleton {
            display: grid;
            gap: 8px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px dashed var(--cz-concrete);
        }

        .skeleton-row {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
        }

        .skeleton-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(90deg, #2d2d2d 0%, #3a3a3a 50%, #2d2d2d 100%);
            background-size: 400px 100%;
            animation: shimmer 1.2s infinite;
        }

        .skeleton-line {
            height: 12px;
            background: linear-gradient(90deg, #2d2d2d 0%, #3a3a3a 50%, #2d2d2d 100%);
            border-radius: 4px;
            background-size: 400px 100%;
            animation: shimmer 1.2s infinite;
        }

        .profile-feed-item {
            background: var(--bg-secondary);
            border: 2px solid var(--cz-black);
            padding: 10px;
            box-shadow: 2px 2px 0 var(--cz-black);
            margin-bottom: 10px;
        }

        .profile-feed-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .profile-feed-body {
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .chip.mini {
            padding: 4px 8px;
            font-size: 9px;
        }

        .highlight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .profile-highlight {
            background: var(--bg-secondary);
            border: 2px solid var(--cz-black);
            padding: 12px;
            box-shadow: 2px 2px 0 var(--cz-black);
            display: grid;
            gap: 6px;
        }

        .timeline {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 10px;
        }

        .timeline-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: flex-start;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--cz-yellow);
            border: 2px solid var(--cz-black);
            margin-top: 4px;
        }

        #user-badges {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-logo">URBINDEX</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Urban Explorer...</div>
    </div>

    <!-- Skip Links for Keyboard Navigation -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <a href="#navigation" class="skip-link">Skip to navigation</a>

    <div class="app">
        <header class="header" role="banner">
            <div class="logo" aria-label="Urbindex - Urban Exploration Network">URBINDEX</div>
            <div class="status" aria-live="polite" aria-atomic="true">
                <div class="status-dot" id="status-dot" aria-hidden="true"></div>
                <span id="status-text">Connected</span>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <!-- Auth Status Indicator -->
                <div id="auth-status" class="auth-status guest" style="display: none;">
                    <div class="auth-avatar" id="auth-avatar">
                        <i class="fas fa-user" aria-hidden="true"></i>
                    </div>
                    <span id="auth-status-text">Guest Mode</span>
                </div>
                
                <button class="btn btn-secondary" id="profile-btn" aria-label="View Profile" onclick="app.handleProfileButtonClick()">
                    <i class="fas fa-user-circle" aria-hidden="true"></i>
                    <span id="profile-btn-text">Profile</span>
                </button>
                <button class="btn btn-primary" id="auth-btn" type="button" aria-label="Authentication and Account Management" style="font-weight: 700;">
                    <i class="fas fa-user" aria-hidden="true"></i>
                    <span id="auth-btn-text">Sign In / Register</span>
                </button>
                
                <!-- Session Warning -->
                <div id="session-warning" class="session-warning" style="display: none;">
                    Session expires in <span id="session-countdown">5</span> minutes
                </div>
            </div>

        </header>

        <nav class="nav" role="navigation" aria-label="Main Navigation" id="navigation">
            <button class="nav-btn active" type="button" data-view="map" aria-label="Map View" aria-current="page">
                <i class="fas fa-map" aria-hidden="true"></i>
                <span>Map</span>
            </button>
            <button class="nav-btn" type="button" data-view="profile" aria-label="Profile View">
                <i class="fas fa-user" aria-hidden="true"></i>
                <span>Profile</span>
            </button>
            <button class="nav-btn" type="button" data-view="locations" aria-label="Locations View">
                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                <span>Locations</span>
            </button>
            <button class="nav-btn" type="button" data-view="social" aria-label="Social Feed">
                <i class="fas fa-users" aria-hidden="true"></i>
                <span>Social</span>
                <span class="nav-badge" id="social-notification-badge" style="display: none;"></span>
            </button>
            <button class="nav-btn" type="button" data-view="missions" aria-label="Missions and Challenges">
                <i class="fas fa-trophy" aria-hidden="true"></i>
                <span>Missions</span>
            </button>
            <button class="nav-btn" type="button" data-view="routes" aria-label="Route Planning">
                <i class="fas fa-route" aria-hidden="true"></i>
                <span>Routes</span>
            </button>
            <button class="nav-btn" type="button" data-view="groups" aria-label="Groups and Teams">
                <i class="fas fa-user-friends" aria-hidden="true"></i>
                <span>Groups</span>
            </button>
            <button class="nav-btn" type="button" data-view="notifications" aria-label="Notifications Center">
                <i class="fas fa-bell" aria-hidden="true"></i>
                <span>Alerts</span>
                <span class="nav-badge" id="notification-badge" style="display: none;"></span>
            </button>
            <button class="nav-btn" type="button" data-view="settings" aria-label="User Settings">
                <i class="fas fa-cog" aria-hidden="true"></i>
                <span>Settings</span>
            </button>
        </nav>

        <main class="main" role="main" id="main-content">
            <div class="view active" id="map-view" role="tabpanel" aria-labelledby="map-tab">
                <section class="dashboard-hero" aria-label="Command center overview">
                    <div class="hero-grid">
                        <div class="hero-lede">
                            <div class="chip live" aria-label="Live network status">
                                <i class="fas fa-broadcast-tower" aria-hidden="true"></i> Live Ops
                            </div>
                            <h2>Field Ops Command Center</h2>
                            <p>
                                Track the network at a glance, drop new finds, and jump back to the map without losing your flow.
                            </p>
                            <div class="meta-chips" style="margin-top: 8px;">
                                <span class="chip safe"><i class="fas fa-shield-alt" aria-hidden="true"></i> Secure Session</span>
                                <span class="chip signal"><i class="fas fa-location-arrow" aria-hidden="true"></i> GPS Ready</span>
                            </div>
                        </div>
                        <div class="stat-grid" aria-label="Live stats summary">
                            <div class="stat-card highlight">
                                <div class="stat-label">Locations online</div>
                                <div class="stat-value" id="hero-total-locations">0</div>
                                <div class="stat-trend">Active pins in the network</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Active explorers</div>
                                <div class="stat-value" id="hero-active-users">0</div>
                                <div class="stat-trend">Signed in past 24h</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Activity index</div>
                                <div class="stat-value" id="hero-activity-index">--</div>
                                <div class="stat-trend">Pace of new reports</div>
                            </div>
                        </div>
                    </div>
                    <div class="quick-actions" aria-label="Quick map actions">
                        <button class="btn btn-primary" type="button" onclick="app.showAddLocationModal()">
                            <i class="fas fa-plus" aria-hidden="true"></i> Drop a Location
                        </button>
                        <button class="btn" type="button" onclick="app.recenterToUserLocation()">
                            <i class="fas fa-crosshairs" aria-hidden="true"></i> Snap to Me
                        </button>
                        <button class="btn" type="button" onclick="app.showView('missions')">
                            <i class="fas fa-trophy" aria-hidden="true"></i> Missions
                        </button>
                        <button class="btn" type="button" onclick="app.showView('profile')">
                            <i class="fas fa-id-badge" aria-hidden="true"></i> My Profile
                        </button>
                    </div>
                </section>

                <div class="map-layout">
                    <aside class="sidebar" role="complementary" aria-label="Map sidebar with activity and statistics">
                        <div class="panel">
                            <div class="panel-title">
                                <i class="fas fa-activity" aria-hidden="true"></i>
                                Recent Activity
                            </div>
                            <div id="activity-feed" class="loading" role="status" aria-live="polite">Loading...</div>
                        </div>

                        <div class="panel">
                            <div class="panel-title">
                                <i class="fas fa-chart-bar" aria-hidden="true"></i>
                                Network Stats
                            </div>
                            <div id="network-stats" role="status" aria-live="polite" aria-label="Network statistics">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; text-align: center;">
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-blue);" id="total-locations">0</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Locations</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-blue);" id="active-users">0</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Explorers</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <div class="map-container" role="application" aria-label="Interactive Map for Urban Exploration" aria-describedby="map-instructions">
                        <div id="map" tabindex="0" aria-label="Interactive map showing urban exploration locations"></div>
                        <div id="location-indicator" class="location-indicator">
                            <i class="fas fa-location-arrow" aria-hidden="true"></i>
                            <span>Detecting location...</span>
                        </div>
                        <button id="recenter-btn" class="recenter-btn" onclick="app.recenterToUserLocation()" aria-label="Re-center map to your current location">
                            <i class="fas fa-crosshairs" aria-hidden="true"></i>
                            <span>My Location</span>
                        </button>
                        <div id="map-instructions" class="sr-only" style="position: absolute; left: -10000px;">
                            Interactive map for exploring urban locations. Use arrow keys to navigate, Enter to select markers, and Escape to exit map mode.
                        </div>
                    </div>
                </div>
            </div>

            <div class="view" id="locations-view" role="tabpanel" aria-labelledby="locations-tab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>My Locations</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" onclick="app.showView('map')" aria-label="Return to map view">
                            <i class="fas fa-map" aria-hidden="true"></i>
                            <span>Back to Map</span>
                        </button>
                        <button class="btn btn-primary" onclick="app.showAddLocationModal()" aria-label="Add New Location to Your List">
                            <i class="fas fa-plus" aria-hidden="true"></i>
                            <span>Add Location</span>
                        </button>
                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="panel" style="margin-bottom: 24px;">
                    <div class="sr-only" id="locations-filter-instructions">
                        Use these controls to search and filter your locations. Results update automatically.
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px; align-items: center;">
                        <div class="form-group" style="margin: 0;">
                            <label for="location-search" class="form-label" style="margin-bottom: 4px;">
                                <i class="fas fa-search" aria-hidden="true"></i>
                                Search Locations
                            </label>
                            <input class="input" type="text" id="location-search"
                                   placeholder="Search by name, description, or tags..."
                                   aria-describedby="location-search-instructions"
                                   style="margin: 0;">
                            <div id="location-search-instructions" class="sr-only">
                                Search through your location names, descriptions, and tags
                            </div>
                        </div>

                        <div class="form-group" style="margin: 0;">
                            <label for="category-filter" class="form-label" style="margin-bottom: 4px;">
                                <i class="fas fa-filter" aria-hidden="true"></i>
                                Category
                            </label>
                            <select class="select" id="category-filter" style="margin: 0;" aria-label="Filter locations by category">
                                <option value="">All Categories</option>
                                <option value="abandoned">Abandoned</option>
                                <option value="rooftop">Rooftop</option>
                                <option value="tunnel">Tunnel</option>
                                <option value="industrial">Industrial</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin: 0;">
                            <label for="risk-filter" class="form-label" style="margin-bottom: 4px;">
                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                Risk Level
                            </label>
                            <select class="select" id="risk-filter" style="margin: 0;" aria-label="Filter locations by risk level">
                                <option value="">All Risks</option>
                                <option value="low">Low Risk</option>
                                <option value="moderate">Moderate Risk</option>
                                <option value="high">High Risk</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin: 0;">
                            <label for="sort-filter" class="form-label" style="margin-bottom: 4px;">
                                <i class="fas fa-sort-amount-down" aria-hidden="true"></i>
                                Sort By
                            </label>
                            <select class="select" id="sort-filter" style="margin: 0;" aria-label="Sort locations">
                                <option value="recent">Most Recent</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="popularity">Popularity</option>
                                <option value="risk-low">Risk Level (Low-High)</option>
                                <option value="risk-high">Risk Level (High-Low)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="locations-grid" class="loading" role="status" aria-live="polite" aria-label="Loading your locations">
                    Loading your locations...
                </div>
            </div>

            <div class="view" id="profile-view" role="tabpanel" aria-labelledby="profile-tab">
                <h2>Profile</h2>
                <div id="profile-content" class="loading" role="status" aria-live="polite">Loading profile...</div>
            </div>

            <!-- User Settings Panel -->
            <div class="view" id="settings-view" role="tabpanel" aria-labelledby="settings-tab">
                <h2>Settings</h2>
                <div id="settings-content" class="loading" role="status" aria-live="polite">Loading settings...</div>
            </div>

            <div class="view" id="social-view" role="tabpanel" aria-labelledby="social-tab">
                <div id="social-view-content" class="panel">
                    <div class="loading">Loading social feed...</div>
                </div>
            </div>

            <div class="view" id="missions-view" role="tabpanel" aria-labelledby="missions-tab">
                <div id="missions-view-content" class="panel">
                    <div class="loading">Loading missions...</div>
                </div>
            </div>

            <div class="view" id="routes-view" role="tabpanel" aria-labelledby="routes-tab">
                <div id="routes-view-content" class="panel">
                    <div class="loading">Loading routes...</div>
                </div>
            </div>

            <div class="view" id="groups-view" role="tabpanel" aria-labelledby="groups-tab">
                <div id="groups-view-content" class="panel">
                    <div class="loading">Loading groups...</div>
                </div>
            </div>

            <div class="view" id="notifications-view" role="tabpanel" aria-labelledby="notifications-tab">
                <div id="notifications-view-content" class="panel">
                    <div class="loading">Loading notifications...</div>
                </div>
            </div>
        </main>

        <button class="fab" id="add-location-fab" onclick="app.showAddLocationModal()"
                style="display:none;" aria-label="Add New Location" role="button">
            <i class="fas fa-plus" aria-hidden="true"></i>
        </button>
    </div>

    <div class="modal" id="location-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="app.hideModal()">&times;</button>
            <h3 id="location-modal-title">Add Location</h3>
            <form id="location-form">
                <div class="form-group">
                    <label class="form-label required" for="location-name">
                        <i class="fas fa-tag" aria-hidden="true"></i>
                        Name
                    </label>
                    <input class="input" type="text" id="location-name" name="name"
                           required aria-describedby="location-name-help" autocomplete="off">
                    <div id="location-name-help" class="field-help">
                        Enter a descriptive name for the location
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required" for="location-description">
                        <i class="fas fa-align-left" aria-hidden="true"></i>
                        Description
                    </label>
                    <textarea class="textarea" id="location-description" name="description"
                              required aria-describedby="location-description-help"></textarea>
                    <div id="location-description-help" class="field-help">
                        Provide details about the location, access points, and what makes it interesting
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="location-category">Category</label>
                        <select class="select" id="location-category" name="category" aria-label="Select location category">
                            <option value="abandoned">Abandoned</option>
                            <option value="rooftop">Rooftop</option>
                            <option value="tunnel">Tunnel</option>
                            <option value="industrial">Industrial</option>
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="historic">Historic</option>
                            <option value="underground">Underground</option>
                            <option value="park">Park/Green Space</option>
                            <option value="waterfront">Waterfront</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="location-risk">Risk Level</label>
                        <select class="select" id="location-risk" name="riskLevel" aria-label="Select risk level">
                            <option value="low">Low</option>
                            <option value="moderate">Moderate</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="tag-input">
                        <i class="fas fa-tags" aria-hidden="true"></i>
                        Tags
                    </label>
                    <div class="tags-input-container">
                        <div id="selected-tags" class="selected-tags"></div>
                        <input class="input" type="text" id="tag-input" name="tag-input"
                               placeholder="Add custom tags..." style="margin-top: 8px;"
                               aria-describedby="tag-input-help">
                        <div id="tag-input-help" class="field-help">
                            Press Enter or comma to add tags. Maximum 10 tags allowed.
                        </div>
                    </div>
                    <div class="predefined-tags" style="margin-top: 8px;">
                        <div class="cz-label" style="margin-bottom: 6px; color: var(--text-muted);">Suggested tags:</div>
                        <div id="predefined-tags-list" class="predefined-tags-list"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="location-address">
                        <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                        Address
                    </label>
                    <div style="display: flex; gap: 8px; align-items: stretch;">
                        <input class="input" type="text" id="location-address" name="address"
                               placeholder="Enter address (e.g., 123 Main St, City, State)"
                               aria-describedby="location-address-help" autocomplete="off" style="flex: 1;">
                        <button type="button" class="btn btn-primary" id="find-location-btn"
                                aria-label="Find location using address" style="min-width: 44px;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="location-address-help" class="field-help">
                        Enter an address to automatically find its location on the map
                    </div>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <label class="form-label" style="margin: 0;">
                            <i class="fas fa-crosshairs" aria-hidden="true"></i>
                            Coordinates
                        </label>
                        <button type="button" class="btn btn-primary" id="use-my-location-btn"
                                aria-label="Use my current location" style="font-size: 10px; padding: 4px 8px;">
                            <i class="fas fa-location-arrow"></i>
                            Use My Location
                        </button>
                    </div>
                    <div class="coordinates-display" id="coordinates-display" aria-live="polite">
                        Click on map or use address to set location
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="app.hideModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="location-submit-btn"
                            aria-label="Save location information">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div class="modal" id="password-reset-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="app.hidePasswordResetModal()">&times;</button>
            <h3>Reset Password</h3>
            <p class="cz-text" style="color: var(--text-secondary); margin-bottom: 20px;">
                Enter your email address and we'll send you a link to reset your password.
            </p>
            <form id="password-reset-form">
                <div class="form-group">
                    <label class="form-label required" for="reset-email">
                        <i class="fas fa-envelope" aria-hidden="true"></i>
                        Email Address
                    </label>
                    <input class="input" type="email" id="reset-email" name="email"
                           required aria-describedby="reset-email-help" autocomplete="email">
                    <div id="reset-email-help" class="field-help">
                        Enter the email address associated with your account
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="app.hidePasswordResetModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" aria-label="Send password reset email">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="app.hideEditProfileModal()">&times;</button>
            <h3>Edit Profile</h3>
            <form id="edit-profile-form">
                <div class="form-group">
                    <label class="form-label" for="profile-display-name">
                        <i class="fas fa-user" aria-hidden="true"></i>
                        Display Name
                    </label>
                    <input class="input" type="text" id="profile-display-name" name="displayName"
                           placeholder="Your display name" aria-describedby="display-name-help" autocomplete="name">
                    <div id="display-name-help" class="field-help">
                        This is how your name will appear to others
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="profile-bio">
                        <i class="fas fa-align-left" aria-hidden="true"></i>
                        Bio
                    </label>
                    <textarea class="textarea" id="profile-bio" name="bio" rows="4"
                              placeholder="Tell others about yourself and your urban exploration journey..."
                              aria-describedby="bio-help" maxlength="500"></textarea>
                    <div id="bio-help" class="field-help">
                        Maximum 500 characters
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="profile-photo-upload">
                        <i class="fas fa-image" aria-hidden="true"></i>
                        Profile Photo
                    </label>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input class="input" type="file" id="profile-photo-upload" name="photoUpload"
                               accept="image/*" aria-describedby="photo-help" style="flex: 1;">
                        <button type="button" class="btn" id="upload-photo-btn" style="min-width: 80px;">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                    <div id="photo-help" class="field-help">
                        Choose an image file (max 5MB, JPG/PNG/WEBP)
                    </div>
                    <div id="photo-progress" style="display: none; margin-top: 8px;">
                        <div style="width: 100%; height: 4px; background: var(--cz-concrete); border: 1px solid var(--cz-black);">
                            <div id="photo-progress-bar" style="height: 100%; background: var(--cz-yellow); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="margin-top: 4px; font-size: 0.8rem; color: var(--text-muted);" id="photo-progress-text">Uploading...</div>
                    </div>
                    <input class="input" type="url" id="profile-photo-url" name="photoURL"
                           placeholder="Or enter photo URL" aria-describedby="photo-url-help" style="margin-top: 8px;">
                    <div id="photo-url-help" class="field-help">
                        Alternative: enter a direct URL to your profile photo
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="profile-links">
                        <i class="fas fa-link" aria-hidden="true"></i>
                        Links (one per line)
                    </label>
                    <textarea class="textarea" id="profile-links" name="links" rows="3"
                              placeholder="https://your-site.com&#10;https://instagram.com/you"></textarea>
                    <div class="field-help">Add URLs to share with visitors.</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="profile-gallery">
                        <i class="fas fa-images" aria-hidden="true"></i>
                        Gallery Image URLs (one per line)
                    </label>
                    <textarea class="textarea" id="profile-gallery" name="gallery" rows="3"
                              placeholder="https://example.com/photo1.jpg&#10;https://example.com/photo2.jpg"></textarea>
                    <div class="field-help">Provide direct image links to showcase in your gallery.</div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="app.hideEditProfileModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="profile-submit-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Locations Modal -->
    <div class="modal" id="user-locations-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="user-locations-title">
        <div class="modal-content">
            <button class="modal-close" onclick="app.hideUserLocationsModal()">&times;</button>
            <h3 id="user-locations-title">User Locations</h3>
            <div id="user-locations-list" class="loading" role="status" aria-live="polite">Loading user locations...</div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="app.hideAuthModal()">&times;</button>
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="signin" aria-label="Sign in to your account">Sign In</button>
                <button class="auth-tab" data-tab="signup" aria-label="Create a new account">Sign Up</button>
            </div>
            <div id="signin-form" class="auth-form active">
                <form id="signin-form-element">
                    <div class="form-group">
                        <label class="form-label required" for="signin-email">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                            Email
                        </label>
                        <input class="input" type="email" id="signin-email" name="email"
                               required aria-describedby="signin-email-help signin-email-error" autocomplete="email">
                        <div id="signin-email-help" class="field-help">
                            Enter your registered email address
                        </div>
                        <div id="signin-email-error" class="field-error" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="signin-password">
                            <i class="fas fa-lock" aria-hidden="true"></i>
                            Password
                        </label>
                        <input class="input" type="password" id="signin-password" name="password"
                               required aria-describedby="signin-password-help signin-password-error" autocomplete="current-password">
                        <div id="signin-password-help" class="field-help">
                            Enter your account password
                        </div>
                        <div id="signin-password-error" class="field-error" style="display: none;"></div>
                    </div>
                    
                    <!-- OAuth Buttons -->
                    <div class="oauth-divider">OR CONTINUE WITH</div>
                    <div class="oauth-buttons">
                        <button type="button" class="oauth-btn google" id="google-signin-btn">
                            <i class="fab fa-google" aria-hidden="true"></i>
                            <span>Sign in with Google</span>
                        </button>
                        <button type="button" class="oauth-btn github" id="github-signin-btn">
                            <i class="fab fa-github" aria-hidden="true"></i>
                            <span>Sign in with GitHub</span>
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn" onclick="app.hideAuthModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="signin-submit-btn">Sign In</button>
                    </div>
                    <div class="auth-alternatives">
                        <button class="btn-link" onclick="app.showPasswordResetModal()">Forgot password?</button>
                        <span> | </span>
                        <button class="btn-link" onclick="app.signInAnonymously()">Continue as guest</button>
                    </div>
                </form>
            </div>
            <div id="signup-form" class="auth-form">
                <form id="signup-form-element">
                    <div class="form-group">
                        <label class="form-label required" for="signup-email">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                            Email
                        </label>
                        <input class="input" type="email" id="signup-email" name="email"
                               required aria-describedby="signup-email-help signup-email-error" autocomplete="email">
                        <div id="signup-email-help" class="field-help">
                            Choose a valid email address
                        </div>
                        <div id="signup-email-error" class="field-error" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="signup-password">
                            <i class="fas fa-lock" aria-hidden="true"></i>
                            Password
                        </label>
                        <input class="input" type="password" id="signup-password" name="password"
                               required aria-describedby="signup-password-help signup-password-error" autocomplete="new-password">
                        <div id="signup-password-help" class="field-help">
                            Minimum 8 characters with uppercase, lowercase, numbers, and symbols
                        </div>
                        <div id="signup-password-error" class="field-error" style="display: none;"></div>
                        <div class="password-strength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="password-strength-fill"></div>
                            </div>
                            <div id="password-strength-text" style="margin-top: 4px;">Password strength: Not entered</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="signup-confirm-password">
                            <i class="fas fa-lock" aria-hidden="true"></i>
                            Confirm Password
                        </label>
                        <input class="input" type="password" id="signup-confirm-password" name="confirmPassword"
                               required aria-describedby="signup-confirm-help signup-confirm-error" autocomplete="new-password">
                        <div id="signup-confirm-help" class="field-help">
                            Re-enter your password
                        </div>
                        <div id="signup-confirm-error" class="field-error" style="display: none;"></div>
                    </div>
                    
                    <!-- OAuth Buttons -->
                    <div class="oauth-divider">OR SIGN UP WITH</div>
                    <div class="oauth-buttons">
                        <button type="button" class="oauth-btn google" id="google-signup-btn">
                            <i class="fab fa-google" aria-hidden="true"></i>
                            <span>Sign up with Google</span>
                        </button>
                        <button type="button" class="oauth-btn github" id="github-signup-btn">
                            <i class="fab fa-github" aria-hidden="true"></i>
                            <span>Sign up with GitHub</span>
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn" onclick="app.hideAuthModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="signup-submit-btn">Create Account</button>
                    </div>
                    <div class="auth-alternatives">
                        <button class="btn-link" onclick="app.signInAnonymously()">Continue as guest instead</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(() => console.log('SW registered'))
                    .catch((error) => console.log('SW registration failed', error));
            });
        }

        // Global error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault();
        });

        // PWA Installation Detection and Prompt
        let deferredPrompt;
        let installBannerShown = false;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show custom install banner after a delay
            setTimeout(() => {
                if (!installBannerShown && !window.matchMedia('(display-mode: standalone)').matches) {
                    showInstallBanner();
                    installBannerShown = true;
                }
            }, 10000); // Show after 10 seconds
        });

        function showInstallBanner() {
            // Create install banner
            const banner = document.createElement('div');
            banner.id = 'pwa-install-banner';
            banner.innerHTML = `
                <div style="background: var(--cz-concrete);
                           border: 4px solid var(--cz-black);
                           padding: 16px;
                           margin: 16px;
                           box-shadow: var(--shadow-industrial);
                           position: fixed;
                           bottom: 80px;
                           left: 16px;
                           right: 16px;
                           z-index: 2000;
                           border-radius: 0;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 6px; background: var(--hazard-stripe);"></div>
                    <div style="display: flex; align-items: center; gap: 12px; padding-top: 8px;">
                        <div style="width: 48px; height: 48px;
                                    background: var(--cz-yellow);
                                    border: 3px solid var(--cz-black);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;">
                            <i class="fas fa-hard-hat" style="color: var(--cz-black); font-size: 1.2rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-family: var(--font-industrial);
                                       font-size: 14px;
                                       font-weight: 900;
                                       text-transform: uppercase;
                                       letter-spacing: 2px;
                                       color: var(--cz-yellow);">Install Urbindex</div>
                            <div style="font-family: var(--font-blueprint);
                                       font-size: 11px;
                                       color: var(--text-secondary);
                                       margin-top: 2px;">Get the full site access with offline capabilities</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="install-btn" class="btn btn-primary" style="font-size: 11px; padding: 6px 12px;">
                                <i class="fas fa-download"></i> Install
                            </button>
                            <button id="dismiss-btn" class="btn" style="font-size: 11px; padding: 6px 12px;">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(banner);

            // Install button handler
            document.getElementById('install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;

                    if (outcome === 'accepted') {
                        console.log('PWA installation accepted');
                        banner.remove();
                    }
                    deferredPrompt = null;
                }
            });

            // Dismiss button handler
            document.getElementById('dismiss-btn').addEventListener('click', () => {
                banner.remove();
            });

            // Auto-dismiss after 30 seconds
            setTimeout(() => {
                if (banner.parentNode) {
                    banner.remove();
                }
            }, 30000);
        }

        // Listen for successful installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed successfully');
            const banner = document.getElementById('pwa-install-banner');
            if (banner) banner.remove();

            // Show success message
            if (window.app && window.app.showToast) {
                window.app.showToast('Urbindex installed successfully!', 'success');
            }
        });
        
        // Google Places API callback
        function initGooglePlaces() {
            if (window.app) {
                window.app.initGooglePlaces();
            }
        }
    </script>
    
    <script src="load-env.js" onerror="console.error('Failed to load environment variables')"></script>
    <script src="firebase-config.js" onerror="console.error('Failed to load Firebase configuration')"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" onerror="console.error('Failed to load Leaflet')"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" onerror="console.error('Failed to load Marker Cluster')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" onerror="console.error('Failed to load Firebase App')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" onerror="console.error('Failed to load Firebase Auth')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" onerror="console.error('Failed to load Firebase Firestore')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js" onerror="console.error('Failed to load Firebase Storage')"></script>
    
    <!-- Google OAuth SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- GitHub OAuth SDK -->
    <script src="https://github.com/login/oauth/authorize" style="display: none;"></script>
    
    <!-- Google Places API -->
    <script async defer 
            src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_PLACES_API_KEY&libraries=places&callback=initGooglePlaces">
    </script>
    
    <script>
        class UrbindexApp {
            constructor() {
                this.map = null;
                this.currentUser = null;
                this.markers = new Map();
                this.markerClusterGroup = null; // Marker clustering group
                this.selectedLatLng = null;
                this.tempMarker = null;
                this.activeOperations = new Set(); // Track active async operations to prevent duplicate clicks
                this.notifications = [];
                this.unreadNotifications = 0;
                this.userProfiles = new Map(); // Cache of user profile data for social surfaces
                this.socialFeedItems = []; // Cached social feed items
                this.followingIds = []; // Cached following list for feed filters
                this.postLikeState = new Map(); // Track whether the current user liked a social post
                this.postCommentCache = new Map(); // Cache of recent comments per post
                this.socialSearchTerm = '';
                this.lastSocialRefresh = null;
                this.init();
                this.initTagSystem();
                
                // Initialize Google Places API if available
                this.initGooglePlaces();
            }
            
            // Google Places API initialization
            initGooglePlaces() {
                // This will be called by the Google Places API callback
                if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                    this.googlePlacesAvailable = true;
                    console.log('Google Places API loaded successfully');
                    this.initPlacesAutocomplete();
                } else {
                    this.googlePlacesAvailable = false;
                    console.log('Google Places API not available, using OpenStreetMap only');
                }
            }
            
            initPlacesAutocomplete() {
                if (!this.googlePlacesAvailable) return;
                
                const addressInput = document.getElementById('location-address');
                if (!addressInput) return;
                
                // Create autocomplete instance
                this.placesAutocomplete = new google.maps.places.Autocomplete(addressInput, {
                    types: ['establishment', 'geocode'],
                    componentRestrictions: { country: [] } // Allow worldwide search
                });
                
                // Add place changed listener
                this.placesAutocomplete.addListener('place_changed', () => {
                    const place = this.placesAutocomplete.getPlace();
                    if (place.geometry && place.geometry.location) {
                        const lat = place.geometry.location.lat();
                        const lng = place.geometry.location.lng();
                        const address = place.formatted_address || place.name;
                        this.setLocationFromCoordinates(lat, lng, address);
                        this.showToast(`Location found: ${address}`, 'success');
                    }
                });
            }

            async init() {
                try {
                    await this.initFirebase();
                    this.initMap();
                    this.initUI();
                    this.initAuth();
                    this.initSessionManagement(); // Initialize session management
                    this.initRateLimiting(); // Initialize rate limiting
                    this.loadData();

                    // Hide loading screen after successful initialization
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.classList.add('hidden');
                        }
                    }, 1500);
                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.showError(`Failed to initialize app: ${error.message}`);
                    // Hide loading screen even on error
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('hidden');
                    }
                }
            }

            async initFirebase() {
                // Check if Firebase is loaded
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK failed to load. Please check your internet connection and refresh the page.');
                }

                // Load secure Firebase configuration
                if (typeof window.firebaseConfig === 'undefined') {
                    console.error('Firebase configuration not found');
                    throw new Error('Firebase configuration is missing. Please check your environment variables or firebase-config.js');
                }

                const config = window.firebaseConfig;

                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(config);
                    }
                    this.db = firebase.firestore();
                    this.auth = firebase.auth();
                    this.storage = firebase.storage();
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    throw new Error('Failed to initialize Firebase. Please check your internet connection and refresh the page.');
                }
                
                // Enable offline persistence
                try {
                    await this.db.enablePersistence({ synchronizeTabs: true });
                } catch (err) {
                    if (err.code === 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code === 'unimplemented') {
                        console.warn('The current browser does not support persistence.');
                    }
                }
            }

            initMap() {
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('Map element not found');
                    this.showError('Map could not be loaded. Please refresh the page.');
                    return;
                }

                try {
                    // Enhanced map initialization with location detection
                    this.initializeMapWithLocation();
                } catch (error) {
                    console.error('Map initialization failed:', error);
                    this.showError('Failed to initialize map. Please check your internet connection and refresh the page.');
                }
            }

            async initializeMapWithLocation() {
                this.showLocationIndicator('detecting', 'Detecting your location...');
                
                try {
                    const coordinates = await this.getUserLocationWithFallbacks();
                    const [lat, lng] = coordinates;
                    
                    this.initializeMap(lat, lng);
                    this.showLocationIndicator('success', 'Location detected!');
                    
                    // Cache the location for this session
                    this.cacheUserLocation(lat, lng);
                    
                    setTimeout(() => {
                        this.hideLocationIndicator();
                    }, 2000);
                    
                } catch (error) {
                    console.warn('Using fallback location:', error.message);
                    
                    // Try to get fallback from browser locale
                    const fallbackCoords = this.getLocaleBasedFallback();
                    this.initializeMap(fallbackCoords[0], fallbackCoords[1]);
                    
                    this.showLocationIndicator('fallback', 'Using default location');
                    this.showToast('Map centered on default location', 'info');
                    
                    setTimeout(() => {
                        this.hideLocationIndicator();
                    }, 3000);
                }
            }

            async getUserLocationWithFallbacks() {
                // Check if we have a cached location that's still valid (less than 5 minutes old)
                const cachedLocation = this.getCachedUserLocation();
                if (cachedLocation) {
                    return cachedLocation;
                }

                // Check if geolocation is available
                if (!this.isGeolocationAvailable()) {
                    throw new Error('Geolocation is not supported by this browser');
                }

                // Try to get user's current location
                try {
                    return await this.getUserLocation();
                } catch (error) {
                    // If user denies permission or location is unavailable, try to get country-based fallback
                    console.warn('Geolocation failed:', error.message);
                    
                    // Try to get location from browser locale/IP-based services
                    const localeCoords = await this.getLocaleBasedLocation();
                    if (localeCoords) {
                        return localeCoords;
                    }
                    
                    // Re-throw the original error if all fallbacks fail
                    throw error;
                }
            }

            isGeolocationAvailable() {
                return 'geolocation' in navigator;
            }

            async getLocaleBasedLocation() {
                try {
                    // Try to get location from browser locale
                    const locale = navigator.language || navigator.userLanguage || 'en-US';
                    
                    // Simple locale-based fallbacks for major regions
                    const localeMap = {
                        'en-US': [39.8283, -98.5795], // US Center
                        'en-GB': [54.7023, -3.2766],  // UK Center
                        'en-CA': [56.1304, -106.3468], // Canada Center
                        'en-AU': [-25.2744, 133.7751], // Australia Center
                        'en-NZ': [-40.9006, 174.8860], // New Zealand Center
                        'en-IN': [20.5937, 78.9629],   // India Center
                        'en-ZA': [-30.5595, 22.9375],  // South Africa Center
                        'en': [0, 0] // Global center
                    };
                    
                    // Find the best match for the locale
                    const localeCode = locale.split('-').slice(0, 2).join('-');
                    const coords = localeMap[localeCode] || localeMap[locale.split('-')[0]] || localeMap['en'];
                    
                    console.log(`Using locale-based fallback for ${locale}: ${coords[0]}, ${coords[1]}`);
                    return coords;
                    
                } catch (error) {
                    console.warn('Failed to get locale-based location:', error);
                    return null;
                }
            }

            getLocaleBasedFallback() {
                try {
                    const coords = this.getLocaleBasedLocation();
                    return coords || [0, 0]; // Global center as ultimate fallback
                } catch (error) {
                    return [0, 0]; // Global center
                }
            }

            cacheUserLocation(lat, lng) {
                try {
                    const locationData = {
                        lat,
                        lng,
                        timestamp: Date.now()
                    };
                    sessionStorage.setItem('urbindex_user_location', JSON.stringify(locationData));
                } catch (error) {
                    console.warn('Failed to cache user location:', error);
                }
            }

            getCachedUserLocation() {
                try {
                    const cached = sessionStorage.getItem('urbindex_user_location');
                    if (cached) {
                        const data = JSON.parse(cached);
                        // Check if cache is less than 5 minutes old
                        const maxAge = 5 * 60 * 1000; // 5 minutes
                        if (Date.now() - data.timestamp < maxAge) {
                            console.log('Using cached location:', data.lat, data.lng);
                            return [data.lat, data.lng];
                        } else {
                            console.log('Cached location expired');
                            sessionStorage.removeItem('urbindex_user_location');
                        }
                    }
                } catch (error) {
                    console.warn('Failed to get cached location:', error);
                    sessionStorage.removeItem('urbindex_user_location');
                }
                return null;
            }

            showLocationIndicator(type, message) {
                const indicator = document.getElementById('location-indicator');
                if (!indicator) return;
                
                // Remove all classes first
                indicator.className = 'location-indicator';
                
                // Add appropriate class and content
                indicator.classList.add(type);
                indicator.querySelector('span').textContent = message;
                
                // Show the indicator
                indicator.style.display = 'flex';
            }

            hideLocationIndicator() {
                const indicator = document.getElementById('location-indicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            setRecenterButtonState(state) {
                const button = document.getElementById('recenter-btn');
                if (!button) return;
                
                const icon = button.querySelector('i');
                const span = button.querySelector('span');
                
                // Remove all state classes
                button.classList.remove('loading');
                
                switch (state) {
                    case 'loading':
                        button.disabled = true;
                        button.classList.add('loading');
                        if (icon) icon.className = 'fas fa-spinner fa-spin';
                        if (span) span.textContent = 'Locating...';
                        break;
                    case 'success':
                        if (icon) icon.className = 'fas fa-check';
                        if (span) span.textContent = 'Found!';
                        break;
                    case 'error':
                        if (icon) icon.className = 'fas fa-exclamation-triangle';
                        if (span) span.textContent = 'Failed';
                        button.disabled = false; // Allow retry
                        break;
                    default:
                        button.disabled = false;
                        if (icon) icon.className = 'fas fa-crosshairs';
                        if (span) span.textContent = 'My Location';
                        break;
                }
            }

            async recenterToUserLocation() {
                if (!this.map) {
                    this.showToast('Map not initialized', 'error');
                    return;
                }

                try {
                    this.showToast('Finding your location...', 'info');
                    const [lat, lng] = await this.getUserLocation();
                    
                    // Center the map on the user's location
                    this.map.setView([lat, lng], 15);
                    
                    // Add a temporary marker to show the user's position
                    const userMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: '<div style="background: var(--cz-yellow); width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(this.map);
                    
                    // Show popup with location info
                    userMarker.bindPopup(`
                        <div style="text-align: center; font-family: var(--font-blueprint), Arial, sans-serif; font-size: 12px;">
                            <strong style="color: var(--cz-yellow);">Your Location</strong><br>
                            <span style="color: #666;">${lat.toFixed(6)}, ${lng.toFixed(6)}</span>
                        </div>
                    `).openPopup();
                    
                    // Remove marker after 10 seconds
                    setTimeout(() => {
                        this.map.removeLayer(userMarker);
                    }, 10000);
                    
                    this.showToast('Map centered on your location!', 'success');
                    
                    // Cache the location
                    this.cacheUserLocation(lat, lng);
                    
                } catch (error) {
                    console.error('Failed to recenter to user location:', error);
                    this.showToast(error.message, 'error');
                }
            }

            focusMapOnLocation(lat, lng, zoom = 15) {
                if (!this.map || lat === null || lng === null) return;
                this.showView('map');
                setTimeout(() => {
                    this.map.setView([lat, lng], zoom);
                }, 150);
                this.showToast('Centered on location', 'success');
                this.hideUserLocationsModal();
            }

            async getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!this.isGeolocationAvailable()) {
                        reject(new Error('Geolocation is not supported by this browser'));
                        return;
                    }

                    // Show loading state in recenter button
                    this.setRecenterButtonState('loading');

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const [lat, lng] = [position.coords.latitude, position.coords.longitude];
                            console.log(`Geolocation successful: ${lat}, ${lng}`);
                            
                            // Reset button state
                            this.setRecenterButtonState('success');
                            setTimeout(() => {
                                this.setRecenterButtonState('default');
                            }, 2000);
                            
                            resolve([lat, lng]);
                        },
                        (error) => {
                            console.warn('Geolocation error:', error);
                            
                            // Reset button state
                            this.setRecenterButtonState('error');
                            setTimeout(() => {
                                this.setRecenterButtonState('default');
                            }, 3000);
                            
                            let message = 'Unable to retrieve your location';
                            switch (error.code) {
                                case error.PERMISSION_DENIED:
                                    message = 'Location access denied. Please enable location permissions and try again.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    message = 'Location information is unavailable. Try again later.';
                                    break;
                                case error.TIMEOUT:
                                    message = 'Location request timed out. Please try again.';
                                    break;
                            }
                            reject(new Error(message));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 15000, // Increased timeout
                            maximumAge: 300000 // Cache location for 5 minutes
                        }
                    );
                });
            }

            initializeMap(centerLat, centerLng) {
                this.map = L.map('map', {
                    center: [centerLat, centerLng],
                    zoom: 13,
                    zoomControl: true,
                    attributionControl: false,
                    maxBounds: [[-90, -180], [90, 180]], // Prevent panning outside world bounds
                    maxBoundsViscosity: 1.0
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors',
                    maxZoom: 18,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==' // Transparent fallback
                }).addTo(this.map);

                // Add loading/error handling for tiles
                this.map.on('tileerror', (e) => {
                    console.warn('Tile loading error:', e);
                });

                this.map.on('load', () => {
                    console.log('Map loaded successfully');
                });

                this.map.on('click', (e) => this.handleMapClick(e));

                // Handle map resize
                window.addEventListener('resize', () => {
                    if (this.map) {
                        setTimeout(() => this.map.invalidateSize(), 100);
                    }
                });
            }

            initUI() {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switchView(btn.dataset.view));
                });

                const form = document.getElementById('location-form');
                if (form) {
                    form.addEventListener('submit', (e) => this.handleLocationSubmit(e));
                }

                const authBtn = document.getElementById('auth-btn');
                if (authBtn) {
                    authBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleAuth();
                    });
                }

                const passwordResetForm = document.getElementById('password-reset-form');
                if (passwordResetForm) {
                    passwordResetForm.addEventListener('submit', (e) => this.handlePasswordReset(e));
                }

                const editProfileForm = document.getElementById('edit-profile-form');
                if (editProfileForm) {
                    editProfileForm.addEventListener('submit', (e) => this.handleEditProfile(e));
                }

                // Initialize geocoding functionality
                this.initGeocoding();

                // Add accessibility improvements
                this.initKeyboardNavigation();
                this.initFocusManagement();
                this.initLiveRegions();
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideModal();
                        this.hidePasswordResetModal();
                        this.hideAuthModal();
                        this.hideEditProfileModal();
                    }
                });
            }

            initKeyboardNavigation() {
                // Enhanced keyboard navigation for map
                const mapElement = document.getElementById('map');
                if (mapElement) {
                    mapElement.addEventListener('keydown', (e) => {
                        switch (e.key) {
                            case 'ArrowUp':
                                e.preventDefault();
                                this.announceToScreenReader('Moving map up');
                                break;
                            case 'ArrowDown':
                                e.preventDefault();
                                this.announceToScreenReader('Moving map down');
                                break;
                            case 'ArrowLeft':
                                e.preventDefault();
                                this.announceToScreenReader('Moving map left');
                                break;
                            case 'ArrowRight':
                                e.preventDefault();
                                this.announceToScreenReader('Moving map right');
                                break;
                            case 'Enter':
                                e.preventDefault();
                                this.announceToScreenReader('Map marker selected');
                                break;
                        }
                    });
                }

                // Navigation shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case '1':
                                e.preventDefault();
                                this.switchView('map');
                                this.announceToScreenReader('Switched to map view');
                                break;
                            case '2':
                                e.preventDefault();
                                this.switchView('locations');
                                this.announceToScreenReader('Switched to locations view');
                                break;
                            case '3':
                                e.preventDefault();
                                this.switchView('profile');
                                this.announceToScreenReader('Switched to profile view');
                                break;
                        }
                    }
                });
            }

            initFocusManagement() {
                // Focus trap for modals
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.addEventListener('keydown', (e) => {
                        if (e.key === 'Tab') {
                            this.trapFocus(modal, e);
                        }
                    });
                });

                // Return focus after modal closes
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const target = mutation.target;
                            if (target.classList.contains('modal')) {
                                if (!target.classList.contains('active')) {
                                    const returnFocus = target.getAttribute('data-return-focus');
                                    if (returnFocus) {
                                        document.getElementById(returnFocus)?.focus();
                                        target.removeAttribute('data-return-focus');
                                    }
                                }
                            }
                        }
                    });
                });

                modals.forEach(modal => observer.observe(modal, { attributes: true }));
            }

            initLiveRegions() {
                // Create live regions for dynamic announcements
                const liveRegion = document.createElement('div');
                liveRegion.setAttribute('aria-live', 'polite');
                liveRegion.setAttribute('aria-atomic', 'true');
                liveRegion.className = 'sr-only';
                liveRegion.id = 'live-region';
                document.body.appendChild(liveRegion);

                // Create assertive live region for urgent announcements
                const assertiveLiveRegion = document.createElement('div');
                assertiveLiveRegion.setAttribute('aria-live', 'assertive');
                assertiveLiveRegion.setAttribute('aria-atomic', 'true');
                assertiveLiveRegion.className = 'sr-only';
                assertiveLiveRegion.id = 'assertive-live-region';
                document.body.appendChild(assertiveLiveRegion);
            }

            trapFocus(container, event) {
                const focusableElements = container.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (event.shiftKey) {
                    if (document.activeElement === firstElement) {
                        lastElement.focus();
                        event.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        firstElement.focus();
                        event.preventDefault();
                    }
                }
            }

            announceToScreenReader(message, priority = 'polite') {
                const liveRegion = document.getElementById(priority === 'assertive' ? 'assertive-live-region' : 'live-region');
                if (liveRegion) {
                    liveRegion.textContent = message;
                    // Clear after announcement
                    setTimeout(() => {
                        liveRegion.textContent = '';
                    }, 1000);
                }
            }

            initGeocoding() {
                // Set up event listeners for geocoding functionality
                const findLocationBtn = document.getElementById('find-location-btn');
                const useMyLocationBtn = document.getElementById('use-my-location-btn');
                const addressInput = document.getElementById('location-address');

                if (findLocationBtn) {
                    findLocationBtn.addEventListener('click', () => this.handleAddressLookup());
                }

                if (useMyLocationBtn) {
                    useMyLocationBtn.addEventListener('click', () => this.handleMyLocation());
                }

                if (addressInput) {
                    addressInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.handleAddressLookup();
                        }
                    });

                    // Add debouncing for address typing
                    let searchTimeout;
                    addressInput.addEventListener('input', () => {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            // Placeholder for future auto-suggestions
                        }, 500);
                    });
                }
            }

            showView(viewName) {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === viewName);
                });

                document.querySelectorAll('.view').forEach(view => {
                    view.classList.toggle('active', view.id === `${viewName}-view`);
                });

                if (viewName === 'map' && this.map) {
                    setTimeout(() => this.map.invalidateSize(), 100);
                } else if (viewName === 'locations') {
                    this.loadUserLocations();
                } else if (viewName === 'profile') {
                    this.loadProfile();
                } else if (viewName === 'settings') {
                    this.showSettings();
                } else if (viewName === 'social') {
                    this.showSocialFeed();
                } else if (viewName === 'missions') {
                    this.showMissions();
                } else if (viewName === 'routes') {
                    this.showRoutes();
                } else if (viewName === 'groups') {
                    this.showGroups();
                } else if (viewName === 'notifications') {
                    this.showNotifications();
                }
            }

            // ========================
            // SOCIAL FEATURES UI
            // ========================

            showSocialFeed() {
                const view = document.getElementById('social-view-content');
                if (view) {
                    view.innerHTML = `
                        <section class="panel social-hero" aria-label="Network activity overview">
                            <div>
                                <div class="cz-label" style="margin-bottom: 6px;">Network Ops</div>
                                <h2 style="margin-bottom: 6px;">Social Feed</h2>
                                <p class="cz-text" style="color: var(--text-secondary); max-width: 560px;">
                                    Field intel, meetups, and location drops from your crew. Filters and tags keep things sharp.
                                </p>
                                <div class="social-metrics">
                                    <div class="mini-stat">
                                        <div class="mini-label">Posts</div>
                                        <div class="mini-value" id="social-post-count">--</div>
                                    </div>
                                    <div class="mini-stat">
                                        <div class="mini-label">Crew watched</div>
                                        <div class="mini-value" id="social-following-count">--</div>
                                    </div>
                                    <div class="mini-stat">
                                        <div class="mini-label">Contributors</div>
                                        <div class="mini-value" id="social-authors-count">--</div>
                                    </div>
                                </div>
                            </div>
                            <div class="social-hero-actions">
                                <div id="social-last-updated" class="cz-text" style="color: var(--text-muted);">Waiting for sync...</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">
                                    <button class="btn btn-primary" type="button" onclick="app.createNewPost()">
                                        <i class="fas fa-bullhorn"></i> New Post
                                    </button>
                                    <button class="btn" id="social-refresh-btn" type="button">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                    <button class="btn" onclick="app.showView('map')" aria-label="Return to map view">
                                        <i class="fas fa-map" aria-hidden="true"></i>
                                        <span>Back to Map</span>
                                    </button>
                                </div>
                            </div>
                        </section>

                        <div class="social-grid">
                            <section class="panel social-compose-panel" id="social-compose-panel" aria-label="Create a new post">
                                <div class="cz-label" style="margin-bottom: 6px;">Share an update</div>
                                <form id="social-post-form">
                                    <textarea class="textarea" id="social-post-input" rows="3" maxlength="500" placeholder="Drop intel, meetup details, or gear checks..." required></textarea>
                                    <div class="composer-meta">
                                        <span id="social-char-count">0/500</span>
                                        <span id="social-post-helper" class="cz-text" style="color: var(--text-muted); font-size: 0.85rem;">
                                            Posts are shared with the explorers you follow and your own feed.
                                        </span>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px;">
                                        <input class="input" type="text" id="social-post-tags" placeholder="Tags (comma separated, optional)" style="flex: 1; min-width: 160px;">
                                        <input class="input" type="text" id="social-post-location" placeholder="Related location ID (optional)" style="flex: 1; min-width: 160px;">
                                        <button class="btn btn-primary" type="submit" id="social-post-submit">
                                            <i class="fas fa-paper-plane"></i> Post Update
                                        </button>
                                    </div>
                                </form>
                            </section>

                            <section class="panel social-filter-panel" aria-label="Filter social feed">
                                <h3 style="margin-bottom: 10px;">Filters</h3>
                                <div class="social-filter-row">
                                    <div class="form-group" style="margin: 0;">
                                        <label for="social-filter" class="form-label">Filter Feed</label>
                                        <select class="select" id="social-filter" style="margin: 0;" onchange="app.filterSocialFeed()">
                                            <option value="all">All Activity</option>
                                            <option value="following">Following</option>
                                            <option value="location-updates">Location Updates</option>
                                            <option value="social">Social Actions</option>
                                            <option value="achievements">Achievements</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label for="sort-feed" class="form-label">Sort By</label>
                                        <select class="select" id="sort-feed" style="margin: 0;" onchange="app.sortSocialFeed()">
                                            <option value="recent">Most Recent</option>
                                            <option value="popular">Most Popular</option>
                                            <option value="engagement">Most Engaged</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group" style="margin: 12px 0 0 0;">
                                    <label for="social-search" class="form-label">Search</label>
                                    <input class="input" type="search" id="social-search" placeholder="Search text or #tags" autocomplete="off">
                                    <div class="cz-text" id="social-active-filter" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">
                                        Showing full feed
                                    </div>
                                </div>

                                <div style="margin-top: 10px;">
                                    <div class="cz-label" style="margin-bottom: 6px;">Trending tags</div>
                                    <div id="social-trending-tags" style="display: flex; gap: 6px; flex-wrap: wrap; color: var(--text-muted); font-size: 0.9rem;">
                                        Warming up...
                                    </div>
                                </div>
                            </section>
                        </div>

                        <section class="panel" id="social-feed-shell">
                            <div class="social-action-bar" style="margin-bottom: 8px;">
                                <div class="social-meta-line">
                                    <span class="cz-label">Live feed</span>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button class="btn" type="button" onclick="app.filterSocialFeed()"><i class="fas fa-filter"></i> Apply</button>
                                    <button class="btn" type="button" onclick="app.sortSocialFeed()"><i class="fas fa-sort-amount-down"></i> Resort</button>
                                </div>
                            </div>
                            <div id="social-feed-content" class="social-feed-grid">
                                ${this.renderSocialSkeleton(3)}
                            </div>
                        </section>
                    `;
                    const postForm = document.getElementById('social-post-form');
                    if (postForm) {
                        postForm.addEventListener('submit', (e) => this.handleSocialPostSubmit(e));
                    }
                    const searchInput = document.getElementById('social-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', () => this.searchSocialFeed());
                    }
                    const refreshBtn = document.getElementById('social-refresh-btn');
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', () => this.loadSocialFeed(true));
                    }
                    this.bindSocialComposer();
                    this.loadSocialFeed();
                }
            }

            renderSocialSkeleton(count = 3) {
                return Array.from({ length: count }).map(() => `
                    <div class="social-skeleton" aria-hidden="true">
                        <div class="skeleton-row">
                            <div class="skeleton-avatar"></div>
                            <div>
                                <div class="skeleton-line" style="width: 60%;"></div>
                                <div class="skeleton-line" style="width: 40%; margin-top: 6px;"></div>
                            </div>
                        </div>
                        <div class="skeleton-line" style="width: 100%; height: 14px; margin-top: 10px;"></div>
                        <div class="skeleton-line" style="width: 80%; height: 14px;"></div>
                    </div>
                `).join('');
            }

            bindSocialComposer() {
                const textarea = document.getElementById('social-post-input');
                const counter = document.getElementById('social-char-count');
                const submitBtn = document.getElementById('social-post-submit');
                if (!textarea) return;

                const update = () => {
                    const length = textarea.value.trim().length;
                    if (counter) counter.textContent = `${length}/500`;
                    if (submitBtn) submitBtn.disabled = length === 0 || length > 500;
                    textarea.classList.toggle('input-warning', length > 440);
                };

                textarea.addEventListener('input', update);
                update();
            }

            searchSocialFeed() {
                const searchInput = document.getElementById('social-search');
                this.socialSearchTerm = (searchInput?.value || '').trim().toLowerCase();
                this.filterSocialFeed();
                this.updateActiveFilterMessage();
            }

            applyTagFilter(tag) {
                if (!tag) return;
                const normalized = tag.startsWith('#') ? tag : `#${tag}`;
                const searchInput = document.getElementById('social-search');
                if (searchInput) searchInput.value = normalized;
                this.socialSearchTerm = normalized.toLowerCase();
                this.filterSocialFeed();
                this.updateActiveFilterMessage();
            }

            updateActiveFilterMessage() {
                const msg = document.getElementById('social-active-filter');
                if (!msg) return;
                msg.textContent = this.socialSearchTerm
                    ? `Filtering feed by ${this.socialSearchTerm}`
                    : 'Showing full feed';
            }

            updateSocialMeta(items = []) {
                const postCountEl = document.getElementById('social-post-count');
                const followingEl = document.getElementById('social-following-count');
                const authorsEl = document.getElementById('social-authors-count');
                if (postCountEl) postCountEl.textContent = items.length;
                if (followingEl) followingEl.textContent = this.followingIds?.length || 0;
                const authors = Array.from(new Set(items.map(item => item.createdBy).filter(Boolean)));
                if (authorsEl) authorsEl.textContent = authors.length;
                this.renderTrendingTags(items);
            }

            renderTrendingTags(items = []) {
                const container = document.getElementById('social-trending-tags');
                if (!container) return;

                const tagCounts = {};
                items.forEach(item => {
                    (item.tags || []).forEach(tag => {
                        const key = (tag || '').toLowerCase();
                        if (!key) return;
                        tagCounts[key] = (tagCounts[key] || 0) + 1;
                    });
                });

                const top = Object.entries(tagCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6);

                if (!top.length) {
                    container.innerHTML = '<span style="color: var(--text-muted);">Tag something to trend it.</span>';
                    return;
                }

                container.innerHTML = top.map(([tag, count]) => `
                    <button class="social-chip light social-tag-btn" data-tag="${this.escapeHtml(tag)}" type="button">
                        #${this.escapeHtml(tag)} <span style="color: var(--text-muted); font-size: 0.8rem;">${count}</span>
                    </button>
                `).join('');

                container.querySelectorAll('.social-tag-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.applyTagFilter(btn.dataset.tag || ''));
                });
            }

            updateSocialRefreshTime() {
                const el = document.getElementById('social-last-updated');
                if (el) {
                    el.textContent = this.lastSocialRefresh
                        ? `Updated ${this.timeAgo(this.lastSocialRefresh)}`
                        : 'Waiting for sync...';
                }
            }

            async loadSocialFeed() {
                const container = document.getElementById('social-feed-content');
                if (!container) return;

                const composePanel = document.getElementById('social-compose-panel');

                if (!this.currentUser) {
                    if (composePanel) composePanel.style.display = 'none';
                    container.innerHTML = `
                        <div style="text-align: center; padding: 48px;">
                            <i class="fas fa-user-lock" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 16px; display: block;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 12px;">Sign In Required</h3>
                            <p style="color: var(--text-muted); margin-bottom: 20px;">Sign in to see your social feed and connect with other explorers</p>
                            <button class="btn btn-primary" onclick="app.handleAuth()">
                                <i class="fas fa-sign-in-alt"></i> Sign In Now
                            </button>
                        </div>
                    `;
                    return;
                }

                if (composePanel) composePanel.style.display = '';

                try {
                    container.innerHTML = this.renderSocialSkeleton(4);

                    const followedSnapshot = await this.db.collection('user_followers')
                        .where('followerId', '==', this.currentUser.uid)
                        .get();

                    this.followingIds = followedSnapshot.docs.map(doc => doc.data().followingId);
                    const authorIds = Array.from(new Set([this.currentUser.uid, ...this.followingIds])).slice(0, 30);

                    const postPromises = [];
                    if (authorIds.length) {
                        for (let i = 0; i < authorIds.length; i += 10) {
                            const chunk = authorIds.slice(i, i + 10);
                            postPromises.push(
                                this.db.collection('forum')
                                    .where('createdBy', 'in', chunk)
                                    .orderBy('createdAt', 'desc')
                                    .limit(30)
                                    .get()
                            );
                        }
                    } else {
                        postPromises.push(
                            this.db.collection('forum')
                                .orderBy('createdAt', 'desc')
                                .limit(30)
                                .get()
                        );
                    }

                    const postSnapshots = await Promise.all(postPromises);
                    const dedup = new Map();
                    postSnapshots.forEach(snapshot => {
                        snapshot.forEach(doc => {
                            const data = { id: doc.id, type: doc.data().type || 'post', ...doc.data() };
                            dedup.set(doc.id, data);
                        });
                    });
                    const posts = Array.from(dedup.values());

                    const uniqueAuthors = Array.from(new Set(posts.map(p => p.createdBy).filter(Boolean)));
                    await Promise.all(uniqueAuthors.map(id => this.getUserProfile(id)));

                    posts.sort((a, b) => {
                        const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : a.createdAt;
                        const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : b.createdAt;
                        return (bTime || 0) - (aTime || 0);
                    });

                    this.socialFeedItems = posts;
                    this.lastSocialRefresh = new Date();
                    this.updateSocialMeta(posts);
                    this.updateSocialRefreshTime();
                    this.renderSocialFeed(this.applySocialFilters(this.socialFeedItems));
                    await this.hydrateSocialEngagement(this.socialFeedItems);
                } catch (error) {
                    console.error('Error loading social feed:', error);
                    this.socialFeedItems = [];
                    container.innerHTML = '<div class="error">Failed to load social feed</div>';
                    this.updateSocialRefreshTime();
                }
            }

            renderSocialFeed(activities) {
                const container = document.getElementById('social-feed-content');
                if (!container) return;

                if (activities.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 48px; color: var(--text-muted);">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                            <p>No social activity yet. Follow other explorers or post your first update.</p>
                            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="app.createNewPost()"><i class="fas fa-plus"></i> Post update</button>
                                <button class="btn" onclick="app.showView('map')">Start Exploring</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = activities.map(activity => {
                    const author = this.userProfiles.get(activity.createdBy) || {};
                    const displayName = this.escapeHtml(author.displayName || `Explorer ${activity.createdBy?.substring(0, 6) || ''}`);
                    const timestamp = activity.createdAt?.toDate ? activity.createdAt.toDate() : activity.createdAt;
                    const likeCount = activity.likesCount ?? 0;
                    const commentCount = activity.commentCount ?? 0;
                    const liked = this.postLikeState.get(activity.id);
                    const isFollowing = (this.followingIds || []).includes(activity.createdBy);
                    const isOwnPost = activity.createdBy === this.currentUser?.uid;
                    const tagList = (activity.tags || []).slice(0, 6);

                    return `
                        <article class="social-card" id="social-item-${activity.id}">
                            <header class="social-card-header">
                                <div class="social-author">
                                    <div class="activity-icon" style="width: 44px; height: 44px;">
                                        ${author.photoURL
                                            ? `<img src="${this.escapeHtml(author.photoURL)}" alt="${displayName}">`
                                            : `<i class="fas fa-user-astronaut"></i>`}
                                    </div>
                                    <div>
                                        <div style="font-weight: 800; color: var(--cz-yellow);">${displayName}</div>
                                        <div class="social-meta-line">
                                            <span>${this.timeAgo(timestamp)}</span>
                                            <span class="social-chip light">${activity.locationId ? 'Location intel' : 'Broadcast'}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="social-chip">${activity.tags?.length ? `#${this.escapeHtml(activity.tags[0])}` : 'Feed'}</div>
                            </header>
                            <div class="social-post-body">${this.escapeHtml(activity.body || activity.message || '')}</div>
                            ${tagList.length ? `
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                                    ${tagList.map(tag => `
                                        <button type="button" class="social-chip light social-tag-btn" data-tag="${this.escapeHtml(tag)}">
                                            #${this.escapeHtml(tag)}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${activity.locationId ? `
                                <div style="margin: 10px 0 6px 0;">
                                    <button class="social-btn checked-in" onclick="app.viewPostLocation('${activity.id}','${activity.locationId}')">
                                        <i class="fas fa-map-marker-alt"></i> View related location
                                    </button>
                                </div>
                            ` : ''}
                            <div class="social-action-bar">
                                <div class="social-meta-line">
                                    <span><i class="fas fa-heart"></i> <span id="post-like-count-${activity.id}">${likeCount}</span></span>
                                    <span><i class="fas fa-comment-dots"></i> <span id="post-comment-count-${activity.id}">${commentCount}</span></span>
                                </div>
                                <div class="social-action-buttons">
                                    <button class="social-btn ${liked ? 'liked' : ''}" id="post-like-${activity.id}" onclick="app.togglePostLike('${activity.id}')">
                                        <i class="fas fa-heart"></i> ${liked ? 'Liked' : 'Like'}
                                    </button>
                                    <button class="social-btn" onclick="app.togglePostComments('${activity.id}')">
                                        <i class="fas fa-comment-dots"></i> Comments
                                    </button>
                                    <button class="social-btn ${isFollowing ? 'following' : ''}" data-follow-target="${activity.createdBy}" ${isOwnPost ? 'disabled' : ''} onclick="app.toggleFollowFromFeed('${activity.createdBy}')">
                                        <i class="fas ${isFollowing ? 'fa-user-check' : 'fa-user-plus'}"></i> ${isOwnPost ? 'You' : (isFollowing ? 'Following' : 'Follow')}
                                    </button>
                                </div>
                            </div>
                            <div id="post-comments-${activity.id}" style="margin-top: 10px; display: none;">
                                <div id="post-comments-list-${activity.id}" class="loading">Loading comments...</div>
                                <div style="margin-top: 8px;">
                                    <textarea class="textarea" id="post-comment-input-${activity.id}" rows="2" placeholder="Add a comment..."></textarea>
                                    <button class="btn btn-primary" style="margin-top: 6px;" onclick="app.submitPostComment('${activity.id}')">
                                        <i class="fas fa-paper-plane"></i> Comment
                                    </button>
                                </div>
                            </div>
                        </article>
                    `;
                }).join('');

                container.querySelectorAll('.social-tag-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.applyTagFilter(btn.dataset.tag || ''));
                });
            }

            applySocialFilters(source = []) {
                const filter = document.getElementById('social-filter')?.value || 'all';
                const sort = document.getElementById('sort-feed')?.value || 'recent';

                let items = [...source];

                if (filter !== 'all') {
                    items = items.filter(item => {
                        if (filter === 'following') {
                            return (this.followingIds || []).includes(item.createdBy);
                        }
                        if (filter === 'location-updates') return Boolean(item.locationId);
                        if (filter === 'social') return !item.locationId;
                        if (filter === 'achievements') return item.type === 'achievement';
                        return true;
                    });
                }

                const term = (this.socialSearchTerm || '').trim().toLowerCase();
                if (term) {
                    items = items.filter(item => {
                        const text = `${item.body || item.message || ''}`.toLowerCase();
                        const author = (this.userProfiles.get(item.createdBy)?.displayName || '').toLowerCase();
                        const tags = (item.tags || []).join(' ').toLowerCase();
                        return text.includes(term) || tags.includes(term.replace('#', '')) || author.includes(term);
                    });
                }

                items.sort((a, b) => {
                    const aLikes = a.likesCount ?? 0;
                    const bLikes = b.likesCount ?? 0;
                    const aComments = a.commentCount ?? 0;
                    const bComments = b.commentCount ?? 0;

                    if (sort === 'popular') return bLikes - aLikes;
                    if (sort === 'engagement') return (bLikes + bComments) - (aLikes + aComments);

                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : a.createdAt;
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : b.createdAt;
                    return (bTime || 0) - (aTime || 0);
                });

                return items;
            }

            // Social interactions and feedback
            async followUser(userId) {
                if (!this.currentUser) {
                    this.showToast('Please sign in to follow users', 'warning');
                    return;
                }

                const opKey = `follow-${userId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('user_followers').add({
                        followerId: this.currentUser.uid,
                        followingId: userId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    await this.createNotification(userId, 'follow', {
                        message: 'Someone started following you',
                        fromUserId: this.currentUser.uid
                    });

                    this.showToast('User followed successfully', 'success');
                } catch (error) {
                    console.error('Error following user:', error);
                    this.showToast('Failed to follow user', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async toggleFollowFromFeed(userId) {
                if (!this.currentUser) {
                    this.showToast('Please sign in to follow users', 'warning');
                    this.handleAuth();
                    return;
                }

                if (userId === this.currentUser.uid) {
                    this.showToast('That is your post', 'info');
                    return;
                }

                const isFollowing = (this.followingIds || []).includes(userId);

                if (isFollowing) {
                    await this.unfollowUser(userId);
                    this.followingIds = (this.followingIds || []).filter(id => id !== userId);
                    this.updateFollowButtons(userId, false);
                } else {
                    await this.followUser(userId);
                    this.followingIds = Array.from(new Set([...(this.followingIds || []), userId]));
                    this.updateFollowButtons(userId, true);
                }

                this.updateSocialMeta(this.socialFeedItems || []);
            }

            updateFollowButtons(userId, isFollowing) {
                document.querySelectorAll(`[data-follow-target="${userId}"]`).forEach(btn => {
                    btn.classList.toggle('following', isFollowing);
                    btn.innerHTML = `<i class="fas ${isFollowing ? 'fa-user-check' : 'fa-user-plus'}"></i> ${isFollowing ? 'Following' : 'Follow'}`;
                    btn.setAttribute('aria-label', isFollowing ? 'Unfollow explorer' : 'Follow explorer');
                });
            }

            async unfollowUser(userId) {
                if (!this.currentUser) return;

                const opKey = `unfollow-${userId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    const query = await this.db.collection('user_followers')
                        .where('followerId', '==', this.currentUser.uid)
                        .where('followingId', '==', userId)
                        .get();

                    query.forEach(doc => doc.ref.delete());
                    this.showToast('User unfollowed', 'success');
                } catch (error) {
                    console.error('Error unfollowing user:', error);
                    this.showToast('Failed to unfollow user', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async likeLocation(locationId) {
                if (!this.currentUser) {
                    this.showToast('Please sign in to like locations', 'warning');
                    return;
                }

                const opKey = `like-${locationId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('location_likes').add({
                        userId: this.currentUser.uid,
                        locationId: locationId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    const locationDoc = await this.db.collection('locations').doc(locationId).get();
                    if (locationDoc.exists && locationDoc.data().createdBy !== this.currentUser.uid) {
                        await this.createNotification(locationDoc.data().createdBy, 'like', {
                            message: 'Someone liked your location',
                            locationId: locationId,
                            fromUserId: this.currentUser.uid
                        });
                    }

                    this.showToast('Location liked!', 'success');
                } catch (error) {
                    console.error('Error liking location:', error);
                    this.showToast('Failed to like location', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async unlikeLocation(locationId) {
                if (!this.currentUser) return;

                const opKey = `unlike-${locationId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    const query = await this.db.collection('location_likes')
                        .where('userId', '==', this.currentUser.uid)
                        .where('locationId', '==', locationId)
                        .get();

                    query.forEach(doc => doc.ref.delete());
                    this.showToast('Location unliked', 'success');
                } catch (error) {
                    console.error('Error unliking location:', error);
                    this.showToast('Failed to unlike location', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async rateLocation(locationId, value) {
                if (!this.currentUser) {
                    this.showToast('Please sign in to rate locations', 'warning');
                    return;
                }

                if (![1, -1].includes(value)) return;

                const opKey = `rate-${locationId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    const docId = `${this.currentUser.uid}_${locationId}`;
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    await this.db.collection('location_ratings').doc(docId).set({
                        userId: this.currentUser.uid,
                        locationId,
                        value,
                        updatedAt: timestamp,
                        createdAt: timestamp
                    }, { merge: true });

                    await this.loadLocationRating(locationId);
                    this.showToast(value === 1 ? 'Upvoted location' : 'Downvoted location', 'success');
                } catch (error) {
                    console.error('Error rating location:', error);
                    this.showToast('Failed to update rating', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async loadLocationRating(locationId) {
                try {
                    const snapshot = await this.db.collection('location_ratings')
                        .where('locationId', '==', locationId)
                        .get();

                    let score = 0;
                    let userVote = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const val = data.value === -1 ? -1 : 1;
                        score += val;
                        if (data.userId === this.currentUser?.uid) {
                            userVote = val;
                        }
                    });

                    this.ratings.set(locationId, { score, userVote });
                    this.updateRatingUI(locationId, score, userVote);
                } catch (error) {
                    console.error('Error loading rating:', error);
                }
            }

            updateRatingUI(locationId, score = null, userVote = null) {
                const data = this.ratings.get(locationId) || {};
                const displayScore = score ?? data.score ?? 0;
                const displayVote = userVote ?? data.userVote ?? 0;

                const scoreEl = document.getElementById(`rating-score-${locationId}`);
                if (scoreEl) scoreEl.textContent = typeof displayScore === 'number' ? displayScore : '--';

                const upBtn = document.getElementById(`rate-up-${locationId}`);
                const downBtn = document.getElementById(`rate-down-${locationId}`);
                if (upBtn) upBtn.classList.toggle('liked', displayVote === 1);
                if (downBtn) downBtn.classList.toggle('disliked', displayVote === -1);
            }

            async addComment(locationId, commentText) {
                if (!this.currentUser) {
                    this.showToast('Please sign in to add comments', 'warning');
                    return;
                }

                if (!commentText || !commentText.trim()) {
                    this.showToast('Please enter a comment', 'warning');
                    return;
                }

                const opKey = `comment-${locationId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('location_comments').add({
                        userId: this.currentUser.uid,
                        locationId: locationId,
                        text: this.sanitizeInput(commentText.trim()),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        flagged: false
                    });

                    const locationDoc = await this.db.collection('locations').doc(locationId).get();
                    if (locationDoc.exists && locationDoc.data().createdBy !== this.currentUser.uid) {
                        await this.createNotification(locationDoc.data().createdBy, 'comment', {
                            message: 'Someone commented on your location',
                            locationId: locationId,
                            fromUserId: this.currentUser.uid
                        });
                    }

                    this.showToast('Comment added!', 'success');
                    this.loadLocationComments(locationId);
                } catch (error) {
                    console.error('Error adding comment:', error);
                    this.showToast('Failed to add comment', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async loadLocationComments(locationId) {
                try {
                    const snapshot = await this.db.collection('location_comments')
                        .where('locationId', '==', locationId)
                        .where('flagged', '==', false)
                        .orderBy('createdAt', 'desc')
                        .get();

                    const comments = [];
                    snapshot.forEach(doc => {
                        comments.push({ id: doc.id, ...doc.data() });
                    });

                    return comments;
                } catch (error) {
                    console.error('Error loading comments:', error);
                    return [];
                }
            }

            async checkInLocation(locationId, photoUrl = null) {
                if (!this.currentUser) {
                    this.showToast('Please sign in to check in', 'warning');
                    return;
                }

                const opKey = `checkin-${locationId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('location_visits').add({
                        userId: this.currentUser.uid,
                        locationId: locationId,
                        checkInAt: firebase.firestore.FieldValue.serverTimestamp(),
                        photoUrl: photoUrl
                    });

                    await this.updateUserBadges(this.currentUser.uid, 'visit');
                    this.showToast('Successfully checked in!', 'success');
                } catch (error) {
                    console.error('Error checking in:', error);
                    this.showToast('Failed to check in', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async createNotification(userId, type, data) {
                try {
                    await this.db.collection('user_notifications').add({
                        userId: userId,
                        type: type,
                        data: data,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error creating notification:', error);
                }
            }

            async loadNotifications() {
                const container = document.getElementById('notifications-content');
                if (!container) return;

                if (!this.currentUser) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 32px;">
                            <i class="fas fa-bell-slash" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 12px;"></i>
                            <p style="color: var(--text-secondary); margin-bottom: 12px;">Sign in to see alerts for check-ins, followers, and mission progress.</p>
                            <button class="btn btn-primary" onclick="app.handleAuth()"><i class="fas fa-sign-in-alt"></i> Sign In</button>
                        </div>
                    `;
                    return;
                }

                try {
                    const snapshot = await this.db.collection('user_notifications')
                        .where('userId', '==', this.currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(20)
                        .get();

                    this.notifications = [];
                    this.unreadNotifications = 0;

                    snapshot.forEach(doc => {
                        const notification = { id: doc.id, ...doc.data() };
                        this.notifications.push(notification);
                        if (!notification.read) this.unreadNotifications++;
                    });

                    this.updateNotificationBadge();
                    this.renderNotifications(this.notifications.length ? this.notifications : this.getSampleNotifications());
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    this.renderNotifications(this.getSampleNotifications());
                }
            }

            async markNotificationAsRead(notificationId) {
                if (!this.currentUser || !this.db) return;
                try {
                    await this.db.collection('user_notifications').doc(notificationId).update({
                        read: true
                    });
                    this.unreadNotifications = Math.max(0, this.unreadNotifications - 1);
                    this.updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            updateNotificationBadge() {
                const profileBtn = document.getElementById('profile-btn');
                if (!profileBtn) return;

                const existingBadge = profileBtn.querySelector('.notification-badge');
                if (this.unreadNotifications > 0) {
                    if (!existingBadge) {
                        const badge = document.createElement('span');
                        badge.className = 'notification-badge';
                        badge.textContent = this.unreadNotifications;
                        badge.style.cssText = `
                            position: absolute;
                            top: -5px;
                            right: -5px;
                            background: var(--cz-red);
                            color: white;
                            border-radius: 50%;
                            width: 18px;
                            height: 18px;
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            border: 2px solid var(--cz-black);
                        `;
                        profileBtn.style.position = 'relative';
                        profileBtn.appendChild(badge);
                    } else {
                        existingBadge.textContent = this.unreadNotifications;
                    }
                } else if (existingBadge) {
                    existingBadge.remove();
                }
            }

            renderNotifications(notifications) {
                const container = document.getElementById('notifications-content');
                if (!container) return;

                if (!notifications || !notifications.length) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No alerts yet.</p>';
                    return;
                }

                container.innerHTML = notifications.map(note => {
                    const clickable = this.currentUser && !note.sample;
                    return `
                    <div class="notification-item ${note.read ? '' : 'unread'}" ${clickable ? `onclick="app.markNotificationAsRead('${note.id}')"` : ''}>
                        <div class="notification-type">${(note.type || 'update').toUpperCase()}</div>
                        <div class="notification-message">${this.escapeHtml(note.data?.message || 'Activity update')}</div>
                        <div class="notification-time">${this.timeAgo(note.createdAt?.toDate ? note.createdAt.toDate() : note.createdAt)}</div>
                    </div>
                `}).join('');
            }

            getSampleNotifications() {
                const now = Date.now();
                return [
                    { id: 'n1', sample: true, type: 'follow', data: { message: 'Rae Night started following you.' }, read: false, createdAt: new Date(now - 15 * 60 * 1000) },
                    { id: 'n2', sample: true, type: 'comment', data: { message: 'New comment on Old Metro Tunnels.' }, read: false, createdAt: new Date(now - 45 * 60 * 1000) },
                    { id: 'n3', sample: true, type: 'mission', data: { message: 'Mission Rooftop Recon is 50% complete.' }, read: true, createdAt: new Date(now - 2 * 60 * 60 * 1000) }
                ];
            }

            async updateUserBadges(userId, action) {
                try {
                    const badgeActions = {
                        'visit': ['first_visit', 'explorer_10', 'explorer_50'],
                        'location_add': ['first_location', 'mapper_10', 'mapper_50'],
                        'comment': ['social_butterfly', 'commentator_10'],
                        'like': ['appreciator', 'liker_25']
                    };

                    const potentialBadges = badgeActions[action] || [];

                    for (const badge of potentialBadges) {
                        await this.awardBadge(userId, badge);
                    }
                } catch (error) {
                    console.error('Error updating user badges:', error);
                }
            }

            async awardBadge(userId, badgeId) {
                try {
                    await this.db.collection('user_badges').add({
                        userId: userId,
                        badgeId: badgeId,
                        earnedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error awarding badge:', error);
                }
            }

            showLocationDetailModal(locationId, locationData) {
                const modal = document.createElement('div');
                modal.className = 'modal location-detail-modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                        
                        <div class="location-detail-header">
                            <h3>${this.escapeHtml(locationData.name)}</h3>
                            <div class="location-detail-meta">
                                <span class="meta-item">
                                    <i class="fas fa-tag"></i> ${this.escapeHtml(locationData.category)}
                                </span>
                                <span class="meta-item">
                                    <i class="fas fa-exclamation-triangle"></i> ${this.escapeHtml(locationData.riskLevel)}
                                </span>
                                <span class="meta-item">
                                    <i class="fas fa-clock"></i> ${this.timeAgo(locationData.createdAt?.toDate())}
                                </span>
                            </div>
                        </div>

                        <div class="location-description">
                            <p>${this.escapeHtml(locationData.description)}</p>
                        </div>

                        ${locationData.address ? `
                            <div class="location-address">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${this.escapeHtml(locationData.address)}</span>
                            </div>
                        ` : ''}

                        <div class="location-actions" style="margin: 16px 0; padding: 12px; background: var(--cz-concrete-light); border: 2px solid var(--cz-black);">
                            ${this.currentUser ? `
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 8px;">
                                    <button class="rating-btn" id="rate-up-${locationId}" onclick="app.rateLocation('${locationId}', 1)">
                                        <i class="fas fa-thumbs-up"></i>
                                    </button>
                                    <div class="cz-text" style="font-size: 1rem;">Score: <span id="rating-score-${locationId}">--</span></div>
                                    <button class="rating-btn" id="rate-down-${locationId}" onclick="app.rateLocation('${locationId}', -1)">
                                        <i class="fas fa-thumbs-down"></i>
                                    </button>
                                </div>
                                <button class="btn" onclick="app.likeLocation('${locationId}')" id="like-btn-${locationId}">
                                    <i class="fas fa-heart"></i> Like
                                </button>
                                <button class="btn" onclick="app.checkInLocation('${locationId}')">
                                    <i class="fas fa-check-circle"></i> Check In
                                </button>
                                <button class="btn" onclick="app.showRoutePlanningModal(['${locationId}'])">
                                    <i class="fas fa-route"></i> Add to Route
                                </button>
                            ` : `
                                <p style="color: var(--text-muted); font-size: 12px;">Sign in to like, check in, and plan routes</p>
                            `}
                        </div>

                        <div class="comments-section">
                            <h4>Comments</h4>
                            ${this.currentUser ? `
                                <div style="margin-bottom: 16px;">
                                    <textarea class="textarea" id="comment-input-${locationId}" placeholder="Add a comment..." rows="3"></textarea>
                                    <button class="btn btn-primary" onclick="app.submitComment('${locationId}')" style="margin-top: 8px;">
                                        <i class="fas fa-comment"></i> Add Comment
                                    </button>
                                </div>
                            ` : ''}
                            <div id="comments-list-${locationId}" class="loading">Loading comments...</div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                this.loadLocationComments(locationId).then(comments => {
                    this.renderComments(locationId, comments);
                });
                this.loadLocationRating(locationId);
            }

            async submitComment(locationId) {
                const input = document.getElementById(`comment-input-${locationId}`);
                if (input) {
                    await this.addComment(locationId, input.value);
                    input.value = '';
                }
            }

            renderComments(locationId, comments) {
                const container = document.getElementById(`comments-list-${locationId}`);
                if (!container) return;

                if (!comments || comments.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No comments yet. Be the first to comment!</p>';
                    return;
                }

                container.innerHTML = comments.map(comment => `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">Explorer</span>
                            <span class="comment-time">${this.timeAgo(comment.createdAt?.toDate())}</span>
                        </div>
                        <div class="comment-text">${this.escapeHtml(comment.text)}</div>
                    </div>
                `).join('');
            }

            async submitProfilePost(userId) {
                const input = document.getElementById('profile-post-input');
                if (!input) return;
                await this.addProfilePost(userId, input.value);
                input.value = '';
            }

            async addProfilePost(userId, text) {
                if (!this.currentUser) {
                    this.showToast('Sign in to post updates', 'warning');
                    return;
                }
                if (this.currentUser.uid !== userId) {
                    this.showToast('You can only post on your own profile', 'warning');
                    return;
                }
                if (!text || !text.trim()) {
                    this.showToast('Post cannot be empty', 'warning');
                    return;
                }

                const opKey = `profile-post-${userId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('forum').add({
                        type: 'post',
                        body: this.sanitizeInput(text.trim()),
                        createdBy: this.currentUser.uid,
                        targetUserId: userId,
                        targetType: 'profile',
                        source: 'profile-feed',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    this.showToast('Posted to your feed', 'success');
                    await this.loadProfilePosts(userId);
                } catch (error) {
                    console.error('Error adding profile post:', error);
                    this.showToast('Failed to post', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async loadProfilePosts(userId) {
                const container = document.getElementById('profile-posts-list');
                if (!container) return;
                container.innerHTML = '<div class="loading">Loading posts...</div>';

                try {
                    // Gather both targeted and authored posts so profile feed never misses entries and avoids composite index requirements.
                    const postsById = new Map();
                    const collect = (snapshot) => {
                        snapshot.forEach(doc => postsById.set(doc.id, { id: doc.id, ...doc.data() }));
                    };

                    const targetedSnap = await this.db.collection('forum')
                        .where('targetUserId', '==', userId)
                        .limit(50)
                        .get();
                    collect(targetedSnap);

                    const authoredSnap = await this.db.collection('forum')
                        .where('createdBy', '==', userId)
                        .limit(50)
                        .get();
                    collect(authoredSnap);

                    const posts = Array.from(postsById.values()).sort((a, b) => {
                        const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                        const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                        return bTime - aTime;
                    });

                    const authorIds = Array.from(new Set(posts.map(p => p.createdBy).filter(Boolean)));
                    await Promise.all(authorIds.map(id => this.getUserProfile(id)));

                    this.renderProfilePosts(posts);
                } catch (error) {
                    console.error('Error loading profile posts:', error);
                    container.innerHTML = '<div class="error">Failed to load posts</div>';
                }
            }

            renderProfilePosts(posts) {
                const container = document.getElementById('profile-posts-list');
                if (!container) return;

                if (!posts.length) {
                    container.innerHTML = '<div style="color: var(--text-muted);">No posts yet.</div>';
                    return;
                }

                container.innerHTML = posts.map(post => `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${this.escapeHtml(this.userProfiles.get(post.createdBy)?.displayName || 'Update')}</span>
                            <span class="comment-time">${this.timeAgo(post.createdAt?.toDate())}</span>
                        </div>
                        <div class="comment-text">${this.escapeHtml(post.body || post.text || '')}</div>
                    </div>
                `).join('');
            }

            async submitProfileComment(targetUserId) {
                const input = document.getElementById('profile-comment-input');
                const button = document.querySelector(`button[onclick="app.submitProfileComment('${targetUserId}')"]`);
                if (!input || !button) return;

                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
                button.disabled = true;

                try {
                    await this.addProfileComment(targetUserId, input.value);
                    input.value = '';
                    this.updateCommentCounters();
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }

            async addProfileComment(targetUserId, text) {
                if (!this.currentUser) {
                    this.showToast('Sign in to comment', 'warning');
                    return;
                }
                if (!text || !text.trim()) {
                    this.showToast('Comment cannot be empty', 'warning');
                    return;
                }
                if (text.trim().length < 2) {
                    this.showToast('Comment must be at least 2 characters long', 'warning');
                    return;
                }

                const opKey = `profile-comment-${targetUserId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('comments').add({
                        targetId: targetUserId,
                        targetType: 'profile',
                        createdBy: this.currentUser.uid,
                        text: this.sanitizeInput(text.trim()),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    this.showToast('Comment added', 'success');
                    this.loadProfileComments(targetUserId);
                } catch (error) {
                    console.error('Error adding profile comment:', error);
                    this.showToast('Failed to add comment', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async loadProfileComments(targetUserId) {
                const container = document.getElementById('profile-comments-list');
                if (!container) return;
                container.innerHTML = '<div class="loading">Loading comments...</div>';

                try {
                    const snapshot = await this.db.collection('comments')
                        .where('targetId', '==', targetUserId)
                        .where('targetType', '==', 'profile')
                        .orderBy('createdAt', 'desc')
                        .limit(25)
                        .get();

                    const comments = [];
                    const authors = new Set();
                    snapshot.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        comments.push(data);
                        if (data.createdBy) authors.add(data.createdBy);
                    });
                    await Promise.all(Array.from(authors).map(id => this.getUserProfile(id)));
                    this.renderProfileComments(comments);
                } catch (error) {
                    console.error('Error loading profile comments:', error);
                    container.innerHTML = '<div class="error">Failed to load comments</div>';
                }
            }

            renderProfileComments(comments) {
                const container = document.getElementById('profile-comments-list');
                if (!container) return;

                if (!comments.length) {
                    container.innerHTML = '<div style="color: var(--text-muted);">No comments yet.</div>';
                    return;
                }

                container.innerHTML = comments.map(comment => `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${this.escapeHtml(comment.createdBy === this.currentUser?.uid ? 'You' : (this.userProfiles.get(comment.createdBy)?.displayName || 'Explorer'))}</span>
                            <span class="comment-time">${this.timeAgo(comment.createdAt?.toDate())}</span>
                        </div>
                        <div class="comment-text">${this.escapeHtml(comment.text)}</div>
                    </div>
                `).join('');
            }

            showMissions() {
                const view = document.getElementById('missions-view-content');
                if (view) {
                    view.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h2>Missions & Challenges</h2>
                            <button class="btn" onclick="app.showView('map')">
                                <i class="fas fa-map"></i> Back to Map
                            </button>
                        </div>

                        <div class="panel" style="margin-bottom: 24px;">
                            <h3>Available Missions</h3>
                            <div id="missions-grid">
                                <div class="loading">Loading missions...</div>
                            </div>
                        </div>

                        <div class="panel">
                            <h3>Your Progress</h3>
                            <div id="mission-progress">
                                <div class="loading">Loading progress...</div>
                            </div>
                        </div>
                    `;

                    this.loadMissions();
                }
            }

            async loadMissions() {
                try {
                    const snapshot = await this.db.collection('missions').get();
                    const missions = [];
                    
                    snapshot.forEach(doc => {
                        missions.push({ id: doc.id, ...doc.data() });
                    });

                    const items = missions.length ? missions : this.getSampleMissions();
                    this.renderMissions(items);
                    this.renderMissionProgress(items);
                } catch (error) {
                    console.error('Error loading missions:', error);
                    const fallback = this.getSampleMissions();
                    this.renderMissions(fallback);
                    this.renderMissionProgress(fallback);
                }
            }

            renderMissions(missions) {
                const container = document.getElementById('missions-grid');
                if (!container) return;

                container.innerHTML = missions.map(mission => `
                    <div class="mission-card">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: var(--cz-yellow);">${this.escapeHtml(mission.title)}</h4>
                                <p style="margin: 0; color: var(--text-secondary);">${this.escapeHtml(mission.description)}</p>
                            </div>
                            <div class="badge difficulty-badge" style="background: var(--cz-${mission.difficulty === 'easy' ? 'green' : mission.difficulty === 'medium' ? 'orange' : 'red'}); color: white;">
                                ${mission.difficulty}
                            </div>
                        </div>
                        
                        <div class="mission-progress">
                            <div class="mission-progress-fill" style="width: ${mission.progress || 0}%"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: between; align-items: center; margin-top: 8px;">
                            <span style="font-size: 0.9rem; color: var(--text-muted);">
                                ${mission.progress || 0}% complete
                            </span>
                            <button class="btn btn-primary" onclick="app.startMission('${mission.id}')">
                                ${mission.progress > 0 ? 'Continue' : 'Start'} Mission
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderMissionProgress(missions) {
                const container = document.getElementById('mission-progress');
                if (!container) return;

                const completed = missions.filter(m => (m.progress || 0) >= 100).length;
                const inProgress = missions.filter(m => (m.progress || 0) > 0 && (m.progress || 0) < 100).length;
                const notStarted = missions.length - completed - inProgress;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                        <div class="panel" style="padding: 12px; box-shadow: none; border-width: 2px;">
                            <div class="mac-label">Completed</div>
                            <div class="mac-title" style="font-size: 20px; color: var(--success);">${completed}</div>
                        </div>
                        <div class="panel" style="padding: 12px; box-shadow: none; border-width: 2px;">
                            <div class="mac-label">In Progress</div>
                            <div class="mac-title" style="font-size: 20px; color: var(--accent-yellow);">${inProgress}</div>
                        </div>
                        <div class="panel" style="padding: 12px; box-shadow: none; border-width: 2px;">
                            <div class="mac-label">Queued</div>
                            <div class="mac-title" style="font-size: 20px; color: var(--text-secondary);">${notStarted}</div>
                        </div>
                    </div>
                `;
            }

            getSampleMissions() {
                return [
                    { id: 'mission-a', title: 'Rooftop Recon', description: 'Scout three rooftops and log safe access points.', difficulty: 'medium', progress: 65 },
                    { id: 'mission-b', title: 'Tunnel Drift', description: 'Chart a path through the river tunnels without GPS.', difficulty: 'hard', progress: 20 },
                    { id: 'mission-c', title: 'Hidden Courtyard', description: 'Find and photograph two hidden courtyards in the old district.', difficulty: 'easy', progress: 90 }
                ];
            }

            async loadRoutes() {
                const container = document.getElementById('routes-content');
                if (!container) return;

                let routes = [];

                if (this.currentUser) {
                    try {
                        const snapshot = await this.db.collection('routes')
                            .where('userId', '==', this.currentUser.uid)
                            .orderBy('updatedAt', 'desc')
                            .limit(10)
                            .get();

                        snapshot.forEach(doc => {
                            routes.push({ id: doc.id, ...doc.data() });
                        });
                    } catch (error) {
                        console.error('Error loading routes:', error);
                    }
                }

                if (!routes.length) {
                    routes = this.getSampleRoutes();
                }

                this.renderRoutes(routes);
            }

            renderRoutes(routes) {
                const container = document.getElementById('routes-content');
                if (!container) return;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;">
                        ${routes.map(route => `
                            <div class="route-card">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                                    <div>
                                        <h4 style="margin: 0 0 6px 0; color: var(--cz-yellow);">${this.escapeHtml(route.name)}</h4>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary);">${route.stops?.length || 0} stops  ${route.distance || 'Unknown'} km</div>
                                    </div>
                                    <div class="badge" style="background: var(--cz-blueprint); color: white;">${route.mode || 'Walk'}</div>
                                </div>
                                <div class="route-map-preview">
                                    <div style="position: absolute; inset: 0; display: grid; place-items: center; color: var(--text-muted); font-size: 0.9rem;">
                                        Mini map preview
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${(route.tags || []).map(tag => `<span class="tag">${this.escapeHtml(tag)}</span>`).join('')}
                                </div>
                                <div class="social-action-buttons">
                                    <button class="social-btn" onclick="app.startRoute('${route.id}')"><i class="fas fa-play"></i> Start</button>
                                    <button class="social-btn" onclick="app.shareRoute('${route.id}')"><i class="fas fa-share-alt"></i> Share</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            getSampleRoutes() {
                return [
                    { id: 'route-a', name: 'Skyline Sweep', distance: 4.2, mode: 'Walk', stops: ['Old Metro', 'Sky Deck', 'River Bridge'], tags: ['rooftop', 'photography'] },
                    { id: 'route-b', name: 'Underground Drift', distance: 3.1, mode: 'Explore', stops: ['Service Tunnel', 'Valve Room', 'Sub-basement'], tags: ['tunnel', 'flashlight'] },
                    { id: 'route-c', name: 'Neon Loop', distance: 6.0, mode: 'Bike', stops: ['Arcade Plaza', 'Canal Walk', 'Glass Overlook'], tags: ['night', 'urban'] }
                ];
            }

            async loadGroups() {
                const container = document.getElementById('groups-content');
                if (!container) return;

                if (!this.currentUser) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 36px;">
                            <i class="fas fa-user-friends" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 12px;"></i>
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">Sign in to join crews, share intel, and coordinate runs.</p>
                            <button class="btn btn-primary" onclick="app.handleAuth()"><i class="fas fa-sign-in-alt"></i> Sign In</button>
                        </div>
                    `;
                    return;
                }

                let groups = [];

                try {
                    const snapshot = await this.db.collection('groups')
                        .where('members', 'array-contains', this.currentUser.uid)
                        .limit(10)
                        .get();

                    snapshot.forEach(doc => {
                        groups.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    console.error('Error loading groups:', error);
                }

                if (!groups.length) {
                    groups = this.getSampleGroups();
                }

                this.renderGroups(groups);
            }

            renderGroups(groups) {
                const container = document.getElementById('groups-content');
                if (!container) return;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;">
                        ${groups.map(group => `
                            <div class="group-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: var(--cz-yellow);">${this.escapeHtml(group.name)}</h4>
                                    <span class="badge" style="background: var(--cz-concrete-dark);">${group.members?.length || 4} members</span>
                                </div>
                                <p style="margin: 0 0 8px 0; color: var(--text-secondary);">${this.escapeHtml(group.description || 'Crew of local explorers.')}</p>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                    ${(group.tags || ['night ops', 'mapping']).map(tag => `<span class="tag">${this.escapeHtml(tag)}</span>`).join('')}
                                </div>
                                <div class="social-action-buttons">
                                    <button class="social-btn" onclick="app.openGroup('${group.id}')"><i class="fas fa-door-open"></i> Open</button>
                                    <button class="social-btn" onclick="app.messageGroup('${group.id}')"><i class="fas fa-comment-dots"></i> Chat</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            getSampleGroups() {
                return [
                    { id: 'grp-a', name: 'Ghostline Collective', description: 'Night runners mapping the undercity.', members: ['a','b','c','d'], tags: ['night ops', 'tunnels'] },
                    { id: 'grp-b', name: 'Skybound', description: 'Rooftop spotters and skyline photographers.', members: ['a','b','c'], tags: ['rooftop', 'photo'] },
                    { id: 'grp-c', name: 'Canal Walkers', description: 'Explorers patrolling the canal routes and basements.', members: ['a','b','c','d','e'], tags: ['waterfront', 'basement'] }
                ];
            }

            showRoutes() {
                const view = document.getElementById('routes-view-content');
                if (view) {
                    view.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h2>Route Planning</h2>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" onclick="app.showView('map')">
                                    <i class="fas fa-map"></i> Back to Map
                                </button>
                                <button class="btn btn-primary" onclick="app.createNewRoute()">
                                    <i class="fas fa-route"></i> New Route
                                </button>
                            </div>
                        </div>

                        <div id="routes-content" class="loading">
                            Loading routes...
                        </div>
                    `;

                    this.loadRoutes();
                }
            }

            showGroups() {
                const view = document.getElementById('groups-view-content');
                if (view) {
                    view.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h2>Groups & Teams</h2>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" onclick="app.showView('map')">
                                    <i class="fas fa-map"></i> Back to Map
                                </button>
                                <button class="btn btn-primary" onclick="app.createNewGroup()">
                                    <i class="fas fa-users"></i> New Group
                                </button>
                            </div>
                        </div>

                        <div id="groups-content" class="loading">
                            Loading groups...
                        </div>
                    `;

                    this.loadGroups();
                }
            }

            showNotifications() {
                const view = document.getElementById('notifications-view-content');
                if (view) {
                    view.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h2>Notifications</h2>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" onclick="app.showView('map')">
                                    <i class="fas fa-map"></i> Back to Map
                                </button>
                                <button class="btn" onclick="app.markAllNotificationsAsRead()">
                                    <i class="fas fa-check-double"></i> Mark All Read
                                </button>
                            </div>
                        </div>

                        <div id="notifications-content" class="loading">
                            Loading notifications...
                        </div>
                    `;

                    this.loadNotifications();
                }
            }

            async markAllNotificationsAsRead() {
                if (!this.currentUser) return;

                try {
                    const snapshot = await this.db.collection('user_notifications')
                        .where('userId', '==', this.currentUser.uid)
                        .where('read', '==', false)
                        .get();

                    const batch = this.db.batch();
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });

                    await batch.commit();
                    this.unreadNotifications = 0;
                    this.updateNotificationBadge();
                    this.showNotifications(); // Refresh
                    this.showToast('All notifications marked as read', 'success');
                } catch (error) {
                    console.error('Error marking notifications as read:', error);
                    this.showToast('Failed to mark notifications as read', 'error');
                }
            }

            // Utility methods for social features
            async createNewPost() {
                // Focus the composer when called programmatically
                if (!this.currentUser) {
                    this.showToast('Sign in to post updates', 'warning');
                    this.handleAuth();
                    return;
                }
                this.showView('social');
                setTimeout(() => document.getElementById('social-post-input')?.focus(), 150);
            }

            async handleSocialPostSubmit(e) {
                e.preventDefault();

                if (!this.currentUser) {
                    this.showToast('Sign in to post updates', 'warning');
                    this.handleAuth();
                    return;
                }

                const textArea = document.getElementById('social-post-input');
                const tagsInput = document.getElementById('social-post-tags');
                const locationInput = document.getElementById('social-post-location');
                const submitBtn = document.getElementById('social-post-submit');

                const rawBody = textArea?.value || '';
                const body = this.sanitizeInput(rawBody);

                if (!body) {
                    this.showToast('Post cannot be empty', 'warning');
                    textArea?.focus();
                    return;
                }
                if (body.length > 500) {
                    this.showToast('Post is over the 500 character limit', 'warning');
                    textArea?.focus();
                    return;
                }

                const tags = (tagsInput?.value || '')
                    .split(',')
                    .map(t => this.sanitizeInput(t.trim()))
                    .filter(Boolean)
                    .slice(0, 8);

                const locationId = this.sanitizeInput(locationInput?.value?.trim() || '');

                const payload = {
                    body,
                    tags,
                    locationId: locationId || null,
                    type: 'post',
                    createdBy: this.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
                }

                try {
                    await this.db.collection('forum').add(payload);
                    textArea.value = '';
                    textArea.dispatchEvent(new Event('input'));
                    if (tagsInput) tagsInput.value = '';
                    if (locationInput) locationInput.value = '';
                    this.showToast('Post published to your feed', 'success');
                    await this.loadSocialFeed();
                } catch (error) {
                    console.error('Error creating post:', error);
                    this.showToast('Failed to publish post', 'error');
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Update';
                    }
                }
            }

            async getUserProfile(userId) {
                if (!userId) return {};
                if (this.userProfiles.has(userId)) {
                    return this.userProfiles.get(userId);
                }

                try {
                    const doc = await this.db.collection('users').doc(userId).get();
                    const data = doc.exists ? doc.data() : {};
                    const profile = {
                        displayName: data.displayName || data.email || 'Urban Explorer',
                        photoURL: data.photoURL || null
                    };
                    this.userProfiles.set(userId, profile);
                    return profile;
                } catch (error) {
                    console.error('Error loading profile for social feed:', error);
                    const fallback = { displayName: 'Urban Explorer', photoURL: null };
                    this.userProfiles.set(userId, fallback);
                    return fallback;
                }
            }

            async hydrateSocialEngagement(items = []) {
                if (!items.length) return;

                const ids = items.map(item => item.id);
                // Firestore `in` queries accept max 10; chunk to limit network
                const chunk = (arr, size) => {
                    const res = [];
                    for (let i = 0; i < arr.length; i += size) {
                        res.push(arr.slice(i, i + size));
                    }
                    return res;
                };

                try {
                    const likeChunks = chunk(ids, 10);
                    for (const set of likeChunks) {
                        const likeSnap = await this.db.collection('post_likes')
                            .where('postId', 'in', set)
                            .get();

                        const likeCounts = {};
                        likeSnap.forEach(doc => {
                            const data = doc.data();
                            likeCounts[data.postId] = (likeCounts[data.postId] || 0) + 1;
                            if (data.userId === this.currentUser?.uid) {
                                this.postLikeState.set(data.postId, true);
                            }
                        });

                        set.forEach(id => {
                            const count = likeCounts[id] || 0;
                            this.updateSocialLikeUI(id, count, this.postLikeState.get(id));
                            const item = this.socialFeedItems?.find(p => p.id === id);
                            if (item) item.likesCount = count;
                        });
                    }

                    for (const set of chunk(ids, 5)) {
                        for (const postId of set) {
                            const commentsSnap = await this.db.collection('comments')
                                .where('targetId', '==', postId)
                                .get();
                            const count = commentsSnap.size;
                            const item = this.socialFeedItems?.find(p => p.id === postId);
                            if (item) item.commentCount = count;
                            const countEl = document.getElementById(`post-comment-count-${postId}`);
                            if (countEl) countEl.textContent = count;
                        }
                    }
                } catch (error) {
                    console.error('Error hydrating social engagement:', error);
                }
            }

            updateSocialLikeUI(postId, likeCount = 0, liked = false) {
                const likeBtn = document.getElementById(`post-like-${postId}`);
                const likeCountEl = document.getElementById(`post-like-count-${postId}`);
                if (likeBtn) likeBtn.classList.toggle('liked', Boolean(liked));
                if (likeCountEl) likeCountEl.textContent = likeCount;
            }

            async togglePostLike(postId) {
                if (!this.currentUser) {
                    this.showToast('Sign in to like posts', 'warning');
                    this.handleAuth();
                    return;
                }

                const opKey = `post-like-${postId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    const alreadyLiked = this.postLikeState.get(postId);

                    if (alreadyLiked) {
                        const snapshot = await this.db.collection('post_likes')
                            .where('userId', '==', this.currentUser.uid)
                            .where('postId', '==', postId)
                            .limit(1)
                            .get();
                        snapshot.forEach(doc => doc.ref.delete());
                        this.postLikeState.set(postId, false);
                    } else {
                        await this.db.collection('post_likes').add({
                            userId: this.currentUser.uid,
                            postId,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        this.postLikeState.set(postId, true);
                    }

                    // Refresh counts for this post only
                    const countSnap = await this.db.collection('post_likes')
                        .where('postId', '==', postId)
                        .get();
                    const likeCount = countSnap.size;
                    this.updateSocialLikeUI(postId, likeCount, this.postLikeState.get(postId));

                    const item = this.socialFeedItems?.find(p => p.id === postId);
                    if (item) item.likesCount = likeCount;
                } catch (error) {
                    console.error('Error toggling post like:', error);
                    this.showToast('Failed to update like', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            togglePostComments(postId) {
                const wrap = document.getElementById(`post-comments-${postId}`);
                if (!wrap) return;
                const isVisible = wrap.style.display === 'block';
                wrap.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    this.loadPostComments(postId);
                }
            }

            async viewPostLocation(postId, locationId) {
                if (!locationId) return;
                try {
                    const doc = await this.db.collection('locations').doc(locationId).get();
                    if (doc.exists) {
                        this.showLocationDetailModal(locationId, { id: locationId, ...doc.data() });
                    } else {
                        this.showToast('Related location not found', 'warning');
                    }
                } catch (error) {
                    console.error(`Error opening location for post ${postId}:`, error);
                    this.showToast('Unable to open related location', 'error');
                }
            }

            async submitPostComment(postId) {
                const input = document.getElementById(`post-comment-input-${postId}`);
                if (!input) return;
                const text = input.value.trim();
                if (!text) {
                    this.showToast('Comment cannot be empty', 'warning');
                    return;
                }
                await this.addPostComment(postId, text);
                input.value = '';
                await this.loadPostComments(postId);
            }

            async addPostComment(postId, text) {
                if (!this.currentUser) {
                    this.showToast('Sign in to comment', 'warning');
                    this.handleAuth();
                    return;
                }

                const opKey = `post-comment-${postId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('comments').add({
                        targetId: postId,
                        targetType: 'post',
                        createdBy: this.currentUser.uid,
                        text: this.sanitizeInput(text),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    this.showToast('Comment added', 'success');
                } catch (error) {
                    console.error('Error adding post comment:', error);
                    this.showToast('Failed to add comment', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async loadPostComments(postId) {
                const container = document.getElementById(`post-comments-list-${postId}`);
                if (!container) return;

                container.innerHTML = '<div class="loading">Loading comments...</div>';

                try {
                    const snapshot = await this.db.collection('comments')
                        .where('targetId', '==', postId)
                        .where('targetType', '==', 'post')
                        .orderBy('createdAt', 'desc')
                        .limit(20)
                        .get();

                    const comments = [];
                    snapshot.forEach(doc => comments.push({ id: doc.id, ...doc.data() }));
                    const uniqueAuthors = Array.from(new Set(comments.map(c => c.createdBy).filter(Boolean)));
                    await Promise.all(uniqueAuthors.map(id => this.getUserProfile(id)));
                    this.postCommentCache.set(postId, comments);
                    this.renderPostComments(postId, comments);

                    const countEl = document.getElementById(`post-comment-count-${postId}`);
                    if (countEl) countEl.textContent = comments.length;
                    const item = this.socialFeedItems?.find(p => p.id === postId);
                    if (item) item.commentCount = comments.length;
                } catch (error) {
                    console.error('Error loading post comments:', error);
                    container.innerHTML = '<div class="error">Failed to load comments</div>';
                }
            }

            renderPostComments(postId, comments) {
                const container = document.getElementById(`post-comments-list-${postId}`);
                if (!container) return;

                if (!comments.length) {
                    container.innerHTML = '<div style="color: var(--text-muted);">No comments yet. Be the first!</div>';
                    return;
                }

                container.innerHTML = comments.map(comment => `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${this.escapeHtml(this.userProfiles.get(comment.createdBy)?.displayName || 'Explorer')}</span>
                            <span class="comment-time">${this.timeAgo(comment.createdAt?.toDate ? comment.createdAt.toDate() : comment.createdAt)}</span>
                        </div>
                        <div class="comment-text">${this.escapeHtml(comment.text)}</div>
                    </div>
                `).join('');
            }

            async startMission(missionId) {
                this.showToast('Mission started!', 'success');
            }

            async createNewRoute() {
                if (!this.currentUser) {
                    this.showToast('Sign in to save routes', 'warning');
                    this.handleAuth();
                    return;
                }

                const nameInput = prompt('Name your route (e.g., Skyline Sweep):');
                const name = nameInput ? this.sanitizeInput(nameInput) : '';
                if (!name) {
                    this.showToast('Route name is required', 'warning');
                    return;
                }

                const distanceRaw = prompt('Approximate distance in km (optional):', '3.5');
                const distanceVal = distanceRaw ? parseFloat(distanceRaw) : null;
                const distance = Number.isFinite(distanceVal) ? Number(distanceVal.toFixed(1)) : null;

                const stopsRaw = prompt('Stops (comma separated, e.g., Old Metro, Sky Deck):', '');
                const stops = stopsRaw ? stopsRaw.split(',').map(s => this.sanitizeInput(s.trim())).filter(Boolean) : [];

                const modeInput = prompt('Mode (Walk, Bike, Explore):', 'Walk');
                const mode = modeInput ? this.sanitizeInput(modeInput) : 'Walk';

                const tagsRaw = prompt('Tags (comma separated):', stops.slice(0, 2).join(', '));
                const tags = tagsRaw ? tagsRaw.split(',').map(t => this.sanitizeInput(t.trim())).filter(Boolean) : [];

                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                try {
                    await this.db.collection('routes').add({
                        name,
                        distance,
                        stops,
                        mode,
                        tags,
                        userId: this.currentUser.uid,
                        createdAt: timestamp,
                        updatedAt: timestamp
                    });

                    this.showToast('Route saved and ready to run', 'success');
                    this.loadRoutes();
                } catch (error) {
                    console.error('Error creating route:', error);
                    this.showToast('Failed to create route', 'error');
                }
            }

            async createNewGroup() {
                if (!this.currentUser) {
                    this.showToast('Sign in to create a group', 'warning');
                    this.handleAuth();
                    return;
                }

                const nameInput = prompt('Name your crew:', 'New Exploration Team');
                const name = nameInput ? this.sanitizeInput(nameInput) : '';
                if (!name) {
                    this.showToast('Group name is required', 'warning');
                    return;
                }

                const descriptionInput = prompt('Describe the group mission:', 'Local explorers sharing intel.');
                const description = descriptionInput ? this.sanitizeInput(descriptionInput) : '';

                const tagsInput = prompt('Tags (comma separated):', 'night ops, mapping');
                const tags = tagsInput ? tagsInput.split(',').map(t => this.sanitizeInput(t.trim())).filter(Boolean) : [];

                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                try {
                    await this.db.collection('groups').add({
                        name,
                        description,
                        tags,
                        members: [this.currentUser.uid],
                        ownerId: this.currentUser.uid,
                        createdAt: timestamp,
                        updatedAt: timestamp
                    });

                    this.showToast('Group created and ready to rally', 'success');
                    this.loadGroups();
                } catch (error) {
                    console.error('Error creating group:', error);
                    this.showToast('Failed to create group', 'error');
                }
            }

            startRoute(routeId) {
                this.showToast(`Starting route ${routeId}`, 'success');
            }

            shareRoute(routeId) {
                this.showToast(`Share link copied for ${routeId}`, 'info');
            }

            openGroup(groupId) {
                this.showToast(`Opening group ${groupId}`, 'info');
            }

            messageGroup(groupId) {
                this.showToast(`Messaging group ${groupId}`, 'info');
            }

            filterSocialFeed() {
                const filtered = this.applySocialFilters(this.socialFeedItems || []);
                this.renderSocialFeed(filtered);
                this.updateActiveFilterMessage();
            }

            sortSocialFeed() {
                const filtered = this.applySocialFilters(this.socialFeedItems || []);
                this.renderSocialFeed(filtered);
            }
            async handleAddressLookup() {
                const addressInput = document.getElementById('location-address');
                const findLocationBtn = document.getElementById('find-location-btn');
                const coordsDisplay = document.getElementById('coordinates-display');

                if (!addressInput) return;

                const address = addressInput.value.trim();
                if (!address) {
                    this.showToast('Please enter an address', 'warning');
                    addressInput.focus();
                    return;
                }

                // Disable button and show loading
                if (findLocationBtn) {
                    const originalHTML = findLocationBtn.innerHTML;
                    findLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    findLocationBtn.disabled = true;
                }

                // Update display
                if (coordsDisplay) {
                    coordsDisplay.textContent = 'Finding location...';
                    coordsDisplay.style.background = 'linear-gradient(to right, #f0f0f0, #e0e0e0)';
                }

                try {
                    const coordinates = await this.geocodeAddress(address);
                    if (coordinates) {
                        await this.setLocationFromCoordinates(coordinates.lat, coordinates.lng, address);
                        this.showToast(`Found location: ${coordinates.displayName}`, 'success');
                    } else {
                        throw new Error('Address not found');
                    }
                } catch (error) {
                    console.error('Geocoding error:', error);
                    let message = 'Failed to find location';
                    if (error.message.includes('rate limit')) {
                        message = 'Rate limit exceeded. Please wait a moment and try again.';
                    } else if (error.message.includes('not found')) {
                        message = 'Address not found. Please check the spelling and try again.';
                    }
                    this.showToast(message, 'error');
                    
                    if (coordsDisplay) {
                        coordsDisplay.textContent = 'Click on map to set location';
                        coordsDisplay.style.background = 'white';
                    }
                } finally {
                    // Re-enable button
                    if (findLocationBtn) {
                        findLocationBtn.innerHTML = '<i class="fas fa-search"></i>';
                        findLocationBtn.disabled = false;
                    }
                }
            }

            async handleMyLocation() {
                const useMyLocationBtn = document.getElementById('use-my-location-btn');
                const coordsDisplay = document.getElementById('coordinates-display');

                // Disable button and show loading
                if (useMyLocationBtn) {
                    const originalHTML = useMyLocationBtn.innerHTML;
                    useMyLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    useMyLocationBtn.disabled = true;
                }

                if (coordsDisplay) {
                    coordsDisplay.textContent = 'Getting your location...';
                    coordsDisplay.style.background = 'linear-gradient(to right, #f0f0f0, #e0e0e0)';
                }

                try {
                    const [lat, lng] = await this.getUserLocation();
                    const address = await this.reverseGeocode(lat, lng);
                    await this.setLocationFromCoordinates(lat, lng, address);
                    this.showToast('Location set to your current position', 'success');
                } catch (error) {
                    console.error('Geolocation error:', error);
                    let message = 'Failed to get your location';
                    if (error.message.includes('denied')) {
                        message = 'Location access denied. Please enable location permissions.';
                    } else if (error.message.includes('unavailable')) {
                        message = 'Location information is unavailable.';
                    } else if (error.message.includes('timeout')) {
                        message = 'Location request timed out.';
                    }
                    this.showToast(message, 'error');
                    
                    if (coordsDisplay) {
                        coordsDisplay.textContent = 'Click on map to set location';
                        coordsDisplay.style.background = 'white';
                    }
                } finally {
                    // Re-enable button
                    if (useMyLocationBtn) {
                        useMyLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use My Location';
                        useMyLocationBtn.disabled = false;
                    }
                }
            }

            async geocodeAddress(address) {
                try {
                    // Try Google Places API first if available
                    if (this.googlePlacesAvailable && this.placesAutocomplete) {
                        try {
                            const result = await this.geocodeWithGoogle(address);
                            if (result) {
                                console.log('Geocoded with Google Places API');
                                return result;
                            }
                        } catch (googleError) {
                            console.warn('Google Places geocoding failed, trying OpenStreetMap:', googleError);
                        }
                    }
                    
                    // Fallback to Nominatim API call with proper headers
                    const encodedAddress = encodeURIComponent(address);
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1&addressdetails=1`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'User-Agent': 'Urbindex/1.0 (Urban Exploration Network)'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('rate limit');
                        }
                        throw new Error('Geocoding service unavailable');
                    }

                    const data = await response.json();
                    
                    if (!data || data.length === 0) {
                        throw new Error('not found');
                    }

                    const result = data[0];
                    return {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon),
                        displayName: result.display_name
                    };
                } catch (error) {
                    console.error('Nominatim geocoding error:', error);
                    throw error;
                }
            }
            
            async geocodeWithGoogle(address) {
                return new Promise((resolve, reject) => {
                    if (!this.googlePlacesAvailable || !google.maps.Geocoder) {
                        reject(new Error('Google Geocoder not available'));
                        return;
                    }
                    
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === google.maps.GeocoderStatus.OK && results && results.length > 0) {
                            const result = results[0];
                            resolve({
                                lat: result.geometry.location.lat(),
                                lng: result.geometry.location.lng(),
                                displayName: result.formatted_address,
                                placeId: result.place_id,
                                types: result.types,
                                addressComponents: result.address_components
                            });
                        } else {
                            reject(new Error(`Google Geocoding failed: ${status}`));
                        }
                    });
                });
            }

            async reverseGeocode(lat, lng) {
                try {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'User-Agent': 'Urbindex/1.0 (Urban Exploration Network)'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Reverse geocoding failed');
                    }

                    const data = await response.json();
                    return data.display_name || 'Current location';
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                    return 'Current location';
                }
            }

            async setLocationFromCoordinates(lat, lng, address = null) {
                // Set the coordinates
                this.selectedLatLng = { lat, lng };
                
                // Update the coordinates display
                const coordsDisplay = document.getElementById('coordinates-display');
                if (coordsDisplay) {
                    coordsDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    coordsDisplay.style.background = 'linear-gradient(to right, #d4edda, #c3e6cb)';
                    coordsDisplay.style.color = '#155724';
                }

                // Update address field if provided
                const addressInput = document.getElementById('location-address');
                if (addressInput && address) {
                    addressInput.value = address;
                }

                // Center map on the location
                if (this.map && this.map.getContainer().offsetParent !== null) {
                    this.map.setView([lat, lng], 16);
                    
                    // Add a temporary marker to show the found location
                    if (this.tempMarker) {
                        this.map.removeLayer(this.tempMarker);
                    }
                    
                    this.tempMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'geocoded-marker',
                            html: '<div style="background: var(--cz-yellow); width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    }).addTo(this.map);

                    // Remove marker after 3 seconds
                    setTimeout(() => {
                        if (this.tempMarker) {
                            this.map.removeLayer(this.tempMarker);
                            this.tempMarker = null;
                        }
                    }, 3000);
                }

                // Announce to screen reader
                this.announceToScreenReader(`Location set to ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            }

            initTagSystem() {
                // Initialize tag-related properties
                this.selectedTags = new Set();
                this.predefinedTags = [
                    'historic', 'architecture', 'nature', 'underground', 'hidden', 'photo-worthy',
                    'challenging', 'accessible', 'urban', 'industrial', 'abandoned', 'safe',
                    'dangerous', 'family-friendly', 'night-time', 'day-time', 'rooftop',
                    'basement', 'warehouse', 'bridge', 'tunnel', 'park', 'waterfront'
                ];

                // Set up tag input event listeners
                this.setupTagInput();
                // Initialize social features
                this.followers = new Map();
                this.following = new Map();
                this.likes = new Map();
                this.ratings = new Map();
                this.comments = new Map();
                this.profilePosts = new Map();
                this.notifications = [];
                this.visits = new Map();
                this.badges = new Map();
                this.routes = new Map();
                this.groups = new Map();
                this.missions = new Map();
                this.unreadNotifications = 0;
            }

            setupTagInput() {
                const tagInput = document.getElementById('tag-input');
                const predefinedTagsList = document.getElementById('predefined-tags-list');
                
                if (tagInput) {
                    tagInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ',') {
                            e.preventDefault();
                            const tag = tagInput.value.trim();
                            if (tag) {
                                this.addTag(tag);
                                tagInput.value = '';
                            }
                        }
                    });

                    tagInput.addEventListener('blur', () => {
                        const tag = tagInput.value.trim();
                        if (tag) {
                            this.addTag(tag);
                            tagInput.value = '';
                        }
                    });
                }

                // Render predefined tags
                if (predefinedTagsList) {
                    predefinedTagsList.innerHTML = '';
                    this.predefinedTags.forEach(tag => {
                        const tagElement = document.createElement('span');
                        tagElement.className = 'predefined-tag';
                        tagElement.textContent = tag;
                        tagElement.addEventListener('click', () => {
                            this.togglePredefinedTag(tag, tagElement);
                        });
                        predefinedTagsList.appendChild(tagElement);
                    });
                }
            }

            addTag(tag) {
                // Sanitize and validate tag
                const cleanTag = this.sanitizeInput(tag).toLowerCase();
                if (cleanTag.length < 2 || cleanTag.length > 20) {
                    this.showToast('Tags must be 2-20 characters long', 'warning');
                    return;
                }

                // Check for duplicates
                if (this.selectedTags.has(cleanTag)) {
                    this.showToast('Tag already added', 'info');
                    return;
                }

                // Limit number of tags
                if (this.selectedTags.size >= 10) {
                    this.showToast('Maximum 10 tags allowed', 'warning');
                    return;
                }

                this.selectedTags.add(cleanTag);
                this.renderSelectedTags();
            }

            removeTag(tag) {
                this.selectedTags.delete(tag);
                this.renderSelectedTags();
                
                // Update predefined tag UI if needed
                const predefinedTags = document.querySelectorAll('.predefined-tag');
                predefinedTags.forEach(el => {
                    if (el.textContent === tag) {
                        el.classList.remove('selected');
                    }
                });
            }

            togglePredefinedTag(tag, element) {
                if (this.selectedTags.has(tag)) {
                    this.removeTag(tag);
                } else {
                    this.addTag(tag);
                    element.classList.add('selected');
                }
            }

            renderSelectedTags() {
                const selectedTagsContainer = document.getElementById('selected-tags');
                if (selectedTagsContainer) {
                    selectedTagsContainer.innerHTML = '';
                    this.selectedTags.forEach(tag => {
                        const tagElement = document.createElement('span');
                        tagElement.className = 'tag remove';
                        tagElement.innerHTML = `
                            ${tag}
                            <i class="fas fa-times"></i>
                        `;
                        tagElement.addEventListener('click', () => {
                            this.removeTag(tag);
                        });
                        selectedTagsContainer.appendChild(tagElement);
                    });
                }
            }

            getSelectedTags() {
                return Array.from(this.selectedTags);
            }

            clearTags() {
                this.selectedTags.clear();
                this.renderSelectedTags();
                
                // Reset predefined tags UI
                const predefinedTags = document.querySelectorAll('.predefined-tag');
                predefinedTags.forEach(el => {
                    el.classList.remove('selected');
                });
            }

            loadTagsForLocation(locationData) {
                // Clear existing tags
                this.clearTags();
                
                // Load tags from location data
                if (locationData.tags && Array.isArray(locationData.tags)) {
                    locationData.tags.forEach(tag => {
                        this.selectedTags.add(tag);
                    });
                    this.renderSelectedTags();
                }
            }

            initAuth() {
                if (!this.auth) {
                    console.error('Firebase Auth not initialized');
                    this.showError('Authentication system failed to initialize. Please refresh the page.');
                    return;
                }

                this.auth.onAuthStateChanged(user => {
                    this.currentUser = user;
                    this.updateAuthUI(); // Call enhanced auth UI update
                    
                    if (user) {
                        console.log('User authenticated:', user.uid, user.isAnonymous ? '(anonymous)' : '(registered)');
                        this.loadUserData();
                        
                        // Initialize session management for authenticated users
                        if (!user.isAnonymous) {
                            this.initSessionManagement();
                        }
                    } else {
                        console.log('User not authenticated');
                        this.stopSessionManagement();
                    }
                    // Always load public data regardless of auth state
                }, error => {
                    console.error('Auth state change error:', error);
                    // Add retry mechanism for transient errors
                    if (error.code === 'auth/network-request-failed') {
                        this.showError('Network error. Retrying connection...');
                        setTimeout(() => this.initAuth(), 5000); // Retry after 5 seconds
                    } else {
                        this.showError('Authentication error occurred. Please refresh the page.');
                    }
                });

                // Auth modal event listeners
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchAuthTab(tab.dataset.tab));
                });

                const signinForm = document.getElementById('signin-form-element');
                if (signinForm) {
                    signinForm.addEventListener('submit', (e) => this.handleSignIn(e));
                }

                const signupForm = document.getElementById('signup-form-element');
                if (signupForm) {
                    signupForm.addEventListener('submit', (e) => this.handleSignUp(e));
                }

                // OAuth button event listeners
                this.initOAuthButtons();
                
                // Enhanced form validation
                this.initFormValidation();
            }

            async loadData() {
                // Load public data (locations, stats) regardless of auth state
                // Activity feed will handle auth requirements internally
                this.loadLocations();
                this.loadStats();
                this.loadActivity();
            }

            // ========================
            // PROFILE SOCIAL METHODS
            // ========================

            async toggleFollow(userId) {
                if (!this.currentUser) {
                    this.showToast('Please sign in to follow users', 'warning');
                    return;
                }

                const opKey = `follow-${userId}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    const followBtn = document.getElementById(`follow-btn-${userId}`);
                    const isFollowing = followBtn && followBtn.textContent.includes('Unfollow');

                    if (isFollowing) {
                        await this.unfollowUser(userId);
                        if (followBtn) {
                            followBtn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                            followBtn.className = 'btn btn-primary';
                        }
                    } else {
                        await this.followUser(userId);
                        if (followBtn) {
                            followBtn.innerHTML = '<i class="fas fa-user-check"></i> Following';
                            followBtn.className = 'btn';
                        }
                    }
                } catch (error) {
                    console.error('Error toggling follow:', error);
                    this.showToast('Failed to update follow status', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async messageUser(userId) {
                if (!this.currentUser) {
                    this.showToast('Sign in to message explorers', 'warning');
                    this.handleAuth();
                    return;
                }

                if (!userId) {
                    this.showToast('No recipient selected', 'error');
                    return;
                }

                const bodyInput = prompt('Send a quick message:');
                const body = bodyInput ? this.sanitizeInput(bodyInput) : '';
                if (!body) {
                    this.showToast('Message cannot be empty', 'warning');
                    return;
                }

                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                try {
                    await this.db.collection('user_messages').add({
                        toUserId: userId,
                        fromUserId: this.currentUser.uid,
                        body,
                        createdAt: timestamp,
                        read: false
                    });
                    this.showToast('Message sent', 'success');
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showToast('Failed to send message', 'error');
                }
            }

            async viewUserLocations(userId) {
                const modal = document.getElementById('user-locations-modal');
                const list = document.getElementById('user-locations-list');
                const title = document.getElementById('user-locations-title');

                if (!modal || !list || !title) return;

                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
                list.innerHTML = '<div class="loading">Loading user locations...</div>';
                title.textContent = 'User Locations';

                if (!userId) {
                    list.innerHTML = '<div class="error">No user specified</div>';
                    return;
                }

                try {
                    const snapshot = await this.db.collection('locations')
                        .where('createdBy', '==', userId)
                        .where('status', '==', 'active')
                        .get();

                    if (snapshot.empty) {
                        list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 16px;">No locations to display.</div>';
                        return;
                    }

                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const lat = Array.isArray(data.coordinates) ? data.coordinates[0] : null;
                        const lng = Array.isArray(data.coordinates) ? data.coordinates[1] : null;

                        const card = document.createElement('div');
                        card.className = 'location-card';
                        card.innerHTML = `
                            <div class="location-header">
                                <h4>${this.escapeHtml(data.name || 'Unnamed')}</h4>
                                <span class="risk risk-${data.riskLevel || 'unknown'}">${data.riskLevel || 'unknown'}</span>
                            </div>
                            <p style="color: var(--text-secondary); margin-bottom: 10px;">${this.escapeHtml(data.description || 'No description')}</p>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">
                                <i class="fas fa-tag"></i> ${this.escapeHtml(data.category || 'uncategorized')}
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${(data.tags || []).slice(0, 5).map(tag => `<span class="tag">${this.escapeHtml(tag)}</span>`).join('')}
                            </div>
                            ${lat !== null && lng !== null ? `
                                <div style="margin-top: 10px;">
                                    <button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="app.focusMapOnLocation(${lat}, ${lng})">
                                        <i class="fas fa-location-arrow"></i> View on Map
                                    </button>
                                </div>
                            ` : ''}
                        `;

                        list.appendChild(card);
                    });
                } catch (error) {
                    console.error('Error loading user locations:', error);
                    list.innerHTML = '<div class="error">Failed to load locations</div>';
                }
            }

            async loadUserSocialStats(userId) {
                try {
                    // Load follower count
                    const followersSnapshot = await this.db.collection('user_followers')
                        .where('followingId', '==', userId)
                        .get();
                    
                    // Load following count  
                    const followingSnapshot = await this.db.collection('user_followers')
                        .where('followerId', '==', userId)
                        .get();

                    // Load likes received on user's locations
                    const userLocationsSnapshot = await this.db.collection('locations')
                        .where('createdBy', '==', userId)
                        .get();
                    
                    const locationIds = userLocationsSnapshot.docs.map(doc => doc.id);
                    let likesCount = 0;
                    
                    if (locationIds.length > 0) {
                        const likesSnapshot = await this.db.collection('location_likes')
                            .where('locationId', 'in', locationIds.slice(0, 10)) // Firestore limit
                            .get();
                        likesCount = likesSnapshot.size;
                    }

                    // Load visits to user's locations
                    let visitsCount = 0;
                    if (locationIds.length > 0) {
                        const visitsSnapshot = await this.db.collection('location_visits')
                            .where('locationId', 'in', locationIds.slice(0, 10))
                            .get();
                        visitsCount = visitsSnapshot.size;
                    }

                    // Load user badges
                    const badgesSnapshot = await this.db.collection('user_badges')
                        .where('userId', '==', userId)
                        .get();

                    // Update the stats in the profile
                    const followersElement = document.getElementById('profile-followers-count');
                    const followingElement = document.getElementById('profile-following-count');
                    const likesElement = document.getElementById('profile-likes-count');
                    const visitsElement = document.getElementById('profile-visits-count');
                    const badgesElement = document.getElementById('profile-badges-count');

                    if (followersElement) followersElement.textContent = followersSnapshot.size;
                    if (followingElement) followingElement.textContent = followingSnapshot.size;
                    if (likesElement) likesElement.textContent = likesCount;
                    if (visitsElement) visitsElement.textContent = visitsCount;
                    if (badgesElement) badgesElement.textContent = badgesSnapshot.size;

                    this.renderUserBadges(badgesSnapshot.docs.map(doc => doc.data()));

                } catch (error) {
                    console.error('Error loading user social stats:', error);
                }
            }

            renderUserBadges(badges) {
                const container = document.getElementById('user-badges');
                if (!container) return;

                if (badges.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 24px; color: var(--text-muted); grid-column: 1 / -1;">
                            <i class="fas fa-trophy" style="font-size: 2rem; margin-bottom: 8px; display: block; opacity: 0.5;"></i>
                            <p>No badges earned yet. Start exploring to unlock achievements!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = badges.map(badge => `
                    <div class="achievement-tag">
                        <div class="tag-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="tag-name">${this.getBadgeName(badge.badgeId)}</div>
                        <div class="tag-desc">${this.getBadgeDescription(badge.badgeId)}</div>
                    </div>
                `).join('');
            }

            getBadgeName(badgeId) {
                const badgeNames = {
                    'first_location': 'First Explorer',
                    'mapper_10': 'Mapper',
                    'mapper_50': 'Master Mapper',
                    'first_visit': 'First Check-in',
                    'explorer_10': 'Explorer',
                    'explorer_50': 'Master Explorer',
                    'social_butterfly': 'Social Butterfly',
                    'commentator_10': 'Commentator',
                    'appreciator': 'Appreciator',
                    'liker_25': 'Liked'
                };
                return badgeNames[badgeId] || 'Achievement';
            }

            getBadgeDescription(badgeId) {
                const badgeDescriptions = {
                    'first_location': 'Added your first location',
                    'mapper_10': 'Added 10 locations',
                    'mapper_50': 'Added 50 locations',
                    'first_visit': 'First location visit',
                    'explorer_10': 'Visited 10 locations',
                    'explorer_50': 'Visited 50 locations',
                    'social_butterfly': 'Made your first comment',
                    'commentator_10': 'Posted 10 comments',
                    'appreciator': 'First location like',
                    'liker_25': 'Received 25 likes'
                };
                return badgeDescriptions[badgeId] || 'Special achievement';
            }

            loadLocations() {
                if (!this.map) {
                    console.warn('Map not initialized, skipping location loading');
                    return;
                }

                try {
                    // Initialize marker cluster group if not exists
                    if (!this.markerClusterGroup) {
                        this.markerClusterGroup = L.markerClusterGroup({
                            chunkedLoading: true,
                            chunkProgress: (processed, total, elapsed) => {
                                console.log(`Clustering ${processed} of ${total} markers (${Math.round(processed/total*100)}%)`);
                            },
                            maxClusterRadius: 50,
                            spiderfyOnMaxZoom: true,
                            showCoverageOnHover: false,
                            zoomToBoundsOnClick: true,
                            disableClusteringAtZoom: 16,
                            removeOutsideVisibleBounds: true,
                            animate: true,
                            animateAddingMarkers: true,
                            singleMarkerMode: false,
                            iconCreateFunction: (cluster) => {
                                const count = cluster.getChildCount();
                                let className = 'marker-cluster-small';
                                if (count > 10) className = 'marker-cluster-medium';
                                if (count > 20) className = 'marker-cluster-large';
                                
                                return new L.DivIcon({
                                    html: `<div><span>${count}</span></div>`,
                                    className: `marker-cluster ${className}`,
                                    iconSize: new L.Point(40, 40)
                                });
                            }
                        });
                        
                        // Add cluster group to map
                        this.map.addLayer(this.markerClusterGroup);
                    }

                    // Load locations for public viewing (rules now allow public read)
                    this.db.collection('locations')
                        .where('status', '==', 'active')
                        .orderBy('createdAt', 'desc')
                        .onSnapshot(snapshot => {
                            // Clear existing markers from cluster
                            if (this.markerClusterGroup) {
                                this.markerClusterGroup.clearLayers();
                            }
                            this.markers.clear();

                            let locationCount = 0;
                            let invalidLocations = 0;
                            const validMarkers = [];

                            snapshot.forEach(doc => {
                                try {
                                    const data = doc.data();
                                    if (data.coordinates && Array.isArray(data.coordinates) && data.coordinates.length === 2) {
                                        const [lat, lng] = data.coordinates;

                                        // Validate coordinates
                                        if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                                            locationCount++;

                                            // Create custom icon based on risk level
                                            const riskColor = this.getRiskColor(data.riskLevel);
                                            const marker = L.marker([lat, lng], {
                                                icon: L.divIcon({
                                                    className: 'custom-location-marker',
                                                    html: `<div style="background: ${riskColor}; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
                                                    iconSize: [16, 16],
                                                    iconAnchor: [8, 8]
                                                })
                                            })
                                                .bindTooltip(data.name || 'Unnamed Location', {
                                                    direction: 'top',
                                                    permanent: false,
                                                    offset: [0, -10]
                                                })
                                                .bindPopup(this.createLocationPopup(data, doc.id));

                                            validMarkers.push(marker);
                                            this.markers.set(doc.id, marker);
                                        } else {
                                            invalidLocations++;
                                            console.warn(`Invalid coordinates for location ${doc.id}:`, data.coordinates);
                                        }
                                    } else {
                                        invalidLocations++;
                                        console.warn(`Missing or invalid coordinates for location ${doc.id}`);
                                    }
                                } catch (docError) {
                                    console.error(`Error processing location ${doc.id}:`, docError);
                                    invalidLocations++;
                                }
                            });

                            // Add markers to cluster group
                            if (validMarkers.length > 0 && this.markerClusterGroup) {
                                validMarkers.forEach(marker => {
                                    this.markerClusterGroup.addLayer(marker);
                                });
                            }

                            console.log(`Loaded ${locationCount} locations on map${invalidLocations > 0 ? ` (${invalidLocations} invalid locations skipped)` : ''}`);

                            if (locationCount === 0 && snapshot.size > 0) {
                                this.showToast(`Loaded ${snapshot.size} locations but none could be displayed due to invalid data`, 'warning');
                            }
                        }, error => {
                            console.error('Error loading locations:', error);
                            let message = 'Failed to load locations';

                            if (error.code === 'permission-denied') {
                                message = 'Please sign in to view locations';
                            } else if (error.code === 'failed-precondition') {
                                message = 'Location data is temporarily unavailable';
                            } else if (error.code === 'unavailable') {
                                message = 'Network error. Please check your connection.';
                            }

                            this.showToast(message, 'error');
                        });
                } catch (error) {
                    console.error('Error setting up location listener:', error);
                    this.showToast('Failed to initialize location loading', 'error');
                }
            }

            createLocationPopup(data, docId) {
                const riskColor = this.getRiskColor(data.riskLevel);
                const escapedName = this.escapeHtml(data.name || 'Unnamed Location');
                const escapedDescription = this.escapeHtml(data.description || 'No description available');
                const category = this.escapeHtml(data.category || 'other');
                const formattedDate = data.createdAt ? new Date(data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt).toLocaleDateString() : 'Unknown';
                const visitCount = data.visitCount || 0;
                const likeCount = data.likesCount || 0;
                
                // Render photos if available
                let photosHtml = '';
                if (data.photos && Array.isArray(data.photos) && data.photos.length > 0) {
                    photosHtml = `
                        <div class="photos-section">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 4px; margin: 8px 0;">
                                ${data.photos.slice(0, 4).map((photo, index) => 
                                    `<img src="${this.escapeHtml(photo)}" alt="Location photo ${index + 1}" 
                                         style="width: 80px; height: 80px; object-fit: cover; border: 2px solid var(--cz-black); cursor: pointer;"
                                         onclick="app.showLocationPhotoModal('${docId}', ${index})">`
                                ).join('')}
                                ${data.photos.length > 4 ? `<div style="width: 80px; height: 80px; background: var(--cz-concrete); border: 2px solid var(--cz-black); display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: var(--text-muted);">+${data.photos.length - 4}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Render tags if available
                let tagsHtml = '';
                if (data.tags && Array.isArray(data.tags) && data.tags.length > 0) {
                    tagsHtml = `
                        <div style="display: flex; flex-wrap: wrap; gap: 3px; margin: 6px 0;">
                            ${data.tags.slice(0, 5).map(tag =>
                                `<span style="background: var(--cz-yellow); color: white; padding: 1px 4px; border-radius: 0; font-size: 0.7em;">${this.escapeHtml(tag)}</span>`
                            ).join('')}
                            ${data.tags.length > 5 ? `<span style="font-size: 0.7em; color: #666;">+${data.tags.length - 5} more</span>` : ''}
                        </div>
                    `;
                }
                
                // Render metadata
                let metadataHtml = `
                    <div style="display: flex; gap: 8px; font-size: 0.75em; color: #666; margin: 8px 0; padding-top: 6px; border-top: 1px solid #eee;">
                        <span><i class="fas fa-calendar" aria-hidden="true"></i> ${formattedDate}</span>
                        <span><i class="fas fa-eye" aria-hidden="true"></i> ${visitCount} visits</span>
                        <span><i class="fas fa-heart" aria-hidden="true"></i> ${likeCount} likes</span>
                    </div>
                `;

                return `
                    <div style="min-width: 250px; max-width: 400px;">
                        <div style="margin-bottom: 8px;">
                            <strong style="font-size: 1.1em; color: var(--accent-blue);">${escapedName}</strong>
                        </div>
                        <div style="margin-bottom: 8px; color: #666; font-size: 0.9em; line-height: 1.4;">
                            ${escapedDescription}
                        </div>
                        <div style="display: flex; gap: 6px; font-size: 0.8em; margin-bottom: 8px;">
                            <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 0; color: #333;">${category}</span>
                            <span style="background: ${riskColor}; padding: 2px 6px; border-radius: 0; color: white;">${data.riskLevel || 'unknown'}</span>
                        </div>
                        ${photosHtml}
                        ${tagsHtml}
                        ${metadataHtml}
                        ${this.currentUser ? `
                            <div style="display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap;">
                                <button onclick="app.editLocation('${docId}')" style="font-size: 0.75em; padding: 4px 8px; border-radius: 0; border: 1px solid var(--cz-black);">Edit</button>
                                <button onclick="app.deleteLocation('${docId}')" style="font-size: 0.75em; padding: 4px 8px; background: var(--cz-red); color: white; border: 1px solid var(--cz-black);">Delete</button>
                                <button onclick="app.showView('locations'); setTimeout(() => app.loadUserLocations(), 100);" style="font-size: 0.75em; padding: 4px 8px; background: var(--cz-yellow); color: var(--cz-black); border: 1px solid var(--cz-black);">List View</button>
                                ${data.photos && data.photos.length > 0 ? `<button onclick="app.showLocationPhotos('${docId}')" style="font-size: 0.75em; padding: 4px 8px; background: var(--cz-concrete); color: var(--text-primary); border: 1px solid var(--cz-black);">Photos (${data.photos.length})</button>` : ''}
                            </div>
                        ` : `
                            <div style="margin-top: 8px;">
                                <button onclick="app.showView('locations')" style="font-size: 0.8em; padding: 4px 8px; background: var(--cz-yellow); color: var(--cz-black); border-radius: 0;">View All Locations</button>
                            </div>
                        `}
                    </div>
                `;
            }

            async loadStats() {
                try {
                    const [locationsSnap, usersSnap] = await Promise.all([
                        this.db.collection('locations').where('status', '==', 'active').get(),
                        this.db.collection('users').where('lastSeen', '>', new Date(Date.now() - 86400000)).get()
                    ]);

                    const locationCount = locationsSnap.size;
                    const activeUserCount = usersSnap.size;

                    document.getElementById('total-locations').textContent = locationCount;
                    document.getElementById('active-users').textContent = activeUserCount;

                    const heroLocations = document.getElementById('hero-total-locations');
                    const heroUsers = document.getElementById('hero-active-users');
                    const activityIndexElement = document.getElementById('hero-activity-index');

                    if (heroLocations) heroLocations.textContent = locationCount;
                    if (heroUsers) heroUsers.textContent = activeUserCount;
                    if (activityIndexElement) {
                        const activityIndex = Math.min(99, Math.max(0, Math.round(locationCount * 0.7 + activeUserCount * 1.3)));
                        activityIndexElement.textContent = activityIndex;
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            loadActivity() {
                if (!this.auth.currentUser) {
                    const feed = document.getElementById('activity-feed');
                    if (feed) {
                        feed.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 16px;">Sign in to view activity</div>';
                    }
                    return;
                }

                try {
                    this.db.collection('locations')
                        .where('status', '==', 'active')
                        .orderBy('createdAt', 'desc')
                        .limit(10)
                        .onSnapshot(snapshot => {
                            const feed = document.getElementById('activity-feed');
                            if (!feed) return;
                            
                            if (snapshot.empty) {
                                feed.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 16px;">No recent activity</div>';
                                return;
                            }

                            feed.innerHTML = '';
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                const item = document.createElement('div');
                                item.className = 'activity-item';
                                item.innerHTML = `
                                    <div class="activity-icon"><i class="fas fa-map-marker-alt"></i></div>
                                    <div class="activity-content">
                                        <div><span class="activity-user">Explorer</span> added "${this.escapeHtml(data.name)}"</div>
                                        <div class="activity-time">${this.timeAgo(data.createdAt?.toDate())}</div>
                                    </div>
                                `;
                                feed.appendChild(item);
                            });
                        }, error => {
                            console.error('Error loading activity:', error);
                            const feed = document.getElementById('activity-feed');
                            if (feed) {
                                if (error.code === 'permission-denied') {
                                    feed.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 16px;">Sign in to view activity</div>';
                                } else {
                                    feed.innerHTML = '<div class="error">Failed to load activity</div>';
                                }
                            }
                        });
                } catch (error) {
                    console.error('Error setting up activity listener:', error);
                    const feed = document.getElementById('activity-feed');
                    if (feed) {
                        feed.innerHTML = '<div class="error">Failed to load activity</div>';
                    }
                }
            }

            switchView(viewName) {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === viewName);
                });

                document.querySelectorAll('.view').forEach(view => {
                    view.classList.toggle('active', view.id === `${viewName}-view`);
                });

                if (viewName === 'map' && this.map) {
                    setTimeout(() => this.map.invalidateSize(), 100);
                } else if (viewName === 'locations') {
                    this.loadUserLocations();
                } else if (viewName === 'profile') {
                    this.loadProfile();
                }
            }

            async loadUserLocations() {
                const grid = document.getElementById('locations-grid');
                if (!grid) return;

                if (!this.currentUser) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 48px;">
                            <i class="fas fa-lock" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 16px; display: block;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 12px;">Sign In Required</h3>
                            <p style="color: var(--text-muted); margin-bottom: 20px;">Create an account to start tracking your urban exploration locations</p>
                            <button class="btn btn-primary" onclick="app.handleAuth()">
                                <i class="fas fa-sign-in-alt"></i> Sign In Now
                            </button>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = '<div class="loading">Loading your locations...</div>';

                try {
                    const snapshot = await this.db.collection('locations')
                        .where('createdBy', '==', this.currentUser.uid)
                        .where('status', '==', 'active')
                        .orderBy('createdAt', 'desc')
                        .get();

                    if (snapshot.empty) {
                        grid.innerHTML = '<div style="text-align: center; padding: 48px; color: var(--text-muted);">No locations yet. Add your first location!</div>';
                        return;
                    }

                    // Store all locations for filtering
                    this.allUserLocations = [];
                    snapshot.forEach(doc => {
                        this.allUserLocations.push({ id: doc.id, data: doc.data() });
                    });

                    this.renderFilteredLocations();

                    // Set up search and filter event listeners
                    this.setupSearchAndFilters();

                } catch (error) {
                    console.error('Error loading locations:', error);
                    grid.innerHTML = '<div class="error">Failed to load locations</div>';
                }
            }

            setupSearchAndFilters() {
                const searchInput = document.getElementById('location-search');
                const categoryFilter = document.getElementById('category-filter');
                const riskFilter = document.getElementById('risk-filter');
                const sortFilter = document.getElementById('sort-filter');

                // Debounced search with fuzzy matching
                if (searchInput) {
                    let searchTimeout;
                    searchInput.addEventListener('input', () => {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            this.renderFilteredLocations();
                        }, 300); // 300ms debounce
                    });
                }

                if (categoryFilter) {
                    categoryFilter.addEventListener('change', () => this.renderFilteredLocations());
                }

                if (riskFilter) {
                    riskFilter.addEventListener('change', () => this.renderFilteredLocations());
                }

                if (sortFilter) {
                    sortFilter.addEventListener('change', () => this.renderFilteredLocations());
                }
            }

            // Fuzzy matching function for better search results
            fuzzyMatch(text, searchTerm) {
                if (!searchTerm) return true;
                
                const textLower = text.toLowerCase();
                const termLower = searchTerm.toLowerCase();
                
                // Exact match
                if (textLower.includes(termLower)) return true;
                
                // Fuzzy matching - allow for typos and similar words
                const words = textLower.split(/\s+/);
                const termWords = termLower.split(/\s+/);
                
                return termWords.every(termWord => {
                    return words.some(word => {
                        // Allow 1 character difference for words longer than 3 characters
                        if (word.length > 3 && termWord.length > 3) {
                            const diff = this.charDifference(word, termWord);
                            return diff <= 1;
                        }
                        return word.startsWith(termWord) || termWord.startsWith(word);
                    });
                });
            }
            
            // Calculate character difference between two strings
            charDifference(str1, str2) {
                const len1 = str1.length;
                const len2 = str2.length;
                const maxLen = Math.max(len1, len2);
                
                if (maxLen === 0) return 0;
                
                let differences = 0;
                const minLen = Math.min(len1, len2);
                
                for (let i = 0; i < minLen; i++) {
                    if (str1[i] !== str2[i]) differences++;
                }
                
                differences += Math.abs(len1 - len2);
                return differences;
            }
            
            // Get location rating score for sorting
            getLocationScore(locationData) {
                const ratings = locationData.ratings || {};
                const values = Object.values(ratings);
                if (values.length === 0) return 0;
                
                const sum = values.reduce((acc, val) => acc + val, 0);
                return sum / values.length;
            }
            
            // Sort locations based on selected criteria
            sortLocations(locations, sortBy) {
                switch (sortBy) {
                    case 'name':
                        return locations.sort((a, b) => a.data.name.localeCompare(b.data.name));
                    case 'popularity':
                        return locations.sort((a, b) => {
                            const scoreA = this.getLocationScore(a.data);
                            const scoreB = this.getLocationScore(b.data);
                            return scoreB - scoreA; // Higher score first
                        });
                    case 'risk-low':
                        const riskOrder = { 'low': 1, 'moderate': 2, 'high': 3 };
                        return locations.sort((a, b) => {
                            const riskA = riskOrder[a.data.riskLevel] || 999;
                            const riskB = riskOrder[b.data.riskLevel] || 999;
                            return riskA - riskB;
                        });
                    case 'risk-high':
                        const riskOrderDesc = { 'high': 1, 'moderate': 2, 'low': 3 };
                        return locations.sort((a, b) => {
                            const riskA = riskOrderDesc[a.data.riskLevel] || 999;
                            const riskB = riskOrderDesc[b.data.riskLevel] || 999;
                            return riskA - riskB;
                        });
                    case 'recent':
                    default:
                        return locations.sort((a, b) => {
                            const timeA = a.data.createdAt?.toDate ? a.data.createdAt.toDate() : new Date(a.data.createdAt || 0);
                            const timeB = b.data.createdAt?.toDate ? b.data.createdAt.toDate() : new Date(b.data.createdAt || 0);
                            return timeB - timeA; // Newest first
                        });
                }
            }
            
            renderFilteredLocations() {
                if (!this.allUserLocations) return;

                const searchTerm = (document.getElementById('location-search')?.value || '').trim();
                const categoryFilter = document.getElementById('category-filter')?.value || '';
                const riskFilter = document.getElementById('risk-filter')?.value || '';
                const sortFilter = document.getElementById('sort-filter')?.value || 'recent';

                let filteredLocations = this.allUserLocations.filter(({ data }) => {
                    // Enhanced search filter with fuzzy matching and tags support
                    const matchesSearch = !searchTerm || this.fuzzyMatch(
                        [data.name, data.description, data.category, ...(data.tags || [])].join(' '), 
                        searchTerm
                    );

                    // Category filter
                    const matchesCategory = !categoryFilter || data.category === categoryFilter;

                    // Risk filter
                    const matchesRisk = !riskFilter || data.riskLevel === riskFilter;

                    return matchesSearch && matchesCategory && matchesRisk;
                });

                // Apply sorting
                filteredLocations = this.sortLocations(filteredLocations, sortFilter);

                const grid = document.getElementById('locations-grid');
                if (!grid) return;

                if (filteredLocations.length === 0) {
                    grid.innerHTML = '<div style="text-align: center; padding: 48px; color: var(--text-muted);">No locations match your search criteria.</div>';
                    return;
                }

                grid.innerHTML = '';
                grid.className = 'locations-grid';

                filteredLocations.forEach(({ id, data }) => {
                    const card = document.createElement('div');
                    card.className = 'location-card';
                    const locationScore = this.getLocationScore(data);
                    
                    card.innerHTML = `
                        <div class="location-header">
                            <h4>${this.escapeHtml(data.name)}</h4>
                            <span class="risk risk-${data.riskLevel}">${data.riskLevel}</span>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 12px;">${this.escapeHtml(data.description)}</p>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">
                            <i class="fas fa-tag"></i> ${this.escapeHtml(data.category)}
                            ${data.tags && data.tags.length > 0 ? `  <i class="fas fa-tags"></i> ${data.tags.map(tag => this.escapeHtml(tag)).join(', ')}` : ''}
                            ${data.coordinates ? `  <i class="fas fa-map-marker-alt"></i> ${data.coordinates[0].toFixed(4)}, ${data.coordinates[1].toFixed(4)}` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <button class="rating-btn" id="rate-up-${id}" onclick="app.rateLocation('${id}', 1)" title="Upvote location">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <div class="cz-text" style="font-size: 0.95rem;">Score: <span id="rating-score-${id}">${locationScore.toFixed(1)}</span></div>
                            <button class="rating-btn" id="rate-down-${id}" onclick="app.rateLocation('${id}', -1)" title="Downvote location">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                        <div class="location-actions">
                            <button class="btn" style="font-size: 0.8rem; padding: 4px 8px;" onclick="app.editLocation('${id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn" style="font-size: 0.8rem; padding: 4px 8px; background: var(--danger); color: white;" onclick="app.deleteLocation('${id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            <button class="btn" style="font-size: 0.8rem; padding: 4px 8px; background: var(--cz-blueprint); color: white;" onclick="app.focusMapOnLocation(${data.coordinates?.[0] || 0}, ${data.coordinates?.[1] || 0})">
                                <i class="fas fa-map"></i> View on Map
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                    this.loadLocationRating(id);
                });
                
                // Update map markers to reflect filtered results
                this.updateMapMarkers(filteredLocations);
            }
            
            updateMapMarkers(filteredLocations) {
                if (!this.map || !this.markerClusterGroup) return;
                
                try {
                    // Clear existing markers
                    this.markerClusterGroup.clearLayers();
                    
                    // Add markers for filtered locations
                    filteredLocations.forEach(({ id, data }) => {
                        if (data.coordinates && data.coordinates.length === 2) {
                            const [lat, lng] = data.coordinates;
                            const marker = this.createLocationMarker(id, data, lat, lng);
                            if (marker) {
                                this.markerClusterGroup.addLayer(marker);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error updating map markers:', error);
                }
            }
            
            createLocationMarker(id, data, lat, lng) {
                try {
                    // Create custom icon based on risk level
                    const riskColor = this.getRiskColor(data.riskLevel);
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'custom-location-marker',
                            html: `<div style="background: ${riskColor}; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    })
                        .bindTooltip(data.name || 'Unnamed Location', {
                            direction: 'top',
                            permanent: false,
                            offset: [0, -10]
                        })
                        .bindPopup(this.createLocationPopup(data, id));
                    
                    return marker;
                } catch (error) {
                    console.error('Error creating location marker:', error);
                    return null;
                }
            }

            // Profile photo upload methods
            async uploadProfilePhoto() {
                const fileInput = document.getElementById('profile-photo-upload');
                const uploadBtn = document.getElementById('upload-photo-btn');
                const progressDiv = document.getElementById('photo-progress');
                const progressBar = document.getElementById('photo-progress-bar');
                const progressText = document.getElementById('photo-progress-text');

                if (!fileInput.files || fileInput.files.length === 0) {
                    this.showToast('Please select a photo to upload', 'warning');
                    return;
                }

                const file = fileInput.files[0];

                // Validate file
                try {
                    this.validateImageFile(file);
                } catch (error) {
                    this.showToast(error.message, 'error');
                    return;
                }

                if (!this.currentUser) {
                    this.showToast('Please sign in to upload photos', 'warning');
                    return;
                }

                const opKey = 'photo-upload';
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                progressDiv.style.display = 'block';

                try {
                    const storageRef = this.storage.ref();
                    const photoRef = storageRef.child(`profile-photos/${this.currentUser.uid}/${Date.now()}_${file.name}`);

                    const uploadTask = photoRef.put(file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                            progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error('Upload error:', error);
                            this.showToast('Failed to upload photo', 'error');
                        },
                        async () => {
                            try {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                                // Update user profile with new photo URL
                                await this.currentUser.updateProfile({
                                    photoURL: downloadURL
                                });

                                // Update Firestore user document
                                await this.db.collection('users').doc(this.currentUser.uid).update({
                                    photoURL: downloadURL,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });

                                document.getElementById('profile-photo-url').value = downloadURL;
                                this.showToast('Profile photo uploaded successfully!', 'success');

                                // Refresh profile if currently viewing
                                if (document.getElementById('profile-view').classList.contains('active')) {
                                    this.loadProfile();
                                }
                            } catch (error) {
                                console.error('Error updating profile:', error);
                                this.showToast('Photo uploaded but failed to update profile', 'error');
                            }
                        }
                    );
                } catch (error) {
                    console.error('Upload setup error:', error);
                    this.showToast('Failed to start upload', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload';
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 2000);
                }
            }

            validateImageFile(file) {
                // Check file type
                const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('Please select a valid image file (JPG, PNG, WEBP, or GIF)');
                }

                // Check file size (5MB limit)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    throw new Error('File size must be less than 5MB');
                }

                // Check for malicious file names
                const suspiciousPatterns = [/[<>\"'&]/, /\.\./, /\/\//];
                if (suspiciousPatterns.some(pattern => pattern.test(file.name))) {
                    throw new Error('Invalid file name');
                }

                return true;
            }

            async loadProfile(userId = null) {
                const content = document.getElementById('profile-content');
                if (!content) return;

                // If no userId provided, show current user's profile
                const targetUserId = userId || this.currentUser?.uid;
                const isOwnProfile = targetUserId === this.currentUser?.uid;

                if (!targetUserId) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 80px 20px;">
                            <i class="fas fa-user-lock" style="font-size: 4rem; color: var(--text-muted); margin-bottom: 24px; display: block;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 16px;">Sign In Required</h3>
                            <p style="color: var(--text-muted); margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">
                                Create an account to build your urban exploration profile, track your locations, and connect with the community.
                            </p>
                            <button class="btn btn-primary" onclick="app.handleAuth()">
                                <i class="fas fa-sign-in-alt"></i> Sign In / Register
                            </button>
                        </div>
                    `;
                    return;
                }

                try {
                    content.innerHTML = '<div class="loading">Loading profile...</div>';

                    // Load user profile data and locations in parallel
                    const [userDoc, snapshot] = await Promise.all([
                        this.db.collection('users').doc(targetUserId).get(),
                        this.db.collection('locations')
                            .where('createdBy', '==', targetUserId)
                            .where('status', '==', 'active')
                            .get()
                    ]);

                    const userData = userDoc.exists ? userDoc.data() : {};

                    const locations = [];
                    snapshot.forEach(doc => {
                        locations.push({ id: doc.id, ...doc.data() });
                    });

                    const totalLocations = locations.length;
                    const username = userData.displayName || userData.email || 'Urban Explorer';
                    const userAvatar = userData.photoURL || null;
                    const userBio = userData.bio || '';
                    const joinedDate = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString() : 'Recently';
                    const bioHtml = userBio
                        ? `<p class="cz-text" style="margin: 0; color: var(--text-secondary);">${this.escapeHtml(userBio)}</p>`
                        : `<p class="cz-text" style="margin: 0; color: var(--text-muted); font-style: italic;">${isOwnProfile ? 'Add a short field note so others know your style.' : 'No bio shared yet.'}</p>`;

                    const highlights = locations.slice(0, 4);
                    const highlightHtml = highlights.length ? `
                        <div class="highlight-grid">
                            ${highlights.map(loc => {
                                const description = typeof loc.description === 'string' ? loc.description : '';
                                const trimmedDesc = this.escapeHtml(description.substring(0, 90));
                                const risk = loc.riskLevel || 'unknown';
                                const coords = loc.coordinates && Array.isArray(loc.coordinates)
                                    ? `<span class="cz-text" style="color: var(--text-muted); font-size: 0.8rem;"><i class="fas fa-location-arrow"></i> ${loc.coordinates[0].toFixed(4)}, ${loc.coordinates[1].toFixed(4)}</span>`
                                    : '';
                                return `
                                    <div class="profile-highlight">
                                        <div style="display: flex; justify-content: space-between; gap: 8px;">
                                            <h4 style="margin: 0; font-size: 1rem;">${this.escapeHtml(loc.name || 'Untitled')}</h4>
                                            <span class="risk risk-${risk}" style="text-transform: capitalize;">${risk}</span>
                                        </div>
                                        <div class="cz-text" style="color: var(--text-secondary); font-size: 0.9rem;">${trimmedDesc}${description.length > 90 ? '...' : ''}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div class="cz-text" style="color: var(--text-muted); font-size: 0.85rem;"><i class="fas fa-tag"></i> ${this.escapeHtml(loc.category || 'uncategorized')}</div>
                                            ${coords}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="profile-highlight" style="text-align: center; color: var(--text-muted);">
                            <i class="fas fa-map" style="font-size: 2rem; margin-bottom: 6px;"></i>
                            <div>${isOwnProfile ? 'No locations yet. Drop your first spot from the map.' : 'No locations to display yet.'}</div>
                        </div>
                    `;

                    const timelineHtml = locations.slice(0, 4).map(loc => {
                        const description = typeof loc.description === 'string' ? loc.description : '';
                        const timestamp = loc.createdAt?.toDate ? this.timeAgo(loc.createdAt.toDate()) : 'Recently';
                        return `
                            <li class="timeline-item">
                                <div class="timeline-dot" aria-hidden="true"></div>
                                <div>
                                    <div style="font-weight: 700;">${this.escapeHtml(loc.name || 'New location')}</div>
                                    <div class="cz-text" style="color: var(--text-secondary); font-size: 0.9rem;">${this.escapeHtml(description.substring(0, 80))}${description.length > 80 ? '...' : ''}</div>
                                    <div style="color: var(--text-muted); font-size: 0.8rem;"><i class="fas fa-clock"></i> ${timestamp}</div>
                                </div>
                            </li>
                        `;
                    }).join('') || `
                        <li class="timeline-item">
                            <div class="timeline-dot" aria-hidden="true"></div>
                            <div>
                                <div style="font-weight: 700;">${isOwnProfile ? 'Get your first ping in.' : 'No check-ins yet.'}</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">Activity updates appear after logging locations.</div>
                            </div>
                        </li>
                    `;

                    const linksList = Array.isArray(userData.links) ? userData.links.filter(Boolean) : [];
                    const linksHtml = linksList.length ? `
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${linksList.map(link => `
                                <a class="btn" style="width: fit-content;" href="${this.escapeHtml(link)}" target="_blank" rel="noopener">
                                    <i class="fas fa-external-link-alt" aria-hidden="true"></i> ${this.escapeHtml(link)}
                                </a>
                            `).join('')}
                        </div>
                    ` : `<div style="color: var(--text-muted);">No links shared.</div>`;

                    const galleryList = Array.isArray(userData.gallery) ? userData.gallery.filter(Boolean) : [];
                    const galleryHtml = galleryList.length ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                            ${galleryList.map(src => `
                                <div style="border: 2px solid var(--cz-black); background: var(--cz-concrete-dark); padding: 4px;">
                                    <img src="${this.escapeHtml(src)}" alt="Gallery item" style="width: 100%; height: 120px; object-fit: cover; display: block;">
                                </div>
                            `).join('')}
                        </div>
                    ` : `<div style="color: var(--text-muted);">No gallery images yet.</div>`;

                    content.innerHTML = `
                        <div class="profile-shell">
                            <section class="panel profile-hero" aria-label="Profile overview">
                                <div class="profile-avatar">
                                    ${userAvatar
                                        ? `<img src="${this.escapeHtml(userAvatar)}" alt="${this.escapeHtml(username)}" style="width: 100%; height: 100%; object-fit: cover;">`
                                        : `<span>${this.escapeHtml(username.charAt(0).toUpperCase())}</span>`
                                    }
                                </div>
                                <div class="profile-meta">
                                    <div class="chip live"><i class="fas fa-id-card" aria-hidden="true"></i> Explorer Dossier</div>
                                    <h2>${this.escapeHtml(username)}</h2>
                                    ${bioHtml}
                                    <div class="meta-chips" style="margin-top: 10px;">
                                        <span class="chip"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Joined ${joinedDate}</span>
                                        <span class="chip"><i class="fas fa-map-pin" aria-hidden="true"></i> ${totalLocations} locations</span>
                                        <span class="chip signal"><i class="fas fa-shield-alt" aria-hidden="true"></i> ${isOwnProfile ? 'Private controls on' : 'Public profile view'}</span>
                                    </div>
                                </div>
                                <div class="profile-actions">
                                    ${isOwnProfile ? `
                                        <button class="btn btn-primary" onclick="app.showEditProfile()"><i class="fas fa-edit" aria-hidden="true"></i> Edit Profile</button>
                                        <button class="btn" onclick="app.showAddLocationModal()"><i class="fas fa-plus" aria-hidden="true"></i> Add Location</button>
                                        <button class="btn" onclick="app.viewUserLocations('${targetUserId}')"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> View Locations</button>
                                    ` : `
                                        <button class="btn btn-primary" id="follow-btn-${targetUserId}" onclick="app.toggleFollow('${targetUserId}')"><i class="fas fa-user-plus" aria-hidden="true"></i> Follow</button>
                                        <button class="btn" onclick="app.messageUser('${targetUserId}')"><i class="fas fa-envelope" aria-hidden="true"></i> Message</button>
                                        <button class="btn" onclick="app.viewUserLocations('${targetUserId}')"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> Locations</button>
                                    `}
                                </div>
                            </section>

                            <section class="panel profile-stats" aria-label="Profile stats">
                                <div class="stat-grid">
                                    <div class="stat-card highlight">
                                        <div class="stat-label">Locations Logged</div>
                                        <div class="stat-value">${totalLocations}</div>
                                        <div class="stat-trend">Active contributions</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Followers</div>
                                        <div class="stat-value" id="profile-followers-count">--</div>
                                        <div class="stat-trend">Network reach</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Following</div>
                                        <div class="stat-value" id="profile-following-count">--</div>
                                        <div class="stat-trend">Explorers tracked</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Likes</div>
                                        <div class="stat-value" id="profile-likes-count">--</div>
                                        <div class="stat-trend">Appreciation on posts</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Visits</div>
                                        <div class="stat-value" id="profile-visits-count">--</div>
                                        <div class="stat-trend">Check-ins on your spots</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Badges</div>
                                        <div class="stat-value" id="profile-badges-count">--</div>
                                        <div class="stat-trend">Earned achievements</div>
                                    </div>
                                </div>
                            </section>

                            <div class="profile-grid">
                                <section class="panel profile-card" aria-label="Location highlights">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> Location Highlights</h3>
                                    ${highlightHtml}
                                    ${totalLocations > 4 ? `
                                        <div style="margin-top: 10px;">
                                            <button class="btn" type="button" onclick="app.showView('locations')">
                                                <i class="fas fa-th" aria-hidden="true"></i> View all ${totalLocations}
                                            </button>
                                        </div>
                                    ` : ''}
                                </section>

                                <section class="panel profile-card" aria-label="Activity timeline">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-stream" aria-hidden="true"></i> Activity Log</h3>
                                    <ul class="timeline">
                                        ${timelineHtml}
                                    </ul>
                                </section>
                            </div>

                            <div class="profile-grid">
                                <section class="panel profile-card" aria-label="Profile links">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-link" aria-hidden="true"></i> Links</h3>
                                    ${linksHtml}
                                </section>

                                <section class="panel profile-card" aria-label="Gallery">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-images" aria-hidden="true"></i> Gallery</h3>
                                    ${galleryHtml}
                                </section>
                            </div>

                            <section class="panel profile-card" aria-label="Profile feed">
                                <h3 style="margin-bottom: 12px;"><i class="fas fa-bullhorn" aria-hidden="true"></i> Posts</h3>
                                ${isOwnProfile ? `
                                    <div style="margin-bottom: 12px;">
                                        <textarea class="textarea" id="profile-post-input" rows="3" placeholder="Share an update or drop intel..."></textarea>
                                        <button class="btn btn-primary" style="margin-top: 8px;" onclick="app.submitProfilePost('${targetUserId}')"><i class="fas fa-paper-plane"></i> Post</button>
                                    </div>
                                ` : ''}
                                <div id="profile-posts-list" class="loading" role="status" aria-live="polite">Loading posts...</div>
                            </section>

                            <section class="panel profile-card" aria-label="Profile comments">
                                <h3 style="margin-bottom: 12px;"><i class="fas fa-comments" aria-hidden="true"></i> Comments</h3>
                                ${this.currentUser ? `
                                    <div style="margin-bottom: 12px;">
                                        <textarea class="textarea" id="profile-comment-input" rows="3" placeholder="Leave a note..."></textarea>
                                        <button class="btn btn-primary" style="margin-top: 8px;" onclick="app.submitProfileComment('${targetUserId}')"><i class="fas fa-comment"></i> Comment</button>
                                    </div>
                                ` : '<div style="color: var(--text-muted);">Sign in to comment.</div>'}
                                <div id="profile-comments-list" class="loading" role="status" aria-live="polite">Loading comments...</div>
                            </section>

                            <section class="panel profile-card" aria-label="Badges and achievements">
                                <h3 style="margin-bottom: 12px;"><i class="fas fa-award" aria-hidden="true"></i> Badges & Cred</h3>
                                <div id="user-badges" class="achievement-grid"></div>
                            </section>
                        </div>
                    `;

                    // Load and hydrate social stats/badges after rendering
                    this.loadUserSocialStats(targetUserId);
                    this.loadProfilePosts(targetUserId);
                    this.loadProfileComments(targetUserId);
                } catch (error) {
                    console.error('Error loading profile:', error);
                    content.innerHTML = '<div class="error">FAILED TO LOAD INSPECTION REPORT</div>';
                }
            }

            showAddLocationModal() {
                if (!this.currentUser) {
                    if (confirm('Sign in required to add locations. Would you like to sign in now?')) {
                        this.handleAuth();
                    }
                    return;
                }
                document.getElementById('location-modal').classList.add('active');
            }

            hideModal() {
                const modal = document.getElementById('location-modal');
                if (modal) {
                    modal.classList.remove('active');
                }

                const form = document.getElementById('location-form');
                if (form) {
                    form.reset();
                    // Clear edit mode
                    delete form.dataset.editId;
                    delete form.dataset.originalCoordinates;
                }

                // Reset modal title and button text
                const title = document.querySelector('#location-modal h3');
                if (title) title.textContent = 'Add Location';

                const submitBtn = document.querySelector('#location-form button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Save';

                this.selectedLatLng = null;
                const coordsDisplay = document.getElementById('coordinates-display');
                if (coordsDisplay) {
                    coordsDisplay.textContent = 'Click on map or use address to set location';
                    coordsDisplay.style.background = 'white';
                    coordsDisplay.style.color = 'var(--cz-yellow)';
                }

                // Clear address field
                const addressInput = document.getElementById('location-address');
                if (addressInput) {
                    addressInput.value = '';
                }

                // Remove temp marker
                if (this.tempMarker) {
                    this.map.removeLayer(this.tempMarker);
                    this.tempMarker = null;
                }

                // Clear tags
                this.clearTags();
            }

            handleMapClick(e) {
                if (document.getElementById('location-modal').classList.contains('active')) {
                    this.selectedLatLng = e.latlng;
                    document.getElementById('coordinates-display').textContent = 
                        `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;

                    // Drop or move a temporary marker so the user gets visual confirmation
                    if (this.tempMarker) {
                        this.map.removeLayer(this.tempMarker);
                    }
                    this.tempMarker = L.marker(e.latlng, { keyboard: false }).addTo(this.map);
                    const coordsDisplay = document.getElementById('coordinates-display');
                    if (coordsDisplay) {
                        coordsDisplay.style.background = '#fff';
                        coordsDisplay.style.color = 'var(--cz-black)';
                    }
                }
            }

            async handleLocationSubmit(e) {
                e.preventDefault();

                // Prevent double submissions while an in-flight save is running
                const opKey = 'location-submit';
                if (this.activeOperations.has(opKey)) {
                    return;
                }

                if (!this.currentUser) {
                    this.showToast('Please sign in to manage locations', 'warning');
                    return;
                }

                const name = document.getElementById('location-name').value.trim();
                const description = document.getElementById('location-description').value.trim();
                const category = document.getElementById('location-category').value;
                const riskLevel = document.getElementById('location-risk').value;
                const address = document.getElementById('location-address').value.trim();

                // Comprehensive validation
                const validationErrors = [];
                
                // Required field validation
                if (!name) validationErrors.push('Location name is required');
                if (!description) validationErrors.push('Description is required');
                
                // Length validation
                if (name && name.length < 3) validationErrors.push('Location name must be at least 3 characters');
                if (name && name.length > 100) validationErrors.push('Location name must be less than 100 characters');
                if (description && description.length < 10) validationErrors.push('Description must be at least 10 characters');
                if (description && description.length > 1000) validationErrors.push('Description must be less than 1000 characters');
                if (address && address.length > 200) validationErrors.push('Address must be less than 200 characters');
                
                // Content validation
                if (name && !/^[a-zA-Z0-9\s\-_.,!?()\[\]]+$/.test(name)) {
                    validationErrors.push('Location name contains invalid characters');
                }
                
                // Coordinate validation
                const existingCoords = (() => {
                    try {
                        const raw = e.target.dataset.originalCoordinates;
                        return raw ? JSON.parse(raw) : null;
                    } catch {
                        return null;
                    }
                })();
                const coordsToSave = this.selectedLatLng
                    ? [this.selectedLatLng.lat, this.selectedLatLng.lng]
                    : existingCoords;

                if (!coordsToSave) {
                    validationErrors.push('Please select a location on the map');
                }
                
                // Validate coordinates are within valid ranges
                if (coordsToSave) {
                    const [lat, lng] = coordsToSave;
                    if (isNaN(lat) || isNaN(lng)) {
                        validationErrors.push('Invalid coordinates');
                    } else if (lat < -90 || lat > 90) {
                        validationErrors.push('Latitude must be between -90 and 90');
                    } else if (lng < -180 || lng > 180) {
                        validationErrors.push('Longitude must be between -180 and 180');
                    }
                }
                
                // Tags validation
                const tags = this.getSelectedTags();
                if (tags.length > 10) {
                    validationErrors.push('Maximum 10 tags allowed');
                }
                for (const tag of tags) {
                    if (tag.length > 25) {
                        validationErrors.push('Each tag must be less than 25 characters');
                        break;
                    }
                }
                
                // Display validation errors
                if (validationErrors.length > 0) {
                    const errorMessage = validationErrors.join('. ');
                    this.showToast(errorMessage, 'warning');
                    this.announceFormErrors(validationErrors.map(msg => ({ message: msg })));
                    return;
                }



                this.activeOperations.add(opKey);
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;

                const formData = {
                    name: this.sanitizeInput(name),
                    description: this.sanitizeInput(description),
                    category: document.getElementById('location-category').value,
                    riskLevel: document.getElementById('location-risk').value,
                    address: this.sanitizeInput(document.getElementById('location-address').value.trim()),
                    tags: this.getSelectedTags(),
                    coordinates: coordsToSave,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const editId = e.target.dataset.editId;

                    if (editId) {
                        // Update existing location
                        await this.db.collection('locations').doc(editId).update(formData);
                        this.showToast('Location updated successfully!', 'success');
                    } else {
                        // Create new location
                        formData.createdBy = this.currentUser.uid;
                        formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        formData.status = 'active';
                        await this.db.collection('locations').add(formData);
                        this.showToast('Location added successfully!', 'success');
                    }

                    this.hideModal();
                    this.loadStats();

                    // Refresh user locations if on that view
                    const locationsView = document.getElementById('locations-view');
                    if (locationsView && locationsView.classList.contains('active')) {
                        this.loadUserLocations();
                    }

                } catch (error) {
                    console.error('Error saving location:', error);
                    let message = 'Failed to save location';
                    if (error.code === 'permission-denied') {
                        message = 'You do not have permission to modify this location';
                    } else if (error.code === 'not-found') {
                        message = 'Location not found';
                    }
                    this.showToast(message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    this.activeOperations.delete(opKey);
                }
            }
            
            sanitizeInput(input) {
                return input.replace(/<script[^>]*>.*?<\/script>/gi, '')
                           .replace(/<[^>]*>/g, '')
                           .trim();
            }
            
            showError(message) {
                this.showToast(message, 'error');
            }

            showLocationPhotos(locationId) {
                // Load and display photos in a modal
                this.db.collection('locations').doc(locationId).get().then(doc => {
                    if (!doc.exists) return;
                    const data = doc.data();
                    if (!data.photos || !Array.isArray(data.photos)) return;
                    
                    this.showPhotoModal(data.photos, data.name || 'Location Photos');
                }).catch(error => {
                    console.error('Error loading location photos:', error);
                    this.showToast('Failed to load photos', 'error');
                });
            }
            
            showLocationPhotoModal(locationId, photoIndex) {
                this.db.collection('locations').doc(locationId).get().then(doc => {
                    if (!doc.exists) return;
                    const data = doc.data();
                    if (!data.photos || !Array.isArray(data.photos) || photoIndex >= data.photos.length) return;
                    
                    this.showPhotoModal(data.photos, data.name || 'Location Photos', photoIndex);
                }).catch(error => {
                    console.error('Error loading location photo:', error);
                    this.showToast('Failed to load photo', 'error');
                });
            }
            
            showPhotoModal(photos, title = 'Photos', startIndex = 0) {
                // Create photo modal
                const modal = document.createElement('div');
                modal.className = 'modal location-detail-modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: auto; height: auto;">
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        <div style="text-align: center; margin-bottom: 16px;">
                            <h3>${this.escapeHtml(title)}</h3>
                            <div style="font-size: 0.9em; color: var(--text-muted);">${photos.length} photo${photos.length !== 1 ? 's' : ''}</div>
                        </div>
                        <div id="photo-gallery" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-height: 70vh; overflow-y: auto;">
                            ${photos.map((photo, index) => 
                                `<img src="${this.escapeHtml(photo)}" alt="Photo ${index + 1}" 
                                     style="max-width: 200px; max-height: 200px; object-fit: cover; border: 2px solid var(--cz-black); cursor: pointer;"
                                     onclick="window.currentPhotoIndex = ${index}; window.currentPhotos = ${JSON.stringify(photos)}; app.showFullScreenPhoto()">`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            showFullScreenPhoto() {
                const photos = window.currentPhotos;
                const index = window.currentPhotoIndex;
                
                if (!photos || index === undefined) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div style="position: relative; max-width: 95vw; max-height: 95vh;">
                        <img src="${this.escapeHtml(photos[index])}" alt="Photo ${index + 1}" 
                             style="max-width: 100%; max-height: 100%; object-fit: contain; border: 4px solid var(--cz-black);">
                        <button class="modal-close" onclick="this.closest('.modal').remove()" style="top: 8px; right: 8px;">&times;</button>
                        ${photos.length > 1 ? `
                            <button onclick="window.currentPhotoIndex = (${index} - 1 + ${photos.length}) % ${photos.length}; app.showFullScreenPhoto()" 
                                    style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 8px 12px; cursor: pointer;">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="window.currentPhotoIndex = (${index} + 1) % ${photos.length}; app.showFullScreenPhoto()" 
                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 8px 12px; cursor: pointer;">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <div style="position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; font-size: 0.9em;">
                                ${index + 1} / ${photos.length}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Remove the photo gallery modal
                const galleryModal = document.querySelector('.location-detail-modal');
                if (galleryModal) galleryModal.remove();
                
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            showToast(message, type = 'info', duration = 3000) {
                // Remove any existing toasts
                document.querySelectorAll('.toast').forEach(t => t.remove());

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
                toast.setAttribute('aria-atomic', 'true');

                // Type-specific icons and colors
                const typeConfigs = {
                    error: {
                        icon: 'fa-exclamation-circle',
                        borderColor: 'var(--danger)',
                        color: 'var(--danger)',
                        background: 'linear-gradient(to bottom, var(--cz-concrete-light), var(--cz-concrete))'
                    },
                    success: {
                        icon: 'fa-check-circle',
                        borderColor: 'var(--success)',
                        color: 'var(--success)',
                        background: 'linear-gradient(to bottom, var(--cz-concrete-light), var(--cz-concrete))'
                    },
                    warning: {
                        icon: 'fa-exclamation-triangle',
                        borderColor: 'var(--warning)',
                        color: 'var(--warning)',
                        background: 'linear-gradient(to bottom, var(--cz-concrete-light), var(--cz-concrete))'
                    },
                    info: {
                        icon: 'fa-info-circle',
                        borderColor: 'var(--accent-blue)',
                        color: 'var(--accent-blue)',
                        background: 'linear-gradient(to bottom, var(--cz-concrete-light), var(--cz-concrete))'
                    }
                };

                const config = typeConfigs[type] || typeConfigs.info;

                toast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas ${config.icon}" style="font-size: 1.2rem; color: ${config.color};" aria-hidden="true"></i>
                        <span class="cz-text" style="flex: 1; color: var(--cz-black);">${message}</span>
                        <button class="btn-close" aria-label="Close notification" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                `;

                const styles = {
                    position: 'fixed',
                    top: '80px',
                    right: '20px',
                    background: config.background,
                    padding: '12px 16px',
                    border: `3px solid ${config.borderColor}`,
                    borderRadius: '0',
                    zIndex: '3000',
                    boxShadow: 'var(--shadow-industrial), 0 0 20px ' + config.color,
                    maxWidth: '400px',
                    minWidth: '250px',
                    animation: 'slideIn 0.3s ease-out',
                    fontFamily: 'var(--font-blueprint), Arial, sans-serif',
                    fontSize: '12px',
                    fontWeight: '600'
                };

                Object.assign(toast.style, styles);

                // Add highlight bar
                const highlight = document.createElement('div');
                highlight.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 2px;
                    background: linear-gradient(to right, transparent, #FFFFFF, transparent);
                `;
                toast.appendChild(highlight);

                // Add close button styles
                const closeBtn = toast.querySelector('.btn-close');
                closeBtn.style.cssText = `
                    background: none;
                    border: none;
                    color: var(--cz-black);
                    cursor: pointer;
                    padding: 2px;
                    margin-left: auto;
                `;

                document.body.appendChild(toast);

                // Announce to screen reader
                this.announceToScreenReader(message, type === 'error' ? 'assertive' : 'polite');

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            validateFormField(input, errorElementId, validationMessage) {
                const errorElement = document.getElementById(errorElementId);
                if (validationMessage) {
                    // Show error
                    input.setAttribute('aria-invalid', 'true');
                    input.setAttribute('aria-describedby', errorElementId);
                    if (errorElement) {
                        errorElement.textContent = validationMessage;
                        errorElement.style.display = 'block';
                    }
                    return false;
                } else {
                    // Clear error
                    input.setAttribute('aria-invalid', 'false');
                    input.removeAttribute('aria-describedby');
                    if (errorElement) {
                        errorElement.textContent = '';
                        errorElement.style.display = 'none';
                    }
                    return true;
                }
            }

            announceFormErrors(errors) {
                if (errors.length > 0) {
                    const errorList = errors.map(error => error.message).join(', ');
                    this.announceToScreenReader(`Form validation errors: ${errorList}`, 'assertive');
                }
            }

            async deleteLocation(id) {
                if (!confirm('Are you sure you want to delete this location? This action cannot be undone.')) return;

                const opKey = `delete-${id}`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    await this.db.collection('locations').doc(id).update({
                        status: 'deleted',
                        deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    this.loadUserLocations();
                    this.loadStats();
                    this.showToast('Location deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting location:', error);
                    this.showToast('Failed to delete location. Please try again.', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async editLocation(id) {
                try {
                    const doc = await this.db.collection('locations').doc(id).get();
                    if (!doc.exists) {
                        this.showToast('Location not found', 'error');
                        return;
                    }

                    const data = doc.data();

                    // Check if user owns this location
                    if (data.createdBy !== this.currentUser.uid) {
                        this.showToast('You can only edit your own locations', 'error');
                        return;
                    }

                    // Populate the form with existing data
                    document.getElementById('location-name').value = data.name || '';
                    document.getElementById('location-description').value = data.description || '';
                    document.getElementById('location-category').value = data.category || 'other';
                    document.getElementById('location-risk').value = data.riskLevel || 'moderate';

                    // Set address if available
                    if (data.address) {
                        document.getElementById('location-address').value = data.address;
                    }

                    // Set coordinates if available
                    if (data.coordinates && Array.isArray(data.coordinates) && data.coordinates.length === 2) {
                        this.selectedLatLng = { lat: data.coordinates[0], lng: data.coordinates[1] };
                        document.getElementById('coordinates-display').textContent =
                            `${data.coordinates[0].toFixed(6)}, ${data.coordinates[1].toFixed(6)}`;
                        document.getElementById('coordinates-display').style.background = 'white';
                    }

                    // Load tags if available
                    this.loadTagsForLocation(data);

                    // Change form title and button
                    document.querySelector('#location-modal h3').textContent = 'Edit Location';
                    document.querySelector('#location-form button[type="submit"]').textContent = 'Update Location';

                    // Store the location ID for update
                    document.getElementById('location-form').dataset.editId = id;
                    document.getElementById('location-form').dataset.originalCoordinates = JSON.stringify(data.coordinates || null);

                    this.showAddLocationModal();

                } catch (error) {
                    console.error('Error loading location for edit:', error);
                    this.showToast('Failed to load location for editing', 'error');
                }
            }

            async handleAuth() {
                if (this.currentUser && !this.currentUser.isAnonymous) {
                    // Sign out
                    const opKey = 'auth-signout';
                    if (this.activeOperations.has(opKey)) return;
                    this.activeOperations.add(opKey);

                    try {
                        await this.auth.signOut();
                        this.showToast('Signed out successfully', 'success');
                    } catch (error) {
                        console.error('Sign out error:', error);
                        this.showToast('Failed to sign out', 'error');
                    } finally {
                        this.activeOperations.delete(opKey);
                    }
                    return;
                }

                // Show auth modal for guests/anonymous users
                this.showAuthModal();
            }

            showAuthModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.add('active');
                    modal.setAttribute('aria-hidden', 'false');
                    // Store return focus
                    const authBtn = document.getElementById('auth-btn');
                    if (authBtn) {
                        authBtn.setAttribute('data-return-focus', 'auth-btn');
                    }
                    // Focus on first input
                    setTimeout(() => {
                        const firstInput = modal.querySelector('input');
                        if (firstInput) firstInput.focus();
                    }, 100);
                    this.announceToScreenReader('Authentication dialog opened', 'assertive');
                }
            }

            hideAuthModal() {
                const modal = document.getElementById('auth-modal');
                if (modal) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                    // Reset forms
                    const forms = modal.querySelectorAll('form');
                    forms.forEach(form => form.reset());
                    // Reset to sign-in tab
                    this.switchAuthTab('signin');
                    this.announceToScreenReader('Authentication dialog closed');
                }
            }

            switchAuthTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    const isActive = tab.dataset.tab === tabName;
                    tab.classList.toggle('active', isActive);
                    tab.setAttribute('aria-selected', isActive);
                });

                // Update form visibility
                document.querySelectorAll('.auth-form').forEach(form => {
                    const isActive = form.id === `${tabName}-form`;
                    form.classList.toggle('active', isActive);
                    form.setAttribute('aria-hidden', !isActive);
                });
                
                this.announceToScreenReader(`Switched to ${tabName} tab`);
                
                // Focus on first input in active form
                setTimeout(() => {
                    const activeForm = document.querySelector('.auth-form.active');
                    const firstInput = activeForm?.querySelector('input');
                    if (firstInput) firstInput.focus();
                }, 100);
            }

            async handleSignIn(e) {
                e.preventDefault();

                const email = document.getElementById('signin-email').value.trim();
                const password = document.getElementById('signin-password').value.trim();

                // Validate inputs
                const emailInput = document.getElementById('signin-email');
                const passwordInput = document.getElementById('signin-password');
                
                if (!this.validateEmail(emailInput) || !password) {
                    this.showToast('Please correct the errors above', 'warning');
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Signing In...';
                submitBtn.disabled = true;

                try {
                    await this.auth.signInWithEmailAndPassword(email, password);
                    this.hideAuthModal();
                    this.showToast('Signed in successfully!', 'success');
                } catch (error) {
                    console.error('Sign in error:', error);
                    let message = 'Failed to sign in';
                    switch (error.code) {
                        case 'auth/user-not-found':
                            message = 'No account found with this email';
                            break;
                        case 'auth/wrong-password':
                            message = 'Incorrect password';
                            break;
                        case 'auth/invalid-email':
                            message = 'Invalid email address';
                            break;
                        case 'auth/user-disabled':
                            message = 'This account has been disabled';
                            break;
                        case 'auth/too-many-requests':
                            message = 'Too many failed attempts. Please try again later.';
                            break;
                        case 'auth/invalid-credential':
                            message = 'Invalid email or password';
                            break;
                        default:
                            message = error.message;
                    }
                    this.showToast(message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }

            async handleSignUp(e) {
                e.preventDefault();

                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value.trim();
                const confirmPassword = document.getElementById('signup-confirm-password').value.trim();

                // Validate inputs using enhanced validation
                const emailInput = document.getElementById('signup-email');
                const passwordInput = document.getElementById('signup-password');
                const confirmPasswordInput = document.getElementById('signup-confirm-password');
                
                const isEmailValid = this.validateEmail(emailInput);
                const isPasswordValid = this.validatePassword(passwordInput);
                const isConfirmPasswordValid = this.validatePasswordConfirmation();
                
                if (!isEmailValid || !isPasswordValid || !isConfirmPasswordValid) {
                    this.showToast('Please correct the errors above', 'warning');
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating Account...';
                submitBtn.disabled = true;

                try {
                    const result = await this.auth.createUserWithEmailAndPassword(email, password);
                    
                    // Create user profile
                    await this.createUserProfile(result.user, 'email');
                    
                    // Send email verification
                    await result.user.sendEmailVerification();
                    
                    this.hideAuthModal();
                    this.showToast('Account created! Please check your email to verify your account.', 'success');
                } catch (error) {
                    console.error('Sign up error:', error);
                    let message = 'Failed to create account';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            message = 'An account with this email already exists';
                            break;
                        case 'auth/invalid-email':
                            message = 'Invalid email address';
                            break;
                        case 'auth/weak-password':
                            message = 'Password is too weak';
                            break;
                        case 'auth/operation-not-allowed':
                            message = 'Email/password accounts are not enabled';
                            break;
                        case 'auth/too-many-requests':
                            message = 'Too many requests. Please try again later.';
                            break;
                        default:
                            message = error.message;
                    }
                    this.showToast(message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }

            async signInAnonymously() {
                try {
                    await this.auth.signInAnonymously();
                    this.hideAuthModal();
                    this.showToast('Signed in as guest', 'success');
                } catch (error) {
                    console.error('Anonymous sign in error:', error);
                    if (error.code === 'auth/admin-restricted-operation') {
                        this.showToast('Anonymous sign-in is currently disabled. Please use email sign-in.', 'warning');
                    } else {
                        this.showToast('Failed to sign in anonymously', 'error');
                    }
                }
            }

            // ====================
            // ENHANCED AUTH METHODS
            // ====================

            initOAuthButtons() {
                // Google OAuth buttons
                const googleSignInBtn = document.getElementById('google-signin-btn');
                const googleSignUpBtn = document.getElementById('google-signup-btn');
                
                if (googleSignInBtn) {
                    googleSignInBtn.addEventListener('click', () => this.signInWithProvider('google'));
                }
                if (googleSignUpBtn) {
                    googleSignUpBtn.addEventListener('click', () => this.signUpWithProvider('google'));
                }

                // GitHub OAuth buttons
                const githubSignInBtn = document.getElementById('github-signin-btn');
                const githubSignUpBtn = document.getElementById('github-signup-btn');
                
                if (githubSignInBtn) {
                    githubSignInBtn.addEventListener('click', () => this.signInWithProvider('github'));
                }
                if (githubSignUpBtn) {
                    githubSignUpBtn.addEventListener('click', () => this.signUpWithProvider('github'));
                }
            }

            async signInWithProvider(provider) {
                const opKey = `oauth-${provider}-signin`;
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                try {
                    const providerObj = this.getProvider(provider);
                    const result = await this.auth.signInWithPopup(providerObj);
                    
                    // Handle new user
                    if (result.user && result.user.metadata.creationTime === result.user.metadata.lastSignInTime) {
                        await this.createUserProfile(result.user, provider);
                        this.showToast(`Welcome to Urbindex! Account created with ${provider}.`, 'success');
                    } else {
                        this.showToast(`Signed in successfully with ${provider}!`, 'success');
                    }
                    
                    this.hideAuthModal();
                } catch (error) {
                    console.error(`${provider} sign in error:`, error);
                    let message = `Failed to sign in with ${provider}`;
                    switch (error.code) {
                        case 'auth/popup-closed-by-user':
                            message = 'Sign in cancelled';
                            break;
                        case 'auth/popup-blocked':
                            message = 'Pop-up blocked. Please allow pop-ups for this site.';
                            break;
                        case 'auth/cancelled-popup-request':
                            message = 'Sign in request cancelled';
                            break;
                        case 'auth/account-exists-with-different-credential':
                            message = `An account already exists with the same email but different credentials`;
                            break;
                        default:
                            message = error.message;
                    }
                    this.showToast(message, 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                }
            }

            async signUpWithProvider(provider) {
                // For OAuth, sign up and sign in are the same operation
                await this.signInWithProvider(provider);
            }

            getProvider(providerName) {
                switch (providerName) {
                    case 'google':
                        return new firebase.auth.GoogleAuthProvider();
                    case 'github':
                        return new firebase.auth.GithubAuthProvider();
                    default:
                        throw new Error(`Unsupported provider: ${providerName}`);
                }
            }

            async createUserProfile(user, provider) {
                try {
                    const userData = {
                        email: user.email,
                        displayName: user.displayName || `Explorer ${user.uid.substring(0, 6)}`,
                        photoURL: user.photoURL,
                        provider: provider,
                        emailVerified: user.emailVerified,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await this.db.collection('users').doc(user.uid).set(userData, { merge: true });
                } catch (error) {
                    console.error('Error creating user profile:', error);
                }
            }

            initFormValidation() {
                // Real-time email validation
                const emailInputs = ['signin-email', 'signup-email'];
                emailInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', () => this.validateEmail(input));
                        input.addEventListener('blur', () => this.validateEmail(input));
                    }
                });

                // Real-time password validation for sign up
                const passwordInput = document.getElementById('signup-password');
                if (passwordInput) {
                    passwordInput.addEventListener('input', () => this.validatePassword(passwordInput));
                    passwordInput.addEventListener('blur', () => this.validatePassword(passwordInput));
                }

                // Password confirmation validation
                const confirmPasswordInput = document.getElementById('signup-confirm-password');
                if (confirmPasswordInput) {
                    confirmPasswordInput.addEventListener('input', () => this.validatePasswordConfirmation());
                    confirmPasswordInput.addEventListener('blur', () => this.validatePasswordConfirmation());
                }
            }

            // Enhanced authentication error handling and validation
            getAuthErrorMessage(error) {
                const errorCodes = {
                    'auth/user-not-found': 'No account found with this email address.',
                    'auth/wrong-password': 'Incorrect password. Please try again.',
                    'auth/email-already-in-use': 'An account with this email already exists.',
                    'auth/weak-password': 'Password is too weak. Please choose a stronger password.',
                    'auth/invalid-email': 'Please enter a valid email address.',
                    'auth/invalid-credential': 'Invalid login credentials. Please check your email and password.',
                    'auth/user-disabled': 'This account has been disabled. Please contact support.',
                    'auth/too-many-requests': 'Too many failed attempts. Please wait 15 minutes before trying again.',
                    'auth/network-request-failed': 'Network error. Please check your connection and try again.',
                    'auth/popup-closed-by-user': 'Sign-in popup was closed. Please try again.',
                    'auth/popup-blocked': 'Sign-in popup was blocked. Please allow popups and try again.',
                    'auth/requires-recent-login': 'Please sign out and sign back in to perform this action.',
                    'auth/operation-not-allowed': 'This sign-in method is not enabled. Please contact support.',
                    'auth/quota-exceeded': 'Service temporarily unavailable. Please try again later.',
                    'auth/argument-error': 'Invalid authentication parameters. Please try again.',
                    'auth/timeout': 'Request timed out. Please check your connection and try again.',
                    'auth/cancelled-popup-request': 'Multiple popup requests detected. Please try again.',
                    'auth/email-not-verified': 'Please verify your email address before signing in.',
                    'auth/credential-already-in-use': 'This credential is already associated with a different account.'
                };

                // Check for specific error codes first
                if (errorCodes[error.code]) {
                    return errorCodes[error.code];
                }

                // Handle network and generic errors
                if (error.message) {
                    if (error.message.includes('Network Error') || error.message.includes('fetch')) {
                        return 'Network error. Please check your internet connection and try again.';
                    }
                    if (error.message.includes('timeout')) {
                        return 'Request timed out. Please try again.';
                    }
                    if (error.message.includes('popup')) {
                        return 'Popup was blocked or closed. Please allow popups and try again.';
                    }
                }

                // Default error message
                return 'An unexpected error occurred. Please try again.';
            }

            // Rate limiting warning display
            showRateLimitWarning() {
                const warning = document.createElement('div');
                warning.className = 'rate-limit-warning';
                warning.innerHTML = `
                    <div style="background: var(--cz-red); color: white; padding: 12px; margin: 8px 0; border: 2px solid var(--cz-black); font-family: var(--font-stencil); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i> Too many failed attempts. Please wait before trying again.
                    </div>
                `;
                
                const authModal = document.getElementById('auth-modal');
                if (authModal && authModal.classList.contains('active')) {
                    const modalContent = authModal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.insertBefore(warning, modalContent.firstChild.nextSibling);
                        
                        // Remove warning after 10 seconds
                        setTimeout(() => {
                            if (warning.parentNode) {
                                warning.remove();
                            }
                        }, 10000);
                    }
                }
            }

            // Enhanced password strength validation
            validatePasswordStrength(password) {
                const checks = {
                    length: password.length >= 8,
                    lowercase: /[a-z]/.test(password),
                    uppercase: /[A-Z]/.test(password),
                    numbers: /\d/.test(password),
                    symbols: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };
                
                const passedChecks = Object.values(checks).filter(Boolean).length;
                let strength = 'weak';
                
                if (passedChecks >= 4) {
                    strength = 'strong';
                } else if (passedChecks >= 3) {
                    strength = 'good';
                } else if (passedChecks >= 2) {
                    strength = 'fair';
                }
                
                return { strength, checks, passedChecks };
            }

            // Enhanced session management with timeout warnings
            initSessionManagement() {
                // Set up session timeout (30 minutes)
                this.sessionTimeout = 30 * 60 * 1000; // 30 minutes in milliseconds
                this.warningTime = 5 * 60 * 1000; // 5 minutes warning
                
                this.lastActivity = Date.now();
                
                // Track user activity
                ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                    document.addEventListener(event, () => {
                        this.lastActivity = Date.now();
                    }, true);
                });
                
                // Check session timeout every minute
                setInterval(() => {
                    this.checkSessionTimeout();
                }, 60000); // Check every minute
                
                // Initial check
                this.checkSessionTimeout();
            }
            
            checkSessionTimeout() {
                if (!this.currentUser || this.currentUser.isAnonymous) {
                    return; // Don't timeout anonymous users
                }
                
                const now = Date.now();
                const timeSinceActivity = now - this.lastActivity;
                
                if (timeSinceActivity >= this.sessionTimeout) {
                    // Session expired
                    this.handleSessionExpired();
                } else if (timeSinceActivity >= (this.sessionTimeout - this.warningTime)) {
                    // Show warning
                    this.showSessionWarning();
                } else {
                    // Hide warning if shown
                    this.hideSessionWarning();
                }
            }
            
            showSessionWarning() {
                const sessionWarning = document.getElementById('session-warning');
                if (sessionWarning) {
                    sessionWarning.style.display = 'block';
                    
                    const timeLeft = Math.ceil((this.sessionTimeout - (Date.now() - this.lastActivity)) / 60000);
                    const countdownElement = document.getElementById('session-countdown');
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    
                    // Add warning class for visual emphasis
                    sessionWarning.classList.add('warning');
                }
            }
            
            hideSessionWarning() {
                const sessionWarning = document.getElementById('session-warning');
                if (sessionWarning) {
                    sessionWarning.style.display = 'none';
                    sessionWarning.classList.remove('warning');
                }
            }
            
            async handleSessionExpired() {
                try {
                    await this.auth.signOut();
                    this.currentUser = null;
                    this.hideSessionWarning();
                    this.updateAuthUI();
                    this.showToast('Your session has expired. Please sign in again.', 'warning');
                } catch (error) {
                    console.error('Session cleanup error:', error);
                }
            }
            
            async refreshSession() {
                try {
                    if (this.currentUser) {
                        await this.currentUser.getIdToken(true); // Force token refresh
                        this.lastActivity = Date.now();
                        this.hideSessionWarning();
                    }
                } catch (error) {
                    console.error('Session refresh failed:', error);
                    this.handleSessionExpired();
                }
            }

            // Rate limiting for authentication attempts
            initRateLimiting() {
                this.authAttempts = new Map();
                this.maxAttempts = 5;
                this.attemptWindow = 15 * 60 * 1000; // 15 minutes
            }
            
            checkRateLimit(identifier) {
                const now = Date.now();
                const attempts = this.authAttempts.get(identifier) || [];
                
                // Remove old attempts outside the window
                const recentAttempts = attempts.filter(time => now - time < this.attemptWindow);
                
                if (recentAttempts.length >= this.maxAttempts) {
                    return false; // Rate limited
                }
                
                return true; // Not rate limited
            }
            
            recordAuthAttempt(identifier) {
                const now = Date.now();
                const attempts = this.authAttempts.get(identifier) || [];
                
                // Remove old attempts and add new one
                const recentAttempts = attempts.filter(time => now - time < this.attemptWindow);
                recentAttempts.push(now);
                
                this.authAttempts.set(identifier, recentAttempts);
            }

            // Enhanced form validation with comprehensive edge case coverage
            validateFormInput(input, type) {
                const value = input.value.trim();
                const errors = [];
                
                switch (type) {
                    case 'email':
                        if (!value) {
                            errors.push('Email address is required');
                        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                            errors.push('Please enter a valid email address');
                        } else if (value.length > 254) {
                            errors.push('Email address is too long');
                        }
                        break;
                        
                    case 'password':
                        if (!value) {
                            errors.push('Password is required');
                        } else {
                            const strength = this.validatePasswordStrength(value);
                            if (strength.checks.length < 3) {
                                errors.push('Password must be at least 8 characters with uppercase, lowercase, and numbers');
                            }
                            if (value.length > 128) {
                                errors.push('Password is too long (maximum 128 characters)');
                            }
                        }
                        break;
                        
                    case 'confirmPassword':
                        const password = document.getElementById('signup-password')?.value;
                        if (!value) {
                            errors.push('Please confirm your password');
                        } else if (password && value !== password) {
                            errors.push('Passwords do not match');
                        }
                        break;
                        
                    case 'displayName':
                        if (!value) {
                            errors.push('Display name is required');
                        } else if (value.length < 2) {
                            errors.push('Display name must be at least 2 characters');
                        } else if (value.length > 50) {
                            errors.push('Display name is too long (maximum 50 characters)');
                        } else if (!/^[a-zA-Z0-9\s\-_]+$/.test(value)) {
                            errors.push('Display name can only contain letters, numbers, spaces, hyphens, and underscores');
                        }
                        break;
                }
                
                return errors;
            }
            
            displayFieldError(input, errors) {
                const errorElement = input.parentNode.querySelector('.field-error');
                const successElement = input.parentNode.querySelector('.field-success');
                
                // Clear previous states
                input.classList.remove('error', 'success');
                if (errorElement) errorElement.style.display = 'none';
                if (successElement) successElement.style.display = 'none';
                
                if (errors.length > 0) {
                    input.classList.add('error');
                    if (errorElement) {
                        errorElement.textContent = errors[0];
                        errorElement.style.display = 'flex';
                    }
                } else if (input.value.trim()) {
                    input.classList.add('success');
                    if (successElement) {
                        successElement.innerHTML = '<i class="fas fa-check"></i> Valid';
                        successElement.style.display = 'flex';
                    }
                }
            }

            validateEmail(input) {
                const email = input.value.trim();
                const errorElement = document.getElementById(`${input.id}-error`);
                
                // Remove existing classes
                input.classList.remove('error', 'success');
                
                if (!email) {
                    this.showFieldError(input, errorElement, 'Email is required');
                    return false;
                }
                
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (!emailRegex.test(email)) {
                    this.showFieldError(input, errorElement, 'Please enter a valid email address');
                    return false;
                }
                
                this.showFieldSuccess(input, errorElement, 'Valid email address');
                return true;
            }

            validatePassword(input) {
                const password = input.value;
                const errorElement = document.getElementById(`${input.id}-error`);
                const strengthFill = document.getElementById('password-strength-fill');
                const strengthText = document.getElementById('password-strength-text');
                
                // Remove existing classes
                input.classList.remove('error', 'success');
                
                if (!password) {
                    this.showFieldError(input, errorElement, 'Password is required');
                    this.updatePasswordStrength('', strengthFill, strengthText);
                    return false;
                }
                
                const validation = this.checkPasswordStrength(password);
                
                if (!validation.isValid) {
                    this.showFieldError(input, errorElement, validation.message);
                    this.updatePasswordStrength(password, strengthFill, strengthText);
                    return false;
                }
                
                this.showFieldSuccess(input, errorElement, 'Strong password');
                this.updatePasswordStrength(password, strengthFill, strengthText);
                
                // Re-validate password confirmation if it exists
                this.validatePasswordConfirmation();
                
                return true;
            }

            checkPasswordStrength(password) {
                const checks = {
                    length: password.length >= 8,
                    lowercase: /[a-z]/.test(password),
                    uppercase: /[A-Z]/.test(password),
                    numbers: /\d/.test(password),
                    symbols: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };
                
                const passedChecks = Object.values(checks).filter(Boolean).length;
                
                if (password.length === 0) {
                    return { isValid: false, message: 'Password is required', strength: 0 };
                }
                
                if (passedChecks < 3) {
                    return { isValid: false, message: 'Password must be at least 8 characters with uppercase, lowercase, numbers, and symbols', strength: 1 };
                }
                
                if (passedChecks < 4) {
                    return { isValid: true, message: 'Fair password strength', strength: 2 };
                }
                
                if (passedChecks < 5) {
                    return { isValid: true, message: 'Good password strength', strength: 3 };
                }
                
                return { isValid: true, message: 'Strong password', strength: 4 };
            }

            updatePasswordStrength(password, strengthFill, strengthText) {
                if (!strengthFill || !strengthText) return;
                
                const validation = this.checkPasswordStrength(password);
                
                // Reset classes
                strengthFill.className = 'strength-fill';
                
                switch (validation.strength) {
                    case 1:
                        strengthFill.classList.add('strength-weak');
                        strengthText.textContent = 'Password strength: Weak';
                        break;
                    case 2:
                        strengthFill.classList.add('strength-fair');
                        strengthText.textContent = 'Password strength: Fair';
                        break;
                    case 3:
                        strengthFill.classList.add('strength-good');
                        strengthText.textContent = 'Password strength: Good';
                        break;
                    case 4:
                        strengthFill.classList.add('strength-strong');
                        strengthText.textContent = 'Password strength: Strong';
                        break;
                    default:
                        strengthText.textContent = 'Password strength: Not entered';
                }
            }

            validatePasswordConfirmation() {
                const passwordInput = document.getElementById('signup-password');
                const confirmPasswordInput = document.getElementById('signup-confirm-password');
                const errorElement = document.getElementById('signup-confirm-error');
                
                if (!passwordInput || !confirmPasswordInput || !errorElement) return false;
                
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                // Remove existing classes
                confirmPasswordInput.classList.remove('error', 'success');
                
                if (!confirmPassword) {
                    this.showFieldError(confirmPasswordInput, errorElement, 'Please confirm your password');
                    return false;
                }
                
                if (password !== confirmPassword) {
                    this.showFieldError(confirmPasswordInput, errorElement, 'Passwords do not match');
                    return false;
                }
                
                this.showFieldSuccess(confirmPasswordInput, errorElement, 'Passwords match');
                return true;
            }

            showFieldError(input, errorElement, message) {
                input.classList.add('error');
                input.classList.remove('success');
                if (errorElement) {
                    errorElement.innerHTML = `<i class="fas fa-exclamation-triangle" aria-hidden="true"></i> ${message}`;
                    errorElement.style.display = 'block';
                }
            }

            showFieldSuccess(input, errorElement, message) {
                input.classList.add('success');
                input.classList.remove('error');
                if (errorElement) {
                    errorElement.innerHTML = `<i class="fas fa-check-circle" aria-hidden="true"></i> ${message}`;
                    errorElement.style.display = 'block';
                }
            }

            updateAuthUI() {
                const authStatus = document.getElementById('auth-status');
                const authStatusText = document.getElementById('auth-status-text');
                const authAvatar = document.getElementById('auth-avatar');
                const authBtnText = document.getElementById('auth-btn-text');
                const profileBtnText = document.getElementById('profile-btn-text');
                
                if (!this.currentUser) {
                    // Guest state
                    if (authStatus) {
                        authStatus.className = 'auth-status guest';
                        authStatus.style.display = 'flex';
                    }
                    if (authStatusText) authStatusText.textContent = 'Guest Mode';
                    if (authAvatar) {
                        authAvatar.innerHTML = '<i class="fas fa-user" aria-hidden="true"></i>';
                    }
                    if (authBtnText) authBtnText.textContent = 'Sign In / Register';
                    if (profileBtnText) profileBtnText.textContent = 'Profile';
                } else if (this.currentUser.isAnonymous) {
                    // Anonymous state
                    if (authStatus) {
                        authStatus.className = 'auth-status guest';
                        authStatus.style.display = 'flex';
                    }
                    if (authStatusText) authStatusText.textContent = 'Anonymous';
                    if (authAvatar) {
                        authAvatar.innerHTML = '<i class="fas fa-user-secret" aria-hidden="true"></i>';
                    }
                    if (authBtnText) authBtnText.textContent = 'Sign In';
                    if (profileBtnText) profileBtnText.textContent = 'Profile';
                } else {
                    // Logged in state
                    if (authStatus) {
                        authStatus.className = 'auth-status logged-in';
                        authStatus.style.display = 'flex';
                    }
                    if (authStatusText) {
                        const displayName = this.currentUser.displayName || 'Explorer';
                        authStatusText.textContent = displayName;
                    }
                    if (authAvatar) {
                        if (this.currentUser.photoURL) {
                            authAvatar.innerHTML = `<img src="${this.escapeHtml(this.currentUser.photoURL)}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            authAvatar.innerHTML = '<i class="fas fa-user" aria-hidden="true"></i>';
                        }
                    }
                    if (authBtnText) authBtnText.textContent = 'Sign Out';
                    if (profileBtnText) profileBtnText.textContent = 'Profile';
                }
            }

            // ====================
            // SESSION MANAGEMENT
            // ====================

            initSessionManagement() {
                if (!this.currentUser || this.currentUser.isAnonymous) return;
                
                this.sessionWarningTimer = null;
                this.sessionCountdownTimer = null;
                
                // Show session warning 5 minutes before expiry
                const sessionWarningTime = 50 * 60 * 1000; // 50 minutes
                
                this.sessionWarningTimer = setTimeout(() => {
                    this.showSessionWarning();
                }, sessionWarningTime);
                
                // Refresh session token every hour
                this.sessionRefreshTimer = setInterval(() => {
                    this.refreshSession();
                }, 60 * 60 * 1000); // 1 hour
                
                console.log('Session management initialized');
            }

            stopSessionManagement() {
                if (this.sessionWarningTimer) {
                    clearTimeout(this.sessionWarningTimer);
                    this.sessionWarningTimer = null;
                }
                
                if (this.sessionCountdownTimer) {
                    clearInterval(this.sessionCountdownTimer);
                    this.sessionCountdownTimer = null;
                }
                
                if (this.sessionRefreshTimer) {
                    clearInterval(this.sessionRefreshTimer);
                    this.sessionRefreshTimer = null;
                }
                
                this.hideSessionWarning();
                console.log('Session management stopped');
            }

            async refreshSession() {
                if (!this.currentUser || this.currentUser.isAnonymous) return;
                
                try {
                    // Force token refresh
                    await this.currentUser.getIdToken(true);
                    console.log('Session refreshed successfully');
                    this.hideSessionWarning();
                } catch (error) {
                    console.error('Session refresh failed:', error);
                    // If refresh fails, user might need to re-authenticate
                    if (error.code === 'auth/id-token-expired') {
                        this.showToast('Your session has expired. Please sign in again.', 'warning');
                        await this.auth.signOut();
                    }
                }
            }

            showSessionWarning() {
                const sessionWarning = document.getElementById('session-warning');
                const countdownSpan = document.getElementById('session-countdown');
                
                if (sessionWarning) {
                    sessionWarning.style.display = 'block';
                }
                
                let countdown = 300; // 5 minutes
                
                if (countdownSpan) {
                    countdownSpan.textContent = Math.floor(countdown / 60);
                }
                
                this.sessionCountdownTimer = setInterval(() => {
                    countdown -= 1;
                    
                    if (countdown <= 0) {
                        this.hideSessionWarning();
                        this.showToast('Your session has expired. Please sign in again.', 'warning');
                        this.auth.signOut();
                        return;
                    }
                    
                    if (countdown <= 60) {
                        // Show warning style in final minute
                        if (sessionWarning) {
                            sessionWarning.classList.add('warning');
                        }
                    }
                    
                    if (countdownSpan) {
                        const minutes = Math.floor(countdown / 60);
                        const seconds = countdown % 60;
                        countdownSpan.textContent = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : seconds;
                    }
                }, 1000);
            }

            hideSessionWarning() {
                const sessionWarning = document.getElementById('session-warning');
                if (sessionWarning) {
                    sessionWarning.style.display = 'none';
                    sessionWarning.classList.remove('warning');
                }
                
                if (this.sessionCountdownTimer) {
                    clearInterval(this.sessionCountdownTimer);
                    this.sessionCountdownTimer = null;
                }
            }

            showPasswordResetModal() {
                const modal = document.getElementById('password-reset-modal');
                if (modal) {
                    modal.classList.add('active');
                    // Pre-fill email if user is logged in
                    const emailInput = document.getElementById('reset-email');
                    if (emailInput && this.currentUser && this.currentUser.email) {
                        emailInput.value = this.currentUser.email;
                    }
                    emailInput?.focus();
                }
            }

            hidePasswordResetModal() {
                const modal = document.getElementById('password-reset-modal');
                if (modal) {
                    modal.classList.remove('active');
                    const form = document.getElementById('password-reset-form');
                    if (form) form.reset();
                }
            }

            async handlePasswordReset(e) {
                e.preventDefault();

                const email = document.getElementById('reset-email').value.trim();

                if (!email) {
                    this.showToast('Please enter your email address', 'warning');
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Sending...';
                submitBtn.disabled = true;

                try {
                    await this.auth.sendPasswordResetEmail(email);
                    this.hidePasswordResetModal();
                    this.showToast('Password reset email sent! Check your inbox.', 'success');
                } catch (error) {
                    console.error('Password reset error:', error);
                    let message = 'Failed to send password reset email';
                    switch (error.code) {
                        case 'auth/user-not-found':
                            message = 'No account found with this email address';
                            break;
                        case 'auth/invalid-email':
                            message = 'Invalid email address';
                            break;
                        case 'auth/too-many-requests':
                            message = 'Too many requests. Please try again later.';
                            break;
                        default:
                            message = error.message;
                    }
                    this.showToast(message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }

            showEditProfile() {
                if (!this.currentUser) {
                    this.showToast('Please sign in first', 'warning');
                    return;
                }

                const modal = document.getElementById('edit-profile-modal');
                if (modal) {
                    // Load current user data
                    this.db.collection('users').doc(this.currentUser.uid).get()
                        .then(doc => {
                            const userData = doc.exists ? doc.data() : {};

                            document.getElementById('profile-display-name').value = userData.displayName || '';
                            document.getElementById('profile-bio').value = userData.bio || '';
                            document.getElementById('profile-photo-url').value = userData.photoURL || '';
                            document.getElementById('profile-links').value = (userData.links || []).join('\\n');
                            document.getElementById('profile-gallery').value = (userData.gallery || []).join('\\n');
                        })
                        .catch(error => {
                            console.error('Error loading profile data:', error);
                        });

                    modal.classList.add('active');
                    modal.setAttribute('aria-hidden', 'false');
                    setTimeout(() => {
                        document.getElementById('profile-display-name')?.focus();
                    }, 100);
                }
            }

            hideEditProfileModal() {
                const modal = document.getElementById('edit-profile-modal');
                if (modal) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                    const form = document.getElementById('edit-profile-form');
                    if (form) form.reset();
                }
            }

            hideUserLocationsModal() {
                const modal = document.getElementById('user-locations-modal');
                if (modal) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                }
            }

            async handleEditProfile(e) {
                e.preventDefault();

                if (!this.currentUser) {
                    this.showToast('Please sign in first', 'warning');
                    return;
                }

                const displayName = document.getElementById('profile-display-name').value.trim();
                const bio = document.getElementById('profile-bio').value.trim();
                const photoURL = document.getElementById('profile-photo-url').value.trim();
                const linksRaw = document.getElementById('profile-links').value || '';
                const galleryRaw = document.getElementById('profile-gallery').value || '';
                const links = linksRaw.split(/\n+/).map(l => this.sanitizeInput(l.trim())).filter(Boolean);
                const gallery = galleryRaw.split(/\n+/).map(l => this.sanitizeInput(l.trim())).filter(Boolean);

                const submitBtn = document.getElementById('profile-submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.disabled = true;

                try {
                    // Update user profile in Firestore
                    await this.db.collection('users').doc(this.currentUser.uid).set({
                        displayName: displayName || null,
                        bio: bio || null,
                        photoURL: photoURL || null,
                        links,
                        gallery,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    // Update Firebase auth profile if display name or photo changed
                    if (displayName || photoURL) {
                        await this.currentUser.updateProfile({
                            displayName: displayName || null,
                            photoURL: photoURL || null
                        });
                    }

                    this.hideEditProfileModal();
                    this.showToast('Profile updated successfully!', 'success');

                    // Reload profile to show changes
                    this.loadProfile();

                } catch (error) {
                    console.error('Error updating profile:', error);
                    this.showToast('Failed to update profile. Please try again.', 'error');
                } finally {
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    submitBtn.disabled = false;
                }
            }

            async resendVerificationEmail() {
                if (!this.currentUser) {
                    this.showToast('Please sign in first', 'warning');
                    return;
                }

                if (this.currentUser.emailVerified) {
                    this.showToast('Your email is already verified!', 'success');
                    return;
                }

                try {
                    await this.currentUser.sendEmailVerification();
                    this.showToast('Verification email sent! Check your inbox.', 'success');
                } catch (error) {
                    console.error('Email verification error:', error);
                    let message = 'Failed to send verification email';
                    switch (error.code) {
                        case 'auth/too-many-requests':
                            message = 'Too many requests. Please try again later.';
                            break;
                        default:
                            message = error.message;
                    }
                    this.showToast(message, 'error');
                }
            }

            updateAuthUI() {
                const btn = document.getElementById('auth-btn');
                const span = btn?.querySelector('span');
                const icon = btn?.querySelector('i');
                const profileBtn = document.getElementById('profile-btn');

                if (this.currentUser) {
                    if (span) span.textContent = 'Sign Out';
                    if (icon) icon.className = 'fas fa-sign-out-alt';
                    btn?.setAttribute('title', 'Sign out of your account');
                    if (profileBtn) profileBtn.style.display = '';
                } else {
                    if (span) span.textContent = 'Sign In / Register';
                    if (icon) icon.className = 'fas fa-user';
                    btn?.setAttribute('title', 'Sign in or create an account');
                    if (profileBtn) profileBtn.style.display = ''; // Always show profile button
                }

                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                if (this.currentUser) {
                    dot?.classList.remove('offline');
                    if (text) text.textContent = 'Connected';
                } else {
                    dot?.classList.add('offline');
                    if (text) text.textContent = 'Guest Mode';
                }

                // Update FAB visibility
                const fab = document.getElementById('add-location-fab');
                if (fab) {
                    fab.style.display = this.currentUser ? '' : 'none';
                }
            }

            async loadUserData() {
                if (!this.currentUser) return;

                try {
                    await this.db.collection('users').doc(this.currentUser.uid).set({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        online: true
                    }, { merge: true });
                } catch (error) {
                    console.error('Error updating user data:', error);
                }
            }

            handleProfileButtonClick() {
                if (!this.currentUser) {
                    this.handleAuth(); // Show auth modal if not authenticated
                } else {
                    this.showView('profile'); // Show profile view if authenticated
                }
            }

            timeAgo(date) {
                if (!date) return 'Unknown';
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${diffDays}d ago`;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            getRiskColor(riskLevel) {
                const colors = {
                    low: '#23d160',
                    moderate: '#ffdd57',
                    high: '#ff3860'
                };
                return colors[riskLevel] || '#7a7a9a';
            }

            // Enhanced profile photo upload with Firebase Storage
            async uploadProfilePhoto() {
                const fileInput = document.getElementById('profile-photo-upload');
                const uploadBtn = document.getElementById('upload-photo-btn');
                const progressDiv = document.getElementById('photo-progress');
                const progressBar = document.getElementById('photo-progress-bar');
                const progressText = document.getElementById('photo-progress-text');

                if (!fileInput.files || fileInput.files.length === 0) {
                    this.showToast('Please select a photo to upload', 'warning');
                    return;
                }

                const file = fileInput.files[0];

                // Validate file
                try {
                    this.validateImageFile(file);
                } catch (error) {
                    this.showToast(error.message, 'error');
                    return;
                }

                if (!this.currentUser) {
                    this.showToast('Please sign in to upload photos', 'warning');
                    return;
                }

                const opKey = 'photo-upload';
                if (this.activeOperations.has(opKey)) return;
                this.activeOperations.add(opKey);

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                progressDiv.style.display = 'block';

                try {
                    const storageRef = this.storage.ref();
                    const photoRef = storageRef.child(`profile-photos/${this.currentUser.uid}/${Date.now()}_${file.name}`);

                    const uploadTask = photoRef.put(file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                            progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error('Upload error:', error);
                            this.showToast('Failed to upload photo', 'error');
                        },
                        async () => {
                            try {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                                // Update user profile with new photo URL
                                await this.currentUser.updateProfile({
                                    photoURL: downloadURL
                                });

                                // Update Firestore user document
                                await this.db.collection('users').doc(this.currentUser.uid).update({
                                    photoURL: downloadURL,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });

                                document.getElementById('profile-photo-url').value = downloadURL;
                                this.showToast('Profile photo uploaded successfully!', 'success');

                                // Refresh profile if currently viewing
                                if (document.getElementById('profile-view').classList.contains('active')) {
                                    this.loadProfile();
                                }
                            } catch (error) {
                                console.error('Error updating profile:', error);
                                this.showToast('Photo uploaded but failed to update profile', 'error');
                            }
                        }
                    );
                } catch (error) {
                    console.error('Upload setup error:', error);
                    this.showToast('Failed to start upload', 'error');
                } finally {
                    this.activeOperations.delete(opKey);
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload';
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 2000);
                }
            }

            validateImageFile(file) {
                // Check file type
                const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('Please select a valid image file (JPG, PNG, WEBP, or GIF)');
                }

                // Check file size (5MB limit)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    throw new Error('File size must be less than 5MB');
                }

                // Check for malicious file names
                const suspiciousPatterns = [/[<>"'&]/, /\.\./, /\/\//];
                if (suspiciousPatterns.some(pattern => pattern.test(file.name))) {
                    throw new Error('Invalid file name');
                }

                return true;
            }

            // Enhanced profile view with statistics and achievements
            async loadProfile(userId = null) {
                const content = document.getElementById('profile-content');
                if (!content) return;

                // If no userId provided, show current user's profile
                const targetUserId = userId || this.currentUser?.uid;
                const isOwnProfile = targetUserId === this.currentUser?.uid;

                if (!targetUserId) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 80px 20px;">
                            <i class="fas fa-user-lock" style="font-size: 4rem; color: var(--text-muted); margin-bottom: 24px; display: block;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 16px;">Sign In Required</h3>
                            <p style="color: var(--text-muted); margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">
                                Create an account to build your urban exploration profile, track your locations, and connect with the community.
                            </p>
                            <button class="btn btn-primary" onclick="app.handleAuth()">
                                <i class="fas fa-sign-in-alt"></i> Sign In / Register
                            </button>
                        </div>
                    `;
                    return;
                }

                try {
                    content.innerHTML = '<div class="loading">Loading profile...</div>';

                    // Load user profile data and locations in parallel
                    const [userDoc, snapshot] = await Promise.all([
                        this.db.collection('users').doc(targetUserId).get(),
                        this.db.collection('locations')
                            .where('createdBy', '==', targetUserId)
                            .where('status', '==', 'active')
                            .get()
                    ]);

                    const userData = userDoc.exists ? userDoc.data() : {};

                    const locations = [];
                    snapshot.forEach(doc => {
                        locations.push({ id: doc.id, ...doc.data() });
                    });

                    const totalLocations = locations.length;
                    const username = userData.displayName || userData.email || 'Urban Explorer';
                    const userAvatar = userData.photoURL || null;
                    const userBio = userData.bio || '';
                    const joinedDate = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString() : 'Recently';
                    const bioHtml = userBio
                        ? `<p class="cz-text" style="margin: 0; color: var(--text-secondary);">${this.escapeHtml(userBio)}</p>`
                        : `<p class="cz-text" style="margin: 0; color: var(--text-muted); font-style: italic;">${isOwnProfile ? 'Add a short field note so others know your style.' : 'No bio shared yet.'}</p>`;

                    const highlights = locations.slice(0, 4);
                    const highlightHtml = highlights.length ? `
                        <div class="highlight-grid">
                            ${highlights.map(loc => {
                                const description = typeof loc.description === 'string' ? loc.description : '';
                                const trimmedDesc = this.escapeHtml(description.substring(0, 90));
                                const risk = loc.riskLevel || 'unknown';
                                const coords = loc.coordinates && Array.isArray(loc.coordinates)
                                    ? `<span class="cz-text" style="color: var(--text-muted); font-size: 0.8rem;"><i class="fas fa-location-arrow"></i> ${loc.coordinates[0].toFixed(4)}, ${loc.coordinates[1].toFixed(4)}</span>`
                                    : '';
                                return `
                                    <div class="profile-highlight">
                                        <div style="display: flex; justify-content: space-between; gap: 8px;">
                                            <h4 style="margin: 0; font-size: 1rem;">${this.escapeHtml(loc.name || 'Untitled')}</h4>
                                            <span class="risk risk-${risk}" style="text-transform: capitalize;">${risk}</span>
                                        </div>
                                        <div class="cz-text" style="color: var(--text-secondary); font-size: 0.9rem;">${trimmedDesc}${description.length > 90 ? '...' : ''}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div class="cz-text" style="color: var(--text-muted); font-size: 0.85rem;"><i class="fas fa-tag"></i> ${this.escapeHtml(loc.category || 'uncategorized')}</div>
                                            ${coords}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="profile-highlight" style="text-align: center; color: var(--text-muted);">
                            <i class="fas fa-map" style="font-size: 2rem; margin-bottom: 6px;"></i>
                            <div>${isOwnProfile ? 'No locations yet. Drop your first spot from the map.' : 'No locations to display yet.'}</div>
                        </div>
                    `;

                    const timelineHtml = locations.slice(0, 4).map(loc => {
                        const description = typeof loc.description === 'string' ? loc.description : '';
                        const timestamp = loc.createdAt?.toDate ? this.timeAgo(loc.createdAt.toDate()) : 'Recently';
                        return `
                            <li class="timeline-item">
                                <div class="timeline-dot" aria-hidden="true"></div>
                                <div>
                                    <div style="font-weight: 700;">${this.escapeHtml(loc.name || 'New location')}</div>
                                    <div class="cz-text" style="color: var(--text-secondary); font-size: 0.9rem;">${this.escapeHtml(description.substring(0, 80))}${description.length > 80 ? '...' : ''}</div>
                                    <div style="color: var(--text-muted); font-size: 0.8rem;"><i class="fas fa-clock"></i> ${timestamp}</div>
                                </div>
                            </li>
                        `;
                    }).join('') || `
                        <li class="timeline-item">
                            <div class="timeline-dot" aria-hidden="true"></div>
                            <div>
                                <div style="font-weight: 700;">${isOwnProfile ? 'Get your first ping in.' : 'No check-ins yet.'}</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">Activity updates appear after logging locations.</div>
                            </div>
                        </li>
                    `;

                    const linksList = Array.isArray(userData.links) ? userData.links.filter(Boolean) : [];
                    const linksHtml = linksList.length ? `
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${linksList.map(link => `
                                <a class="btn" style="width: fit-content;" href="${this.escapeHtml(link)}" target="_blank" rel="noopener">
                                    <i class="fas fa-external-link-alt" aria-hidden="true"></i> ${this.escapeHtml(link)}
                                </a>
                            `).join('')}
                        </div>
                    ` : `<div style="color: var(--text-muted);">No links shared.</div>`;

                    const galleryList = Array.isArray(userData.gallery) ? userData.gallery.filter(Boolean) : [];
                    const galleryHtml = galleryList.length ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                            ${galleryList.map(src => `
                                <div style="border: 2px solid var(--cz-black); background: var(--cz-concrete-dark); padding: 4px;">
                                    <img src="${this.escapeHtml(src)}" alt="Gallery item" style="width: 100%; height: 120px; object-fit: cover; display: block;">
                                </div>
                            `).join('')}
                        </div>
                    ` : `<div style="color: var(--text-muted);">No gallery images yet.</div>`;

                    content.innerHTML = `
                        <div class="profile-shell">
                            <section class="panel profile-hero" aria-label="Profile overview">
                                <div class="profile-avatar">
                                    ${userAvatar
                                        ? `<img src="${this.escapeHtml(userAvatar)}" alt="${this.escapeHtml(username)}" style="width: 100%; height: 100%; object-fit: cover;">`
                                        : `<span>${this.escapeHtml(username.charAt(0).toUpperCase())}</span>`
                                    }
                                </div>
                                <div class="profile-meta">
                                    <div class="chip live"><i class="fas fa-id-card" aria-hidden="true"></i> Explorer Dossier</div>
                                    <h2>${this.escapeHtml(username)}</h2>
                                    ${bioHtml}
                                    <div class="meta-chips" style="margin-top: 10px;">
                                        <span class="chip"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Joined ${joinedDate}</span>
                                        <span class="chip"><i class="fas fa-map-pin" aria-hidden="true"></i> ${totalLocations} locations</span>
                                        <span class="chip signal"><i class="fas fa-shield-alt" aria-hidden="true"></i> ${isOwnProfile ? 'Private controls on' : 'Public profile view'}</span>
                                    </div>
                                </div>
                                <div class="profile-actions">
                                    ${isOwnProfile ? `
                                        <button class="btn btn-primary" onclick="app.showEditProfile()"><i class="fas fa-edit" aria-hidden="true"></i> Edit Profile</button>
                                        <button class="btn" onclick="app.showAddLocationModal()"><i class="fas fa-plus" aria-hidden="true"></i> Add Location</button>
                                        <button class="btn" onclick="app.viewUserLocations('${targetUserId}')"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> View Locations</button>
                                    ` : `
                                        <button class="btn btn-primary" id="follow-btn-${targetUserId}" onclick="app.toggleFollow('${targetUserId}')"><i class="fas fa-user-plus" aria-hidden="true"></i> Follow</button>
                                        <button class="btn" onclick="app.messageUser('${targetUserId}')"><i class="fas fa-envelope" aria-hidden="true"></i> Message</button>
                                        <button class="btn" onclick="app.viewUserLocations('${targetUserId}')"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> Locations</button>
                                    `}
                                </div>
                            </section>

                            <section class="panel profile-stats" aria-label="Profile stats">
                                <div class="stat-grid">
                                    <div class="stat-card highlight">
                                        <div class="stat-label">Locations Logged</div>
                                        <div class="stat-value">${totalLocations}</div>
                                        <div class="stat-trend">Active contributions</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Followers</div>
                                        <div class="stat-value" id="profile-followers-count">--</div>
                                        <div class="stat-trend">Network reach</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Following</div>
                                        <div class="stat-value" id="profile-following-count">--</div>
                                        <div class="stat-trend">Explorers tracked</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Likes</div>
                                        <div class="stat-value" id="profile-likes-count">--</div>
                                        <div class="stat-trend">Appreciation on posts</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Visits</div>
                                        <div class="stat-value" id="profile-visits-count">--</div>
                                        <div class="stat-trend">Check-ins on your spots</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Badges</div>
                                        <div class="stat-value" id="profile-badges-count">--</div>
                                        <div class="stat-trend">Earned achievements</div>
                                    </div>
                                </div>
                            </section>

                            <div class="profile-grid">
                                <section class="panel profile-card" aria-label="Location highlights">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> Location Highlights</h3>
                                    ${highlightHtml}
                                    ${totalLocations > 4 ? `
                                        <div style="margin-top: 10px;">
                                            <button class="btn" type="button" onclick="app.showView('locations')">
                                                <i class="fas fa-th" aria-hidden="true"></i> View all ${totalLocations}
                                            </button>
                                        </div>
                                    ` : ''}
                                </section>

                                <section class="panel profile-card" aria-label="Activity timeline">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-stream" aria-hidden="true"></i> Activity Log</h3>
                                    <ul class="timeline">
                                        ${timelineHtml}
                                    </ul>
                                </section>
                            </div>

                            <div class="profile-grid">
                                <section class="panel profile-card" aria-label="Profile links">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-link" aria-hidden="true"></i> Links</h3>
                                    ${linksHtml}
                                </section>

                                <section class="panel profile-card" aria-label="Gallery">
                                    <h3 style="margin-bottom: 12px;"><i class="fas fa-images" aria-hidden="true"></i> Gallery</h3>
                                    ${galleryHtml}
                                </section>
                            </div>

                            <section class="panel profile-card" aria-label="Badges and achievements">
                                <h3 style="margin-bottom: 12px;"><i class="fas fa-award" aria-hidden="true"></i> Badges & Cred</h3>
                                <div id="user-badges" class="achievement-grid"></div>
                            </section>
                        </div>
                    `;

                    // Load and hydrate social stats/badges after rendering
                    this.loadUserSocialStats(targetUserId);
                } catch (error) {
                    console.error('Error loading profile:', error);
                    content.innerHTML = '<div class="error">FAILED TO LOAD INSPECTION REPORT</div>';
                }
            }

            // Load user social statistics
            async loadUserSocialStats(userId) {
                try {
                    // Load follower count
                    const followersSnapshot = await this.db.collection('user_followers')
                        .where('followingId', '==', userId)
                        .get();

                    // Load following count
                    const followingSnapshot = await this.db.collection('user_followers')
                        .where('followerId', '==', userId)
                        .get();

                    // Load likes received on user's locations
                    const userLocationsSnapshot = await this.db.collection('locations')
                        .where('createdBy', '==', userId)
                        .get();

                    const locationIds = userLocationsSnapshot.docs.map(doc => doc.id);
                    let likesCount = 0;

                    if (locationIds.length > 0) {
                        const likesSnapshot = await this.db.collection('location_likes')
                            .where('locationId', 'in', locationIds.slice(0, 10)) // Firestore limit
                            .get();
                        likesCount = likesSnapshot.size;
                    }

                    // Load visits to user's locations
                    let visitsCount = 0;
                    if (locationIds.length > 0) {
                        const visitsSnapshot = await this.db.collection('location_visits')
                            .where('locationId', 'in', locationIds.slice(0, 10))
                            .get();
                        visitsCount = visitsSnapshot.size;
                    }

                    // Load user badges
                    const badgesSnapshot = await this.db.collection('user_badges')
                        .where('userId', '==', userId)
                        .get();

                    // Update the stats in the profile
                    const followersElement = document.getElementById('profile-followers-count');
                    const followingElement = document.getElementById('profile-following-count');
                    const likesElement = document.getElementById('profile-likes-count');
                    const visitsElement = document.getElementById('profile-visits-count');
                    const badgesElement = document.getElementById('profile-badges-count');

                    if (followersElement) followersElement.textContent = followersSnapshot.size;
                    if (followingElement) followingElement.textContent = followingSnapshot.size;
                    if (likesElement) likesElement.textContent = likesCount;
                    if (visitsElement) visitsElement.textContent = visitsCount;
                    if (badgesElement) badgesElement.textContent = badgesSnapshot.size;

                    this.renderUserBadges(badgesSnapshot.docs.map(doc => doc.data()));

                } catch (error) {
                    console.error('Error loading user social stats:', error);
                }
            }

            renderUserBadges(badges) {
                const container = document.getElementById('user-badges');
                if (!container) return;

                if (badges.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 24px; color: var(--text-muted); grid-column: 1 / -1;">
                            <i class="fas fa-trophy" style="font-size: 2rem; margin-bottom: 8px; display: block; opacity: 0.5;"></i>
                            <p>No badges earned yet. Start exploring to unlock achievements!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = badges.map(badge => `
                    <div class="achievement-tag">
                        <div class="tag-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="tag-name">${this.getBadgeName(badge.badgeId)}</div>
                        <div class="tag-desc">${this.getBadgeDescription(badge.badgeId)}</div>
                    </div>
                `).join('');
            }

            getBadgeName(badgeId) {
                const badgeNames = {
                    'first_location': 'First Explorer',
                    'mapper_10': 'Mapper',
                    'mapper_50': 'Master Mapper',
                    'first_visit': 'First Check-in',
                    'explorer_10': 'Explorer',
                    'explorer_50': 'Master Explorer',
                    'social_butterfly': 'Social Butterfly',
                    'commentator_10': 'Commentator',
                    'appreciator': 'Appreciator',
                    'liker_25': 'Liked'
                };
                return badgeNames[badgeId] || 'Achievement';
            }

            getBadgeDescription(badgeId) {
                const badgeDescriptions = {
                    'first_location': 'Added your first location',
                    'mapper_10': 'Added 10 locations',
                    'mapper_50': 'Added 50 locations',
                    'first_visit': 'First location visit',
                    'explorer_10': 'Visited 10 locations',
                    'explorer_50': 'Visited 50 locations',
                    'social_butterfly': 'Made your first comment',
                    'commentator_10': 'Posted 10 comments',
                    'appreciator': 'First location like',
                    'liker_25': 'Received 25 likes'
                };
                return badgeDescriptions[badgeId] || 'Special achievement';
            }

            // User settings panel
            showSettings() {
                const content = document.getElementById('settings-content');
                if (!content) return;

                if (!this.currentUser) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 48px;">
                            <i class="fas fa-lock" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 16px;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 12px;">Sign In Required</h3>
                            <p style="color: var(--text-muted); margin-bottom: 20px;">Sign in to manage your account settings and preferences</p>
                            <button class="btn btn-primary" onclick="app.handleAuth()">
                                <i class="fas fa-sign-in-alt"></i> Sign In Now
                            </button>
                        </div>
                    `;
                    return;
                }

                content.innerHTML = `
                    <div class="panel">
                        <h3 style="margin-bottom: 16px;"><i class="fas fa-user-cog"></i> Account Settings</h3>

                        <div class="form-group">
                            <label class="form-label">Display Name</label>
                            <input class="input" type="text" id="settings-display-name" value="${this.escapeHtml(this.currentUser.displayName || '')}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input class="input" type="email" id="settings-email" value="${this.escapeHtml(this.currentUser.email || '')}" disabled>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Account Created</label>
                            <input class="input" type="text" value="${this.currentUser.metadata?.creationTime || 'Unknown'}" disabled>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="app.updateAccountSettings()">Save Changes</button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 16px;">
                        <h3 style="margin-bottom: 16px;"><i class="fas fa-bell"></i> Notification Settings</h3>

                        <div class="form-group">
                            <label class="form-label">Email Notifications</label>
                            <select class="select" id="settings-email-notifications">
                                <option value="all">All Activity</option>
                                <option value="important">Important Only</option>
                                <option value="none">Disabled</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Push Notifications</label>
                            <select class="select" id="settings-push-notifications">
                                <option value="enabled">Enabled</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notification Frequency</label>
                            <select class="select" id="settings-notification-frequency">
                                <option value="realtime">Real-time</option>
                                <option value="daily">Daily Digest</option>
                                <option value="weekly">Weekly Summary</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="app.updateNotificationSettings()">Save Notification Preferences</button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 16px;">
                        <h3 style="margin-bottom: 16px;"><i class="fas fa-lock"></i> Privacy Controls</h3>

                        <div class="form-group">
                            <label class="form-label">Profile Visibility</label>
                            <select class="select" id="settings-profile-visibility">
                                <option value="public">Public (Anyone can view)</option>
                                <option value="followers">Followers Only</option>
                                <option value="private">Private (Only me)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Location Visibility</label>
                            <select class="select" id="settings-location-visibility">
                                <option value="public">Public</option>
                                <option value="followers">Followers Only</option>
                                <option value="private">Private</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Activity Feed Visibility</label>
                            <select class="select" id="settings-activity-visibility">
                                <option value="public">Public</option>
                                <option value="followers">Followers Only</option>
                                <option value="private">Private</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="app.updatePrivacySettings()">Save Privacy Settings</button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 16px;">
                        <h3 style="margin-bottom: 16px;"><i class="fas fa-palette"></i> Display Preferences</h3>

                        <div class="form-group">
                            <label class="form-label">Theme</label>
                            <select class="select" id="settings-theme">
                                <option value="system">System Default</option>
                                <option value="light">Light Mode</option>
                                <option value="dark">Dark Mode</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Map Style</label>
                            <select class="select" id="settings-map-style">
                                <option value="default">Default</option>
                                <option value="satellite">Satellite</option>
                                <option value="terrain">Terrain</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="app.updateDisplaySettings()">Save Display Preferences</button>
                        </div>
                    </div>

                    <div class="panel" style="margin-top: 16px;">
                        <h3 style="margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i> Account Management</h3>

                        <div class="form-group">
                            <button class="btn" style="background: var(--cz-orange); color: white;" onclick="app.changePassword()">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>

                        <div class="form-group">
                            <button class="btn" style="background: var(--cz-red); color: white;" onclick="app.deleteAccount()">
                                <i class="fas fa-trash"></i> Delete Account
                            </button>
                        </div>

                        <div class="form-group">
                            <button class="btn" onclick="app.exportData()">
                                <i class="fas fa-download"></i> Export My Data
                            </button>
                        </div>
                    </div>
                `;

                // Load current settings
                this.loadUserSettings();
            }

            async loadUserSettings() {
                if (!this.currentUser) return;

                try {
                    const settingsDoc = await this.db.collection('user_settings').doc(this.currentUser.uid).get();
                    if (settingsDoc.exists) {
                        const settings = settingsDoc.data();
                        
                        // Load notification settings
                        if (settings.emailNotifications) {
                            document.getElementById('settings-email-notifications').value = settings.emailNotifications;
                        }
                        if (settings.pushNotifications) {
                            document.getElementById('settings-push-notifications').value = settings.pushNotifications;
                        }
                        if (settings.notificationFrequency) {
                            document.getElementById('settings-notification-frequency').value = settings.notificationFrequency;
                        }

                        // Load privacy settings
                        if (settings.profileVisibility) {
                            document.getElementById('settings-profile-visibility').value = settings.profileVisibility;
                        }
                        if (settings.locationVisibility) {
                            document.getElementById('settings-location-visibility').value = settings.locationVisibility;
                        }
                        if (settings.activityVisibility) {
                            document.getElementById('settings-activity-visibility').value = settings.activityVisibility;
                        }

                        // Load display settings
                        if (settings.theme) {
                            document.getElementById('settings-theme').value = settings.theme;
                        }
                        if (settings.mapStyle) {
                            document.getElementById('settings-map-style').value = settings.mapStyle;
                        }
                    }
                } catch (error) {
                    console.error('Error loading user settings:', error);
                }
            }

            async updateAccountSettings() {
                if (!this.currentUser) return;

                const displayName = document.getElementById('settings-display-name').value.trim();

                try {
                    await this.currentUser.updateProfile({
                        displayName: displayName
                    });

                    await this.db.collection('users').doc(this.currentUser.uid).update({
                        displayName: displayName,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    this.showToast('Account settings updated successfully!', 'success');
                    
                    // Refresh profile if currently viewing
                    if (document.getElementById('profile-view').classList.contains('active')) {
                        this.loadProfile();
                    }
                } catch (error) {
                    console.error('Error updating account settings:', error);
                    this.showToast('Failed to update account settings', 'error');
                }
            }

            async updateNotificationSettings() {
                if (!this.currentUser) return;

                const emailNotifications = document.getElementById('settings-email-notifications').value;
                const pushNotifications = document.getElementById('settings-push-notifications').value;
                const notificationFrequency = document.getElementById('settings-notification-frequency').value;

                try {
                    await this.db.collection('user_settings').doc(this.currentUser.uid).set({
                        emailNotifications,
                        pushNotifications,
                        notificationFrequency,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    this.showToast('Notification settings updated!', 'success');
                } catch (error) {
                    console.error('Error updating notification settings:', error);
                    this.showToast('Failed to update notification settings', 'error');
                }
            }

            async updatePrivacySettings() {
                if (!this.currentUser) return;

                const profileVisibility = document.getElementById('settings-profile-visibility').value;
                const locationVisibility = document.getElementById('settings-location-visibility').value;
                const activityVisibility = document.getElementById('settings-activity-visibility').value;

                try {
                    await this.db.collection('user_settings').doc(this.currentUser.uid).set({
                        profileVisibility,
                        locationVisibility,
                        activityVisibility,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    this.showToast('Privacy settings updated!', 'success');
                } catch (error) {
                    console.error('Error updating privacy settings:', error);
                    this.showToast('Failed to update privacy settings', 'error');
                }
            }

            async updateDisplaySettings() {
                if (!this.currentUser) return;

                const theme = document.getElementById('settings-theme').value;
                const mapStyle = document.getElementById('settings-map-style').value;

                try {
                    await this.db.collection('user_settings').doc(this.currentUser.uid).set({
                        theme,
                        mapStyle,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    // Apply theme immediately
                    if (theme === 'dark') {
                        document.body.classList.add('dark-mode');
                    } else if (theme === 'light') {
                        document.body.classList.remove('dark-mode');
                    } else {
                        // System default - use prefers-color-scheme
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        if (prefersDark) {
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                        }
                    }

                    this.showToast('Display settings updated!', 'success');
                } catch (error) {
                    console.error('Error updating display settings:', error);
                    this.showToast('Failed to update display settings', 'error');
                }
            }

            changePassword() {
                // Show password change modal or redirect to password change page
                this.showToast('Password change functionality would be implemented here', 'info');
            }

            deleteAccount() {
                if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                    // Implement account deletion logic
                    this.showToast('Account deletion functionality would be implemented here', 'info');
                }
            }

            exportData() {
                // Implement data export functionality
                this.showToast('Data export functionality would be implemented here', 'info');
            }
        }

        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new UrbindexApp();
        });
    </script>
</body>
</html>
