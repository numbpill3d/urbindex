<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            background: #f0f8ff;
            padding: 10px;
            border-left: 4px solid #007AFF;
            margin: 10px 0;
            font-family: monospace;
        }
        .error {
            background: #ffe6e6;
            border-left-color: #ff4444;
        }
        .success {
            background: #e6ffe6;
            border-left-color: #44ff44;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056CC;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Enhanced Geolocation Test</h1>
    
    <div class="test-section">
        <h2>1. Geolocation API Support Check</h2>
        <button onclick="testGeolocationSupport()">Test Geolocation Support</button>
        <div id="geo-support-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Get Current Location</h2>
        <button onclick="testGetLocation()">Get My Location</button>
        <div id="location-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Locale-Based Fallback</h2>
        <button onclick="testLocaleFallback()">Test Locale Fallback</button>
        <div id="locale-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. Session Storage Caching</h2>
        <button onclick="testSessionStorage()">Test Session Storage</button>
        <div id="storage-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. Complete Location Flow</h2>
        <button onclick="testCompleteFlow()">Test Complete Flow</button>
        <div id="complete-result" class="result"></div>
    </div>

    <script>
        // Test 1: Geolocation API Support
        function testGeolocationSupport() {
            const result = document.getElementById('geo-support-result');
            const isSupported = 'geolocation' in navigator;
            
            result.innerHTML = `
                <strong>Geolocation API:</strong> ${isSupported ? '‚úÖ Supported' : '‚ùå Not Supported'}<br>
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Language:</strong> ${navigator.language || navigator.userLanguage || 'Unknown'}
            `;
            result.className = `result ${isSupported ? 'success' : 'error'}`;
        }

        // Test 2: Get Current Location
        async function testGetLocation() {
            const result = document.getElementById('location-result');
            const button = event.target;
            
            button.disabled = true;
            result.innerHTML = 'Getting location...';
            result.className = 'result';
            
            if (!navigator.geolocation) {
                result.innerHTML = '‚ùå Geolocation not supported';
                result.className = 'result error';
                button.disabled = false;
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 300000
                    });
                });
                
                const { latitude, longitude, accuracy } = position.coords;
                result.innerHTML = `
                    ‚úÖ Location Retrieved!<br>
                    <strong>Latitude:</strong> ${latitude.toFixed(6)}<br>
                    <strong>Longitude:</strong> ${longitude.toFixed(6)}<br>
                    <strong>Accuracy:</strong> ¬±${Math.round(accuracy)}m<br>
                    <strong>Timestamp:</strong> ${new Date(position.timestamp).toLocaleString()}
                `;
                result.className = 'result success';
                
            } catch (error) {
                let message = 'Failed to get location';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Permission denied by user';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Location information unavailable';
                        break;
                    case error.TIMEOUT:
                        message = 'Location request timed out';
                        break;
                }
                
                result.innerHTML = `‚ùå ${message}<br><strong>Error:</strong> ${error.message}`;
                result.className = 'result error';
            } finally {
                button.disabled = false;
            }
        }

        // Test 3: Locale-Based Fallback
        function testLocaleFallback() {
            const result = document.getElementById('locale-result');
            
            try {
                const locale = navigator.language || navigator.userLanguage || 'en-US';
                
                // Same logic as in the main app
                const localeMap = {
                    'en-US': [39.8283, -98.5795], // US Center
                    'en-GB': [54.7023, -3.2766],  // UK Center
                    'en-CA': [56.1304, -106.3468], // Canada Center
                    'en-AU': [-25.2744, 133.7751], // Australia Center
                    'en-NZ': [-40.9006, 174.8860], // New Zealand Center
                    'en-IN': [20.5937, 78.9629],   // India Center
                    'en-ZA': [-30.5595, 22.9375],  // South Africa Center
                    'en': [0, 0] // Global center
                };
                
                const localeCode = locale.split('-').slice(0, 2).join('-');
                const coords = localeMap[localeCode] || localeMap[locale.split('-')[0]] || localeMap['en'];
                
                result.innerHTML = `
                    ‚úÖ Locale Fallback Working!<br>
                    <strong>Detected Locale:</strong> ${locale}<br>
                    <strong>Matched Code:</strong> ${localeCode}<br>
                    <strong>Fallback Coordinates:</strong> ${coords[0]}, ${coords[1]}
                `;
                result.className = 'result success';
                
            } catch (error) {
                result.innerHTML = `‚ùå Failed to get locale fallback<br><strong>Error:</strong> ${error.message}`;
                result.className = 'result error';
            }
        }

        // Test 4: Session Storage Caching
        function testSessionStorage() {
            const result = document.getElementById('storage-result');
            
            try {
                // Test storing location
                const testLocation = {
                    lat: 40.7128,
                    lng: -74.0060,
                    timestamp: Date.now()
                };
                
                sessionStorage.setItem('urbindex_user_location', JSON.stringify(testLocation));
                
                // Test retrieving location
                const retrieved = sessionStorage.getItem('urbindex_user_location');
                const parsed = JSON.parse(retrieved);
                
                // Test cache validation (5 minutes)
                const maxAge = 5 * 60 * 1000;
                const isValid = Date.now() - parsed.timestamp < maxAge;
                
                result.innerHTML = `
                    ‚úÖ Session Storage Working!<br>
                    <strong>Stored Location:</strong> ${testLocation.lat}, ${testLocation.lng}<br>
                    <strong>Cache Valid:</strong> ${isValid ? 'Yes' : 'No'}<br>
                    <strong>Age:</strong> ${Math.round((Date.now() - parsed.timestamp) / 1000)} seconds
                `;
                result.className = 'result success';
                
            } catch (error) {
                result.innerHTML = `‚ùå Session Storage Error<br><strong>Error:</strong> ${error.message}`;
                result.className = 'result error';
            }
        }

        // Test 5: Complete Location Flow
        async function testCompleteFlow() {
            const result = document.getElementById('complete-result');
            const button = event.target;
            
            button.disabled = true;
            result.innerHTML = 'Testing complete location flow...';
            result.className = 'result';
            
            const steps = [];
            
            try {
                // Step 1: Check cache
                const cached = sessionStorage.getItem('urbindex_user_location');
                if (cached) {
                    const data = JSON.parse(cached);
                    const maxAge = 5 * 60 * 1000;
                    if (Date.now() - data.timestamp < maxAge) {
                        steps.push(`‚úÖ Using cached location: ${data.lat}, ${data.lng}`);
                        result.innerHTML = steps.join('<br>');
                        result.className = 'result success';
                        return;
                    }
                }
                
                // Step 2: Check geolocation support
                if (!navigator.geolocation) {
                    steps.push('‚ùå Geolocation not supported');
                    throw new Error('Geolocation not available');
                }
                
                steps.push('‚úÖ Geolocation API available');
                
                // Step 3: Try to get location
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 300000
                    });
                });
                
                const { latitude, longitude } = position.coords;
                steps.push(`‚úÖ Location retrieved: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
                
                // Step 4: Cache the location
                const locationData = { lat: latitude, lng: longitude, timestamp: Date.now() };
                sessionStorage.setItem('urbindex_user_location', JSON.stringify(locationData));
                steps.push('‚úÖ Location cached for session');
                
                result.innerHTML = steps.join('<br>');
                result.className = 'result success';
                
            } catch (error) {
                steps.push(`‚ùå Failed: ${error.message}`);
                
                // Fallback to locale-based
                try {
                    const locale = navigator.language || 'en-US';
                    const localeMap = {
                        'en-US': [39.8283, -98.5795],
                        'en': [0, 0]
                    };
                    
                    const localeCode = locale.split('-').slice(0, 2).join('-');
                    const coords = localeMap[localeCode] || localeMap['en'];
                    
                    steps.push(`üìç Using locale fallback: ${coords[0]}, ${coords[1]}`);
                    result.innerHTML = steps.join('<br>');
                    result.className = 'result success';
                    
                } catch (fallbackError) {
                    steps.push(`‚ùå Fallback also failed: ${fallbackError.message}`);
                    result.innerHTML = steps.join('<br>');
                    result.className = 'result error';
                }
            } finally {
                button.disabled = false;
            }
        }
    </script>
</body>
</html>